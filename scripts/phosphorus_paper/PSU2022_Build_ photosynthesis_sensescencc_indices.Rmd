---
title: "Senescence and Photosynthesis Expression Indices"
author: "Maize Genetics Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: flatly
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

# Overview

**Purpose**: Construct expression indices for photosynthesis and senescence 
gene sets to proxy physiological trajectories across leaf developmental stages.

**Approach**:
- Aggregate expression of photosynthesis genes (GO terms)
- Aggregate expression of senescence-associated genes (SAGs, literature)
- Examine trajectories across leaf stages and P treatments

# Libraries
```{r libraries}
library(dplyr)
library(ggplot2)
library(ggpubr)
library(tidyr)
library(clusterProfiler)
```

# Data Loading
```{r load_data}
# Load differential expression results
effects_df <- read.csv("~/Desktop/DEG_effects.csv")

# Load curated labels from external file
curated <- read.csv("~/Desktop/selected_DEGs_curated_locus_label_2.csv") %>%
  select(gene, locus_label)

effects_df$locus_label[effects_df$locus_label == "A0A1D6NG77"] <- NA

# Coalesce curated locus_label into effects_df
effects_df <- effects_df %>%
  left_join(curated, by = "gene", suffix = c("", "_curated")) %>%
  mutate(locus_label = coalesce(locus_label_curated, locus_label)) %>%
  select(-locus_label_curated)

# Expression data
normalized_expression <- readRDS(
  "~/Desktop/normalized_expression_logCPM.rda"
)

# Gene universe
universe <- effects_df %>%
  filter(predictor == "Leaf") %>%
  pull(gene) %>%
  unique()

# GO annotations
TERM2GENE <- readRDS(
  "/Users/fvrodriguez/Desktop/GOMAP_maize_B73_NAM5/TERM2GENE_Fattel_2024_full.rds"
)

cat("Expression matrix:", dim(normalized_expression), "\n")
cat("Universe size:", length(universe), "genes\n")
```
# Marker Gene Trajectories
```{r marker_gene_trajectories, fig.width=12, fig.height=16}
# Define marker gene pairs (photosynthesis, senescence)
marker_genes <- data.frame(
  locus_label = c("pep1", "salt1", "ssu1", "mir3", 
                  "nye2", "sgrl1", "cab1", "dapat3"),
  gene_type = c("Photosynthesis", "Senescence", 
                "Photosynthesis", "Senescence",
                "Senescence", "Senescence", 
                "Photosynthesis", "Senescence"),
  pair = c("Pair1", "Pair1", "Pair2", "Pair2",
           "Pair3", "Pair3", "Pair4", "Pair4"),
  stringsAsFactors = FALSE
)

# Extract gene IDs for each locus
gene_ids <- effects_df %>%
  filter(locus_label %in% marker_genes$locus_label, !is.na(locus_label)) %>%
  select(gene, locus_label, desc_merged) %>%
  distinct() %>%
  group_by(locus_label) %>%
  slice(1) %>%
  ungroup()

# Extract expression data for all marker genes
marker_data <- lapply(seq_len(nrow(gene_ids)), function(i) {
  g <- gene_ids$gene[i]
  data.frame(
    sample = colnames(normalized_expression),
    expression = normalized_expression[g, ],
    gene = g
  )
}) %>%
  bind_rows() %>%
  left_join(gene_ids, by = "gene") %>%
  left_join(marker_genes, by = "locus_label") %>%
  mutate(
    leaf_stage = as.numeric(sub(".*L([0-9]+)[LR]$", "\\1", sample))
  )

# Calculate summary statistics (across all samples, no treatment split)
marker_summary <- marker_data %>%
  group_by(gene, locus_label, gene_type, desc_merged, pair, leaf_stage) %>%
  summarise(
    mean_expr = mean(expression),
    se_expr = sd(expression) / sqrt(n()),
    .groups = "drop"
  )

# Calculate maximum expression per pair for sorting
pair_max_expr <- marker_summary %>%
  group_by(pair) %>%
  summarise(max_expr = max(mean_expr), .groups = "drop") %>%
  arrange(desc(max_expr))

# Create facet labels with both genes in each pair
pair_labels <- marker_summary %>%
  select(pair, locus_label, desc_merged) %>%
  distinct() %>%
  group_by(pair) %>%
  summarise(
    facet_label = paste(
      paste0(locus_label, "\n", 
             stringr::str_wrap(desc_merged, width = 30)),
      collapse = "\n\n"
    ),
    .groups = "drop"
  ) %>%
  left_join(pair_max_expr, by = "pair") %>%
  arrange(desc(max_expr))

# Apply sorted factor levels
marker_summary <- marker_summary %>%
  left_join(
    pair_labels %>% select(pair, facet_label),
    by = "pair"
  ) %>%
  mutate(
    facet_label = factor(facet_label, levels = pair_labels$facet_label)
  )

# Create faceted plot
p_markers <- ggplot(
  marker_summary,
  aes(x = leaf_stage, y = mean_expr, color = gene_type, group = gene)
) +
  geom_line(linewidth = 1.5) +
  geom_point(size = 5) +
  geom_errorbar(
    aes(ymin = mean_expr - se_expr, ymax = mean_expr + se_expr),
    width = 0.2,
    linewidth = 0.8
  ) +
  scale_color_manual(
    values = c("Photosynthesis" = "darkgreen", "Senescence" = "orange")
  ) +
  facet_wrap(
    ~ facet_label,
    nrow = 2,
    scales = "free_y"
  ) +
  labs(
    x = "Leaf",
    y = expression(log[10] * "(CPM)"),
    color = NULL
  ) +
  theme_classic(base_size = 25) +
  theme(
    strip.background = element_blank(),
    strip.text = element_text(size = 12, face = "bold", hjust = 0),
    legend.position = "none"
  )

print(p_markers)

ggsave(
  "~/Desktop/marker_gene_trajectories.png",
  plot = p_markers,
  width = 8,
  height = 7.5,
  dpi=150
)
```


```{r photosynthesis_positive_controls}
# Extract cab1 expression
gene <- effects_df %>%
  filter(locus_label == "cab1", !is.na(locus_label)) %>%
  dplyr::slice(1) %>%
  pull("gene")

locus_data <- data.frame(
  sample = colnames(normalized_expression),
  expression = normalized_expression[gene, ]
) %>%
  mutate(
    leaf_stage = as.numeric(sub(".*L([0-9]+)[LR]$", "\\1", sample)),
    treatment = factor(substr(sample, 1, 2), levels = c("+P", "-P"))
  )

# Calculate summary statistics by treatment
locus_summary <- locus_data %>%
  group_by(treatment, leaf_stage) %>%
  summarise(
    mean_expr = mean(expression),
    se_expr = sd(expression) / sqrt(n()),
    .groups = "drop"
  )

# Create trajectory plot
ggplot(locus_summary, aes(x = leaf_stage, y = mean_expr, color = treatment)) +
  geom_line(linewidth = 1.5) +
  geom_point(size = 4) +
  geom_errorbar(
    aes(ymin = mean_expr - se_expr, ymax = mean_expr + se_expr),
    width = 0.2,
    linewidth = 1
  ) +
  scale_color_manual(values = c("+P" = "gold", "-P" = "purple4")) +
  labs(
    x = "Leaf",
    y = "Expression (log10 CPM)",
    title = expression(italic("cab1") ~ "(Zm00001eb161390)")
  ) +
  theme_classic(base_size = 20) +
  theme(legend.position = c(0.9, 0.9), legend.title = element_blank())
```

# Gene Set Definitions

## Version Crossreference
```{r load_xref}
v3_v5 <- read.table(
  file = "/Users/fvrodriguez/Desktop/B73_gene_xref/B73v3_to_B73v5.tsv",
  sep = "\t",
  header = FALSE
) %>%
  rename(v3 = "V1", v5 = "V2") %>%
  separate_longer_delim(cols = v5, delim = ",")

v4_v5 <- read.table(
  file = "/Users/fvrodriguez/Desktop/B73_gene_xref/B73v4_to_B73v5.tsv",
  sep = "\t",
  header = FALSE
) %>%
  rename(v4 = "V1", v5 = "V2") %>%
  separate_longer_delim(cols = v5, delim = ",")
```

## Senescence Gene Sets
```{r load_senescence_genes}
# SAG orthologs
sag_orthologs <- read.csv("~/Desktop/SAG_orthologs.csv") %>%
  janitor::clean_names() %>%
  inner_join(v3_v5, by = c(gene_id_maize = "v3"))

# Staygreen network
staygreen_network <- read.csv(
  "~/Desktop/staygreen_network_sekhon2019.csv", 
  na.strings = ""
) %>%
  janitor::clean_names() %>%
  inner_join(v4_v5, by = c(gene = "v4"))

# Natural senescence
natural_senescence <- read.csv("~/Desktop/natural_senescence.csv") %>%
  janitor::clean_names() %>%
  inner_join(v3_v5, by = c(gene_id = "v3"))

cat("SAG orthologs:", length(unique(sag_orthologs$v5)), "\n")
cat("Staygreen network:", length(unique(staygreen_network$v5)), "\n")
cat("Natural senescence:", length(unique(natural_senescence$v5)), "\n")
```

## Photosynthesis Gene Set
```{r define_photosynthesis}
photosynthesis_genes <- TERM2GENE %>%
  filter(GO %in% c(
    "GO:0015979", # photosynthesis
    "GO:0019684", # photosynthesis, light reaction
    "GO:0009768"  # photosynthesis, light harvesting
  )) %>%
  pull(gene) %>%
  unique()

leaf_senescence_genes <- TERM2GENE %>%
  filter(GO %in% c(
    "GO:0010150" # leaf senescence     |  
  )) %>%
  pull(gene) %>%
  unique()

cat("Photosynthesis genes:", length(photosynthesis_genes), "\n")
cat("Leaf senescence genes:", length(leaf_senescence_genes), "\n")
```

## Build Custom Annotation
```{r build_custom_annotation}
custom_annotation <- c(
  list(
    staygreen = staygreen_network$v5,
    sag = sag_orthologs$v5,
    photosynthesis = intersect(photosynthesis_genes, universe),
    leaf_senescence = intersect(leaf_senescence_genes, universe)
  ),
  natural_senescence %>%
    select(term = set, gene = v5) %>%
    distinct() %>%
    split(.$term) %>%
    lapply(function(x) x$gene)
)

cat("Custom annotation terms:", length(custom_annotation), "\n")
lapply(custom_annotation,length)
```

# Expression Index Calculation
```{r index_function}
#' Calculate Gene Set Expression Indices
#'
#' @param expression_matrix Matrix with genes as rows, samples as columns
#' @param gene_sets Named list of gene ID vectors
#' @param method Aggregation method: "sum", "mean", or "median"
#' @return Data frame with sample-level indices
calculate_gene_set_indices <- function(expression_matrix,
                                       gene_sets,
                                       method = "sum") {
  indices <- lapply(names(gene_sets), function(set_name) {
    genes_in_set <- gene_sets[[set_name]]
    genes_available <- intersect(genes_in_set, rownames(expression_matrix))
    
    if (length(genes_available) == 0) {
      warning(paste("No genes from", set_name, "found in expression matrix"))
      return(rep(NA, ncol(expression_matrix)))
    }
    
    set_expression <- expression_matrix[genes_available, , drop = FALSE]
    
    index <- switch(method,
      "sum" = colSums(set_expression, na.rm = TRUE),
      "mean" = colMeans(set_expression, na.rm = TRUE),
      "median" = apply(set_expression, 2, median, na.rm = TRUE),
      stop("method must be 'sum', 'mean', or 'median'")
    )
    
    cat(sprintf(
      "%s: %d/%d genes found\n",
      set_name, length(genes_available), length(genes_in_set)
    ))
    
    index
  })
  
  indices_df <- as.data.frame(indices)
  names(indices_df) <- names(gene_sets)
  indices_df$sample <- colnames(expression_matrix)
  
  indices_df %>% select(sample, everything())
}
```

```{r calculate_indices}
gene_set_list <- list(
  photosynthesis = custom_annotation$photosynthesis,
  senescence = custom_annotation$leaf_senescence
)

indices <- calculate_gene_set_indices(
  expression_matrix = normalized_expression,
  gene_sets = gene_set_list,
  method = "mean"
) %>%
  mutate(
    leaf_stage = as.numeric(sub(".*L([0-9]+)[LR]$", "\\1", sample)),
    treatment = factor(substr(sample, 1, 2), levels = c("+P", "-P"))
  )

head(indices)
```

# Spaghetti Plot Data Preparation
```{r prepare_spaghetti_data}
# Prepare expression data for photosynthesis genes - centered per gene
xp_photo_genes <- intersect(
  custom_annotation$photosynthesis,
  rownames(normalized_expression)
)
xp_photosynthesis <- normalized_expression[xp_photo_genes, ] %>%
  as.data.frame() %>%
  tibble::rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "sample", values_to = "expression") %>%
  mutate(
    leaf_stage = as.numeric(sub(".*L([0-9]+)[LR]$", "\\1", sample))
  ) %>%
  group_by(gene) %>%
  mutate(centered_expr = expression - mean(expression)) %>%
  ungroup() %>%
  group_by(gene, leaf_stage) %>%
  summarise(mean_expr = mean(centered_expr), .groups = "drop") %>%
  arrange(gene) %>%
  mutate(gene_set = "Photosynthesis")

# Prepare expression data for senescence genes - centered per gene
xp_senescence_genes <- intersect(
  custom_annotation$leaf_senescence,
  rownames(normalized_expression)
)
xp_senescence <- normalized_expression[xp_senescence_genes, ] %>%
  as.data.frame() %>%
  tibble::rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "sample", values_to = "expression") %>%
  mutate(
    leaf_stage = as.numeric(sub(".*L([0-9]+)[LR]$", "\\1", sample))
  ) %>%
  group_by(gene) %>%
  mutate(centered_expr = expression - mean(expression)) %>%
  ungroup() %>%
  group_by(gene, leaf_stage) %>%
  summarise(mean_expr = mean(centered_expr), .groups = "drop") %>%
  arrange(gene) %>%
  mutate(gene_set = "Senescence")

cat("Photosynthesis genes:", length(xp_photo_genes), "\n")
cat("Senescence genes:", length(xp_senescence_genes), "\n")
```

# Linear Models
```{r linear_models}

cat("=== Photosynthesis Index ===\n")
lm(photosynthesis ~ treatment * leaf_stage, data = indices) %>%
  summary() %>%
  print()

cat("\n=== Senescence Index ===\n")
lm(senescence ~ treatment * leaf_stage, data = indices) %>%
  summary() %>%
  print()
```

# Visualizations


## Bivariate Relationship
```{r plot_bivariate, fig.width=8, fig.height=6}
indices %>%
  ggplot(aes(
    x = photosynthesis,
    y = senescence,
    fill = factor(leaf_stage),
    shape = factor(treatment)
  )) +
  geom_point(size = 3, color = "black") +
  scale_fill_viridis_d() +
  scale_shape_manual(values = c(21, 25)) +
   guides(fill = guide_legend(override.aes = list(shape = 21)))
  labs(
    x = "Photosynthesis Index",
    y = "Senescence Index",
    fill = "Leaf",
    shape = "Treatment"
  ) +
  theme_classic(base_size = 14)
```


## Individual Indices
```{r plot_individual, fig.width=10, fig.height=5}
p1 <- indices %>%
  ggplot(aes(
    y = photosynthesis,
    x = leaf_stage,
    fill = factor(leaf_stage),
    shape = treatment
  )) +
  geom_point(size = 3, color = "black") +
  scale_shape_manual(values = c(21, 25)) +
  scale_fill_viridis_d() +
  labs(
    x = "Leaf",
    y = "Photosynthesis Index",
    fill = "Leaf",
    shape = "Treatment"
  ) +
  theme_classic(base_size = 14)

p2 <- indices %>%
  ggplot(aes(
    y = senescence,
    x = leaf_stage,
    fill = factor(leaf_stage),
    shape = treatment
  )) +
  geom_point(size = 3, color = "black") +
  scale_shape_manual(values = c(21, 25)) +
  scale_fill_viridis_d() +
  labs(
    x = "Leaf",
    y = "Senescence Index",
    fill = "Leaf",
    shape = "Treatment"
  ) +
  theme_classic(base_size = 14)

ggarrange(p1, p2, ncol = 2, common.legend = TRUE, legend = "right")
```


## Spaghetti Plot and Gene Set Index Trajectories and 
```{r plot_normalized_panel, fig.width=14, fig.height=6}

# Normalize indices
indices_normalized <- indices %>%
  mutate(
    photosynthesis = (photosynthesis - min(photosynthesis)) /
      (max(photosynthesis) - min(photosynthesis)),
    senescence = (senescence - min(senescence)) /
      (max(senescence) - min(senescence))
  )

cat("=== Photosynthesis Index (Normalized) ===\n")
lm_photo <- lm(photosynthesis ~ leaf_stage, data = indices_normalized)
summary(lm_photo) %>% print()

cat("\n=== Senescence Index (Normalized) ===\n")
lm_sen <- lm(senescence ~ leaf_stage, data = indices_normalized)
summary(lm_sen) %>% print()

# Extract regression statistics
photo_stats <- summary(lm_photo)
sen_stats <- summary(lm_sen)

photo_r2 <- photo_stats$r.squared
photo_p <- coef(photo_stats)["leaf_stage", "Pr(>|t|)"]

sen_r2 <- sen_stats$r.squared
sen_p <- coef(sen_stats)["leaf_stage", "Pr(>|t|)"]

# Format p-values
format_pval <- function(p) {
  if (p < 0.001) return("p < 0.001")
  if (p < 0.01) return(sprintf("p = %.3f", p))
  return(sprintf("p = %.2f", p))
}

# Create annotation text
stats_text <- sprintf(
  "R² = %.3f\n %s\n\n\nR² = %.3f\n %s",
  photo_r2, format_pval(photo_p),
  sen_r2, format_pval(sen_p)
)

# Summary statistics for normalized indices
indices_summary <- indices_normalized %>%
  group_by(leaf_stage) %>%
  summarise(
    photo_mean = mean(photosynthesis),
    photo_se = sd(photosynthesis) / sqrt(n()),
    senescence_mean = mean(senescence),
    senescence_se = sd(senescence) / sqrt(n()),
    .groups = "drop"
  ) %>%
  pivot_longer(
    cols = c(photo_mean, senescence_mean),
    names_to = "index_type",
    values_to = "mean"
  ) %>%
  mutate(
    se = ifelse(index_type == "photo_mean", photo_se, senescence_se),
    index_type = factor(
      index_type,
      levels = c("photo_mean", "senescence_mean"),
      labels = c("Photosynthesis", "Leaf\nSenescence")
    )
  )

# Normalized trajectories plot
base_size <- 25
base_family <- "Helvetica"

p_normalized <- ggplot(
  indices_summary,
  aes(x = leaf_stage, y = mean, color = index_type)
) +
  geom_line(linewidth = 1.5) +
  geom_point(size = 4) +
  geom_errorbar(
    aes(ymin = mean - se, ymax = mean + se),
    width = 0.2,
    linewidth = 1
  ) +
  scale_color_manual(
    values = c("Photosynthesis" = "darkgreen", "Leaf\nSenescence" = "orange"),
  ) +
  annotate(
    "text",
    x = 1.0,
    y = 0.45,
    label = stats_text,
    hjust = 0,
    vjust = 0,
    size = 4
  ) +
  labs(
    x = "Leaf",
    y = "Normalized Expression Index",
    color = NULL
  ) +  
  ggpubr::theme_classic2(base_size = base_size) +
  theme(
    base_family = base_family,
    legend.position = c(0.6, 0.9),
    legend.text = element_text(size = 20),
    legend.background = element_rect(fill = "transparent"),
    legend.key = element_blank(),
    plot.margin = margin(5.5, 5.5, 5.5, 7, "pt")
  )

# Spaghetti overlay plot
p_spaghetti <- ggplot() +
  geom_line(
    data = xp_photosynthesis,
    aes(x = leaf_stage, y = mean_expr, group = gene),
    alpha = 0.1,
    linewidth = 0.5,
    color = "darkgreen"
  ) +
  geom_line(
    data = xp_senescence,
    aes(x = leaf_stage, y = mean_expr, group = gene),
    alpha = 0.1,
    linewidth = 0.5,
    color = "orange"
  ) +
  geom_smooth(
    data = photo_data,
    aes(x = leaf_stage, y = mean_expr, group = 1),
    method = "lm",
    se = FALSE,
    linewidth = 2,
    color = "darkgreen"
  ) +
  geom_smooth(
    data = sag_data,
    aes(x = leaf_stage, y = mean_expr, group = 1),
    method = "lm",
    se = FALSE,
    linewidth = 2,
    color = "orange"
  ) +
  labs(
    x = "Leaf",
    y = expression("Centered " * log[10] * "(CPM)")
  ) +
  coord_cartesian(ylim = c(-1, 1)) +
  scale_y_continuous(position = "right") +
  ggpubr::theme_classic2(base_size = base_size) +
  theme(
    base_family = base_family,
    axis.title.y.right = element_text(margin = margin(l = -5)),
    plot.margin = margin(5.5, 7, 5.5, 5.5, "pt")
  )

# Combine panels: normalized on left, spaghetti on right
p_panel <- ggarrange(p_normalized, p_spaghetti, ncol = 2)
print(p_panel)

ggsave(
  "~/Desktop/expression_indices_panel.png",
  plot = p_panel,
  width = 8,
  height = 6,
  dpi = 150
)
```

# Custom Gene Set enrichment
```{r,gene_set_enrichment}
#' Fisher's Exact Test for Custom Gene Set Enrichment
#'
#' @param deg_lists Named list of DEG vectors by cluster
#' @param annotation Named list of gene sets
#' @param universe Background gene set
#' @return Data frame with enrichment results
test_custom_enrichment <- function(deg_lists, annotation, universe) {
  annotation_filtered <- lapply(annotation, function(x) intersect(x, universe))
  annotation_filtered <- annotation_filtered[
    sapply(annotation_filtered, length) > 0
  ]
  
  results <- list()
  
  for (cluster_name in names(deg_lists)) {
    deg_genes <- deg_lists[[cluster_name]]
    
    for (term_name in names(annotation_filtered)) {
      term_genes <- annotation_filtered[[term_name]]
      overlap <- intersect(deg_genes, term_genes)
      
      in_both <- length(overlap)
      in_deg_only <- length(setdiff(deg_genes, term_genes))
      in_term_only <- length(setdiff(term_genes, deg_genes))
      in_neither <- length(universe) - in_both - in_deg_only - in_term_only
      
      contingency <- matrix(
        c(in_both, in_deg_only, in_term_only, in_neither),
        nrow = 2
      )
      fisher_result <- fisher.test(contingency, alternative = "greater")
      
      results[[length(results) + 1]] <- data.frame(
        Cluster = cluster_name,
        ID = term_name,
        Description = term_name,
        GeneRatio = paste0(in_both, "/", length(deg_genes)),
        BgRatio = paste0(length(term_genes), "/", length(universe)),
        pvalue = fisher_result$p.value,
        geneID = paste(overlap, collapse = "/"),
        Count = in_both,
        stringsAsFactors = FALSE
      )
    }
  }
  
  results_df <- do.call(rbind, results)
  results_df$p.adjust <- p.adjust(results_df$pvalue, method = "BH")
  
  results_df %>% arrange(p.adjust)
}
```
```{r run_custom_enrichment}
# Prepare DEG lists
DEGs <- with(effects_df %>% filter(is_hiconf_DEG), {
  list(
    Leaf.Down = unique(gene[
      predictor == "Leaf" & regulation == "Downregulated"
    ]),
    Leaf.Up = unique(gene[predictor == "Leaf" & regulation == "Upregulated"]),
    `-P.Down` = unique(gene[
      predictor == "-P" & regulation == "Downregulated"
    ]),
    `-P.Up` = unique(gene[predictor == "-P" & regulation == "Upregulated"])
  )
})

custom_enrichment_results <- test_custom_enrichment(
  DEGs,
  custom_annotation,
  universe
) %>%
  filter(p.adjust < 0.05)

custom_enrichment_results %>%
  select(-geneID) %>%
  print()
```

# Gene-Level Statistics
```{r gene_level_stats}
#' Extract DEG Stats for Custom Annotation
#'
#' @param annotation_id Term ID to filter
#' @param gene_term_df Data frame with gene-term mappings
#' @param effects_data DEG results
#' @param filter_hiconf Filter to high-confidence DEGs
#' @return Tibble with DEG statistics
get_annotation_degs <- function(annotation_id,
                                gene_term_df,
                                effects_data,
                                filter_hiconf = TRUE) {
  genes_in_category <- gene_term_df %>%
    filter(ID == annotation_id) %>%
    pull(gene)
  
  result <- effects_data %>%
    filter(gene %in% genes_in_category)
  
  if (filter_hiconf) {
    result <- result %>% filter(is_hiconf_DEG)
  }
  
  result %>%
    select(
      predictor:gene, locus_label, desc_merged,
      logFC, neglogP, mahalanobis
    ) %>%
    group_by(predictor, regulation) %>%
    arrange(predictor, regulation, -mahalanobis) %>%
    tibble()
}

# Extract genes from enriched terms
genes_in_custom_terms <- custom_enrichment_results %>%
  separate_longer_delim(geneID, delim = "/") %>%
  rename(gene = "geneID") %>%
  select(Cluster, ID, Description, gene) %>%
  inner_join(
    effects_df %>% select(gene, locus_label, desc_merged) %>% distinct(),
    by = "gene"
  )

# Example: Natural senescence genes
get_annotation_degs(
  annotation_id = "natural",
  gene_term_df = genes_in_custom_terms,
  effects_data = effects_df,
  filter_hiconf = TRUE
) %>%
  filter(predictor == "Leaf") %>%
  print(n = 50)
```

# Export
```{r export, eval=FALSE}
write.csv(
  indices,
  file = "~/Desktop/expression_indices.csv",
  row.names = FALSE
)
write.csv(
  custom_enrichment_results,
  file = "~/Desktop/custom_enrichment_results.csv",
  row.names = FALSE
)
```

# Session Info
```{r session_info}
sessionInfo()
```