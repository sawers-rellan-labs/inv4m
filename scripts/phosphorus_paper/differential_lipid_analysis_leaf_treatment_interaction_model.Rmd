---
title: "Lipid Differential abundance Analysis"
author: "Maize Genetics Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: flatly
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = here::here("docs", "phosphorus_paper"),
      envir = globalenv()
    )
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 12,
  fig.height = 8
)

# Load project paths
source(here::here("scripts/utils/setup_paths.R"))
paths <- setup_project_paths("phosphorus_paper")
```

# Overview

This analysis performs differential abundance analysis on lipid profiles from 
maize leaf samples across multiple experimental factors:

- **Leaf tissue position**: Continuous gradient from apical to basal (leaf 1-4)
- **Phosphorus treatment**: High P (+P) vs Low P (-P)
- **Genotype**: Control (CTRL) vs Inversion 4m (INV4M)

The analysis uses limma-voom to identify lipids that respond to:

1. **Leaf**: Leaf tissue position effect
2. **-P**: Phosphorus deficiency effect
3. **Inv4m**: Genotype effect
4. **-P:Inv4m**: Interaction between P treatment and genotype

Fold change thresholds:

- Leaf effect: ±0.7 log2FC
- Other effects: ±2 log2FC

# Libraries

```{r libraries}
library(edgeR)
library(ggplot2)
library(limma)
library(dplyr)
library(tidyr)
library(forcats)
library(ggrepel)
library(cowplot)
library(ggpubr)
library(ggtext)
```

# Data Loading and Preprocessing

## Define Internal Standards to Exclude

```{r define_exclusions}

# Internal standards and odd-chain lipids to exclude
internal_standards <- c( 
  "CUDA",
  "LPE_17_1",
  "Sphingosine_17_1",
  "PC_25_0",
  "DG_18_1",
  "PG_34_0",
  "DG_12_0",
  "TG_17_0",
  "LPC_17_0",
  "PE_34",
  "Cholesterol"
)

# exclude the odd carbon lipid
odd_carbon <- c( "PG_17_0", "SM_35_1","TG_57_6")

to_exclude <- c(internal_standards,odd_carbon)

```

## Load Raw Lipid Data

```{r load_lipid_data}
# Load MS-Dial raw data with new internal standard integration
lipid_csv <- file.path(paths$data, "PSU_RawData_MSDial_NewStdInt_240422.csv")

raw <- read.csv(lipid_csv, na.strings = c("", "#N/A", "NA", "Inf"))

# Remove internal standards and quality control samples
to_exclude <- to_exclude[to_exclude %in% colnames(raw)]

raw <- raw %>%
  dplyr::select(-all_of(to_exclude)) %>%
  filter(!grepl("Methanol", sampleID)) %>%
  filter(!grepl("Pool", sampleID))

cat("Loaded", nrow(raw), "samples\n")
```

## Load Sample Metadata

```{r load_metadata}
# Load plant phenotypic data
plant_csv <- file.path(paths$data, "22_NCS_PSU_LANGEBIO_FIELDS_PSU_P_field.csv")

psu <- read.csv(plant_csv) %>%
  dplyr::rename(Genotype = "Who.What", rowid = "P22.") %>%
  filter(Genotype %in% c("CTRL", "INV4M")) %>%
  droplevels()


# Load RNA-seq metadata
sampleInfo <- read.csv(file.path(paths$data, 'inv4mRNAseq_metadata.csv')) %>%
  dplyr::rename(Genotype = genotype) %>%
  dplyr::rename(rowid = row)

# Merge metadata
sampleInfo <- psu %>%
  dplyr::select(rowid, Rep, Plot_Row, Plot_Column, DTA, DTS) %>%
  inner_join(sampleInfo) %>%
  filter(!is.na(DTA))

# Create leaf position groups
sampleInfo$leaf_group <- NA
sampleInfo$leaf_group[sampleInfo$leaf_tissue < 3] <- "apical"
sampleInfo$leaf_group[sampleInfo$leaf_tissue > 2] <- "basal"

# Standardize sample IDs
sampleInfo$tube <- gsub("L|R", "S", sampleInfo$tube, perl = TRUE)
sampleInfo$rowid <- sampleInfo$row

# mass spectrometry injection order
ms_order<- read.csv(file.path(paths$data, "PSU-PHO22_ms_order.csv"))
ms_order$tube <- gsub("L|R","S",ms_order$top_tag, perl =TRUE)
 sampleInfo$row
 
sampleInfo <- sampleInfo%>%
  dplyr::right_join(ms_order) %>% distinct()

cat("Sample info loaded for", nrow(sampleInfo), "samples\n")
```

## Merge Lipid Data with Metadata

```{r merge_data}
# Extract tube ID from raw data
raw$tube <- gsub(".*_|.raw", "", raw$sampleID, perl = TRUE)
raw$tube <- gsub("L|R", "S", raw$tube, perl = TRUE)

# Merge phenotypic data with lipid measurements
pheno <- sampleInfo %>%
  dplyr::select(rowid, tube, Rep, Plot:Plot_Row, Treatment:leaf_tissue, leaf_group) %>%
  inner_join(
    raw %>%
      dplyr::select(tube, DGDG_34_0:TG_58_5)
  ) %>%
  mutate(block = as.factor(Rep)) %>%
  droplevels() %>%
  pivot_wider(
    names_from = Rep,
    values_from = Rep,
    names_prefix = "block_",
    values_fn = function(x) 1,
    values_fill = 0
  ) %>%
  dplyr::select(rowid, tube:Plot_Row, block, block_6:block_12, everything()) %>%
  mutate(Treatment = factor(Treatment, levels = c("High_P", "Low_P")))




# Simplify treatment labels
levels(pheno$Treatment) <- c("+P", "-P")

# Remove problematic sample
pheno <- pheno[-29, ]  # mislabelled for lipids?

cat("Final dataset:", nrow(pheno), "samples\n")
```

## Define Lipid Classifications

```{r lipid_classes}
# Extract lipid measurements matrix
m <- pheno %>%
  dplyr::select(DGDG_34_0:TG_58_5) %>%
  as.matrix()

# Define lipid head groups
head_group <- c(
  DG = "neutral",
  DGDG = "glycolipid",
  DGGA = "glycolipid",
  LPC = "phospholipid",
  LPE = "phospholipid",
  MGDG = "glycolipid",
  PC = "phospholipid",
  PE = "phospholipid",
  PG = "phospholipid",
  PI = "phospholipid",
  SQDG = "glycolipid",
  TG = "neutral"
)

# Create lipid species annotation
sp <- data.frame(
  colname = colnames(m),
  class = gsub("_.*", "", colnames(m), perl = TRUE)
)

sp$head_group <- head_group[sp$class]

# Summary of lipid classes
cat("\nLipid class distribution:\n")
print(with(sp, table(head_group, class)))
```


# Quality Control

## Create DGEList Object

Critical step: The counts matrix comes from `pheno`, but we need to ensure the 
sample metadata in the DGEList matches the processed `pheno` data, especially 
for Treatment levels which were renamed from "High_P"/"Low_P" to "+P"/"-P".

```{r create_dgelist}
# Prepare count matrix
counts <- pheno[, colnames(m)] %>%
  as.matrix() %>%
  t()

# Visualize data distribution
hist(counts, main = "Distribution of Lipid Abundances", xlab = "Abundance")

# Set column names to match sample IDs
colnames(counts) <- pheno$tube

cat("\nCount matrix dimensions:", dim(counts), "\n")
cat("Lipids:", nrow(counts), "\n")
cat("Samples:", ncol(counts), "\n")
```


## Match Sample Metadata to Counts

```{r match_metadata}
# Extract sample names from counts matrix
sampleNames <- pheno$tube

# Verify all sample names are present
cat("\nAll samples in counts?", all(sampleNames %in% sampleInfo$tube), "\n")

# Match sampleInfo to the order of samples in counts matrix
sampleInfo_matched <- sampleInfo[match(sampleNames, sampleInfo$tube), ]

# CRIionAL: Update Treatment levels to match pheno
# The pheno object has Treatment renamed to "+P"/"-P"
sampleInfo_matched$Treatment <- factor(
  pheno$Treatment[match(sampleInfo_matched$tube, pheno$tube)],
  levels = c("+P", "-P")
)

cat("\nTreatment levels after update:\n")
print(levels(sampleInfo_matched$Treatment))
print(table(sampleInfo_matched$Treatment))
```

```{r, bacth_correction for visualization}
# Create corrected matrix for plotting

sampleInfo$leaf_tissue_c <- scale(sampleInfo$leaf_tissue, center = TRUE, scale = FALSE)

filtered_sample_idx <- which(colnames(counts) %in% sampleInfo$tube)

filtered_covariates <- sampleInfo[
  filtered_sample_idx,
c("Plot_Row","injection_order")]

filtered_metadata <- sampleInfo[filtered_sample_idx,]
# 
# corrected_matrix <- removeBatchEffect(
#   counts,
#   covariates = filtered_covariates,
#   design = model.matrix(
#     ~ leaf_tissue_c * Treatment + Genotype * Treatment + 
#       leaf_tissue_c * Genotype,
#     data = filtered_metadata
#   )
# )
# 
# corrected_matrix <-  corrected_matrix - min( corrected_matrix)


# Use corrected_matrix for:
# - PCA plots
# - Heatmaps  
# - Boxplots of individual metabolites
# - Any visualization where drift would obscure biology

# But use original metabolite_matrix with full design for statistics
# design_full <- model.matrix(
#   ~ Plot_Row + injection_order + 
#     leaf_tissue_c * Treatment + Genotype * Treatment + 
#     leaf_tissue_c * Genotype,
#   data = metadata
# )
# 
# fit <- lmFit(metabolite_matrix, design_full)
# fit <- eBayes(fit)
```

## Create DGEList with Matched Metadata

```{r create_dgelist_final}
# Create gene annotation
genes <- data.frame(gene = rownames(counts))

# Create DGEList with matched sample information
y <- DGEList(counts = counts, samples = sampleInfo_matched )

# Create sample groups from Treatment and Genotype
y$group <- interaction(y$samples$Treatment, y$samples$Genotype)

cat("\nDGEList created successfully\n")
cat("Groups:", levels(y$group), "\n")
cat("\nLibrary size summary:\n")
print(summary(y$samples$lib.size))

cat("\nLow count samples:\n")
print(table(y$samples$lowCount))
```

```{r filter_abundance}
# Keep lipids with sufficient abundance
# Calculate Total Ion Current fractions ~ molar fractions

ion_fraction <- sweep(y$counts, 2, colSums(y$counts), FUN = "/")
hist(log10(ion_fraction))

keep <- (rowMeans(ion_fraction==0)) < 0.20
sum(!keep)
y_filtered <- y[keep, ]

{
  cat("\nabundance filtering:\n")
  cat("  Genes before:", nrow(y), "\n")
  cat("  Genes after:", nrow(y_filtered), "\n")
  cat("  Genes removed:", sum(!keep), "\n")
}
```




## Prepare Data Frame for ggplot MDS Visualizations

CRIionAL: We need to use the ORIGINAL y_filtered object for the metadata 
to ensure all samples are included in the MDS visualization, but use the 
coordinates from the MDS computed on all samples.


```{r prepare_mds_data}

y_filtered$samples$lowCount <- y_filtered$samples$lib.size < 3e10

# Remove low quality samples
y_filtered_bySample <- y_filtered[, !y_filtered$samples$lowCount]

{
  cat("\nLow quality libraries:\n")
  table(y_filtered$samples$lowCount)
  cat("\nSamples after filtering:\n")
  cat("  Retained:", ncol(y_filtered_bySample), "\n")
  cat("  Removed:", sum(y_filtered$samples$lowCount), "\n")
}

# Extract sample metadata from filtered object
d <- y_filtered_bySample$samples

# Ensure factors are properly set
d$Treatment <- factor(d$Treatment, levels = c("+P", "-P"))
d$Rep <- factor(d$Rep)
```

## Lipid Class distribution

```{r}
# Lipid Class Composition Analysis
# =================================

## Calculate class-level abundances from normalized data

# Extract normalized counts (ion fraction scaled)
norm_counts <- ion_fraction * 1e9

# Create metadata for normalized samples
norm_metadata <- d %>%
  dplyr::filter(tube %in% colnames(norm_counts))

# Transpose normalized counts and merge with lipid annotations
lipid_abundance <- norm_counts %>%
  t() %>%
  as.data.frame() %>%
  dplyr::mutate(tube = rownames(.)) %>%
  tidyr::pivot_longer(
    cols = -tube,
    names_to = "response",
    values_to = "abundance"
  ) %>%
  dplyr::inner_join(sp, by = c("response" = "colname")) %>%
  dplyr::inner_join(norm_metadata, by = "tube")

## Create color palette with variations within each head group

# Define base colors for each head group
base_colors <- c(
  glycolipid = "darkblue",
  phospholipid = "darkred",
  neutral = "darkorange"
)

# Function to generate color variations (lighter/darker shades)
generate_color_variations <- function(base_color, n) {
  if (n == 1) return(base_color)
  
  # Use colorRampPalette to create gradient from lighter to darker
  colorRampPalette(c(
    colorspace::lighten(base_color, 0.4),
    base_color,
    colorspace::darken(base_color, 0.3)
  ))(n)
}

# Get classes by head group from sp annotation
classes_by_headgroup <- sp %>%
  dplyr::select(class, head_group) %>%
  dplyr::distinct() %>%
  dplyr::arrange(head_group, class)

# Order classes by head group for consistent display
class_order <- classes_by_headgroup %>%
  dplyr::pull(class)

# Generate colors for each head group
class_colors <- c()
for (hg in names(base_colors)) {
  # Get classes in this head group
  hg_classes <- classes_by_headgroup %>%
    dplyr::filter(head_group == hg) %>%
    dplyr::pull(class)
  
  # Generate color variations
  if (length(hg_classes) > 0) {
    hg_colors <- generate_color_variations(base_colors[hg], length(hg_classes))
    names(hg_colors) <- hg_classes
    class_colors <- c(class_colors, hg_colors)
  }
}

# Reorder to match class_order
class_colors <- class_colors[class_order]

cat("\nGenerated", length(class_colors), "color variations\n")
cat("Colors by head group:\n")
print(table(classes_by_headgroup$head_group))

# Define custom green to orange palette for leaf positions
green_to_orange <- c(
  "#00954A",  # Spanish Green (Leaf 1)
  "#A4DF56",  # Inchworm (Leaf 2)
  "#D7E23C",  # Pear (Leaf 3)
  "#FF9A1F"   # Crayola's Bright Yellow/Orange (Leaf 4)
)

## Plot 1: Mean composition by Leaf position - grouped bars by leaf within each class

leaf_composition <- lipid_abundance %>%
  dplyr::group_by(tube, Treatment, leaf_tissue, class) %>%
  dplyr::summarise(class_sum = sum(abundance), .groups = "drop") %>%
  dplyr::group_by(tube, Treatment, leaf_tissue) %>%
  dplyr::mutate(class_pct = 100 * class_sum / sum(class_sum)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(Treatment, leaf_tissue, class) %>%
  dplyr::summarise(
    mean_pct = mean(class_pct),
    se_pct = sd(class_pct) / sqrt(n()),
    .groups = "drop"
  )

leaf_composition$class <- factor(leaf_composition$class, levels = class_order)

# Create leaf position factor
leaf_composition <- leaf_composition %>%
  dplyr::mutate(
    leaf_position = factor(
      leaf_tissue,
      levels = c(1, 2, 3, 4),
      labels = c("1", "2", "3", "4")
    )
  )

# Add head group for faceting
leaf_composition <- leaf_composition %>%
  dplyr::inner_join(
    sp %>% dplyr::select(class, head_group) %>% dplyr::distinct(),
    by = "class"
  )

# Plot with lipid classes on x-axis, grouped by leaf position, log Y-scale
plot1_composition <- leaf_composition %>%
  ggplot(aes(x = class, y = mean_pct, fill = leaf_position)) +
  geom_col(color = "black", linewidth = 0.2, position = position_dodge(width = 0.9)) +
  geom_errorbar(
    aes(ymin = mean_pct - se_pct, ymax = mean_pct + se_pct),
    position = position_dodge(width = 0.9),
    width = 0.25,
    linewidth = 0.5
  ) +
  scale_fill_manual(
    name = "Leaf",
    values = green_to_orange
  ) +
  scale_y_log10(
    breaks = c(0.05, 0.1, 0.2, 0.5, 1, 2, 5, 10, 20, 40),
    labels = c("0.05", "0.1", "0.2", "0.5", "1", "2", "5", "10", "20", "40")
  ) +
  labs(
    y = "Ion %"
  ) +
  facet_grid(rows = vars(Treatment), cols = vars(head_group), 
             scales = "free_x", space = "free_x") +
  theme_classic2(base_size = 14) +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 13, face = "bold"),
    strip.background = element_blank(),
    strip.text.x = element_text(angle = 0, size = 25, face = "bold"),
    strip.text.y = element_text(angle = 0, size = 25, face = "bold"),
    legend.position = "none"
  )

## Plot 2: Treatment effect (-P vs +P) by leaf stage

# Calculate mean and SE per Treatment-Leaf-Class
class_abundance_summary <- lipid_abundance %>%
  dplyr::group_by(tube, Treatment, leaf_tissue, class) %>%
  dplyr::summarise(class_sum = sum(abundance), .groups = "drop") %>%
  dplyr::group_by(Treatment, leaf_tissue, class) %>%
  dplyr::summarise(
    mean_abundance = mean(class_sum),
    se_abundance = sd(class_sum) / sqrt(n()),
    n_samples = n(),
    .groups = "drop"
  )

# Pivot to get +P and -P side by side
treatment_comparison <- class_abundance_summary %>%
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = c(mean_abundance, se_abundance, n_samples)
  ) %>%
  dplyr::mutate(
    # Calculate log2 fold change: log2(-P / +P)
    log2fc = log2(`mean_abundance_-P` / `mean_abundance_+P`),
    
    # Propagate error using delta method
    # For log2(Y/X): SE ≈ 1/ln(2) × sqrt((SE_Y/Y)^2 + (SE_X/X)^2)
    se_log2fc = (1/log(2)) * sqrt(
      (`se_abundance_-P` / `mean_abundance_-P`)^2 + 
      (`se_abundance_+P` / `mean_abundance_+P`)^2
    )
  ) %>%
  dplyr::mutate(
    leaf_position = factor(
      leaf_tissue,
      levels = c(1, 2, 3, 4),
      labels = c("1", "2", "3", "4")
    )
  )

treatment_comparison$class <- factor(
  treatment_comparison$class, 
  levels = class_order
)

# Add head group
treatment_comparison <- treatment_comparison %>%
  dplyr::inner_join(
    sp %>% dplyr::select(class, head_group) %>% dplyr::distinct(),
    by = "class"
  )

# Plot treatment effect
plot2_treatment_effect <- treatment_comparison %>%
  ggplot(aes(x = class, y = log2fc, fill = leaf_position)) +
  geom_col(color = "black", linewidth = 0.2, position = position_dodge(width = 0.9)) +
  geom_errorbar(
    aes(ymin = log2fc - se_log2fc, ymax = log2fc + se_log2fc),
    position = position_dodge(width = 0.9),
    width = 0.25,
    linewidth = 0.5
  ) +
  scale_fill_manual(
    name = "Leaf",
    values = green_to_orange
  ) +
  labs(
    y = expression(log[2]~"FC (-P / +P)")
  ) +
  facet_grid(cols = vars(head_group), scales = "free_x", space = "free_x") +
  theme_classic2(base_size = 14) +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 13, face = "bold"),
    strip.background = element_blank(),
    strip.text.x = element_blank(),
  )


## Plot 3: Relative change with paired fold changes per plant

# Get sample-level abundances with plant ID
class_abundance_samples <- lipid_abundance %>%
  dplyr::group_by(tube, NCSU_RNA_plant, Treatment, leaf_tissue, class) %>%
  dplyr::summarise(class_sum = sum(abundance), .groups = "drop")

# Pivot wide to get all leaves per plant
class_abundance_wide <- class_abundance_samples %>%
  dplyr::select(-tube) %>%
  tidyr::pivot_wider(
    names_from = leaf_tissue,
    values_from = class_sum,
    names_prefix = "leaf_"
  )

# Fill missing values with treatment-class mean for that leaf
class_abundance_filled <- class_abundance_wide %>%
  dplyr::group_by(Treatment, class) %>%
  dplyr::mutate(
    leaf_1 = ifelse(is.na(leaf_1), mean(leaf_1, na.rm = TRUE), leaf_1),
    leaf_2 = ifelse(is.na(leaf_2), mean(leaf_2, na.rm = TRUE), leaf_2),
    leaf_3 = ifelse(is.na(leaf_3), mean(leaf_3, na.rm = TRUE), leaf_3),
    leaf_4 = ifelse(is.na(leaf_4), mean(leaf_4, na.rm = TRUE), leaf_4)
  ) %>%
  dplyr::ungroup()

# Calculate log2 fold change per plant (keeping leaf 1 = 0 for symmetry)
class_relative_per_plant <- class_abundance_filled %>%
  dplyr::mutate(
    leaf1_log2fc = 0,
    leaf2_log2fc = log2(leaf_2 / leaf_1),
    leaf3_log2fc = log2(leaf_3 / leaf_1),
    leaf4_log2fc = log2(leaf_4 / leaf_1)
  ) %>%
  dplyr::select(NCSU_RNA_plant, Treatment, class, 
                leaf1_log2fc, leaf2_log2fc, leaf3_log2fc, leaf4_log2fc) %>%
  tidyr::pivot_longer(
    cols = starts_with("leaf"),
    names_to = "leaf_position",
    values_to = "log2fc"
  )

# Calculate mean and SE
class_leaf_ratio_treatment <- class_relative_per_plant %>%
  dplyr::group_by(Treatment, leaf_position, class) %>%
  dplyr::summarise(
    mean_log2fc = mean(log2fc, na.rm = TRUE),
    se_log2fc = sd(log2fc, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  dplyr::mutate(
    leaf_position = factor(
      leaf_position,
      levels = c("leaf1_log2fc", "leaf2_log2fc", "leaf3_log2fc", "leaf4_log2fc"),
      labels = c("1", "2", "3", "4")
    )
  )

class_leaf_ratio_treatment$class <- factor(
  class_leaf_ratio_treatment$class, 
  levels = class_order
)

# Add head group
class_leaf_ratio_treatment <- class_leaf_ratio_treatment %>%
  dplyr::inner_join(
    sp %>% dplyr::select(class, head_group) %>% dplyr::distinct(),
    by = "class"
  )

# Plot with log2FC
plot3_leaf_relative <- class_leaf_ratio_treatment %>%
  ggplot(aes(x = class, y = mean_log2fc, fill = leaf_position)) +
  geom_col(color = "black", linewidth = 0.2, position = position_dodge(width = 0.9)) +
  geom_errorbar(
    aes(ymin = mean_log2fc - se_log2fc, ymax = mean_log2fc + se_log2fc),
    position = position_dodge(width = 0.9),
    width = 0.25,
    linewidth = 0.5
  ) +
  scale_fill_manual(
    name = "Leaf",
    values = green_to_orange
  ) +
  labs(
    y = expression(log[2]~"FC vs Leaf 1")
  ) +
  facet_grid(rows = vars(Treatment), cols = vars(head_group), 
             scales = "free_x", space = "free_x") +
  theme_classic2(base_size = 14) +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 13, face = "bold"),
    strip.background = element_blank(),
    strip.text.x = element_blank(),
    strip.text.y = element_text(angle = 0, size = 25, face = "bold"),
    legend.position = "none"
  )


# Combine all three plots
final_combined <- plot_grid(
  plot1_composition,
  plot2_treatment_effect,
  plot3_leaf_relative,
  ncol = 1,
  labels = c("A", "B", "C"),
  label_size = 25,
  rel_heights = c(1, 0.5, 1),
  align = "v",
  axis = "lr"
)

# Save combined plot
ggsave(
  file.path(paths$figures, "lipid_composition_combined_final.svg"),
  final_combined,
  width = 10,
  height = 10,
  dpi = 150
)
cat("\nFinal combined plot created and saved\n")

print(final_combined)
```

## Initial MDS
```{r, mds_qc_all_samples}
# MDS with all samples (before library size filtering)
mds_all <- plotMDS(y_filtered, pch = 21, labels=y$samples$tube,plot = TRUE)

# Histogram of library sizes
hist(
  y$samples$lib.size / 1e6,
  main = "Library Size Distribution",
  xlab = "Library Size (millions of reads)",
  breaks = 20
)

{
cat("\nLibrary size summary:\n")
print(summary(y_filtered$samples$lib.size))
cat("\nSamples with lib.size < 20 million:", 
    sum(y_filtered$samples$lib.size < 2e7), "\n")
}

```

## MDS Colored by MS Injection Order
```{r mds_colored_by_coverage, fig.width=10, fig.height=8}

mds_qc_data <- y_filtered$samples %>%
  mutate(
    dim1 = mds_all$x,
    dim2 = mds_all$y,
    lib_size = lib.size / 1e10
  )

# Plot MDS colored by MS injection order

ggplot( mds_qc_data, aes(x = dim1, y = dim2, color =injection_order )) +
  geom_point(size = 3) +
  scale_color_viridis_c(option = "plasma") +
  labs(
    x = paste0("Dim1 (", round(100 * mds_all$var.explained[1]), "%)"),
    y = paste0("Dim2 (", round(100 * mds_all$var.explained[2]), "%)"),
    color = "Injection Order"
  ) +
  theme_classic2(base_size = 15)

```


## Compute MDS Dimensions

MDS reveals sources of variation in gene abundance across samples. Dimensions 3 
and 4 are extracted from eigenvectors scaled by square root of variance explained.

```{r mds_calculation}
mds <- plotMDS(
  y,
  pch = 21,
  label = y$samples$side_tag,
  plot = FALSE
)

# Store MDS coordinates in sample data
d <- y_filtered$samples
d$dim1 <- mds$x
d$dim2 <- mds$y
d$dim3 <- mds$eigen.vectors[, 3] * sqrt(mds$var.explained[3])
d$dim4 <- mds$eigen.vectors[, 4] * sqrt(mds$var.explained[4])

# Prepare factors for plotting
d$Treatment <- factor(d$Treatment)
d$Genotype <- factor(d$Genotype)

# Variance explained by each dimension
tibble(
  dimension = paste("Dim", 1:4),
  var_explained = round(mds$var.explained[1:4], 4)
)
```

## MDS: Dimensions 1 and 2 Colored by Multiple Factors

Exploring which experimental factors drive the main dimensions of variation.

```{r mds_multiple_factors, fig.width=14, fig.height=10}
# Treatment
p1 <- ggplot(d, aes(x = dim2, y = dim3, color = Treatment)) +
  geom_point(size = 3) +
  theme_classic2(base_size = 15) +
  ggtitle("Treatment")

# Row position
p2 <- ggplot(d, aes(x = dim2, y = dim3, color = injection_order, shape = Treatment)) +
  geom_point(size = 3) +
  theme_classic2(base_size = 15) +
  ggtitle("Injection order")

# Collection time
p3 <- ggplot(d, aes(x = dim2, y = dim3, color = decimal_time)) +
  geom_point(size = 3) +
  theme_classic2(base_size = 15) +
  ggtitle("Collection Time")

# Collector
p4 <- ggplot(d, aes(x = dim2, y = dim3, color = COLLECTOR)) +
  geom_point(size = 3) +
  theme_classic2(base_size = 15) +
  ggtitle("Collector")

# Genotype
p5 <- ggplot(d, aes(x = dim2, y = dim3, color = Genotype)) +
  geom_point(size = 3) +
  theme_classic2(base_size = 15) +
  ggtitle("Genotype")

# Leaf tissue
p6 <- d %>%
  mutate(leaf = factor(leaf_tissue)) %>%
  ggplot(aes(x = dim2, y = dim3, color = leaf)) +
  geom_point(size = 3) +
  theme_classic2(base_size = 15) +
  ggtitle("Leaf Tissue")

ggarrange(p1, p2, p3, p4, p5, p6, ncol = 3, nrow = 2)
```

## MDS: Primary Plot (Leaf Tissue and Treatment)

```{r mds_primary, fig.width=10, fig.height=8}
lipid_MDS_23 <- d %>%
  mutate(leaf = factor(leaf_tissue)) %>%
  ggplot(aes(x = dim2, y = dim3)) +
  ggtitle("Lipid MDS") +
  xlab(paste0("dim2 (", round(100 * mds$var.explained[2]), "%)")) +
  ylab(paste0("dim3 (", round(100 * mds$var.explained[3]), "%)")) +
  geom_point(aes(fill = leaf, shape = Treatment), size = 4) +
  scale_fill_manual(values= green_to_orange) +
  scale_shape_manual(values = c(21, 25)) +
  guides(
    shape = guide_legend( title = element_blank(), 
                          override.aes = list(fill= "black")),
    fill = guide_legend(
      title = "Leaf",
      order = 2,
      override.aes = list(geom = "point", shape = 22, size = 7, reverse = TRUE)
    )
  ) +
  theme_classic2(base_size = 30) +
  theme(
    axis.text.x = element_blank(),  
    axis.ticks.x = element_blank(), # Remove x-axis ticks
    axis.text.y = element_blank(),  # Remove y-axis labels
    axis.ticks.y = element_blank(),  # Remove y-axis ticks
    legend.spacing = unit(0, "line"),
    legend.box.spacing = unit(0, "in"),
    legend.background = element_rect(fill = "transparent")
    #legend.position = c(0.2, 0.17)
  )

# Save growth curve plots
saveRDS(lipid_MDS_23 , file.path(paths$intermediate, "lipid_MDS_23.rds"))
cat("MDS plots saved to output/\n")

lipid_MDS_23
```


## MDS: Dimensions 3 and 4

The third dimension separates by genotype.

```{r mds_dim3_dim4, fig.width=10, fig.height=8}
# Set up genotype labels with italic formatting
labels <- c("CTRL", "*Inv4m*")
names(labels) <- c("CTRL", "INV4")

d %>%
  mutate(leaf = factor(leaf_tissue)) %>%
  ggplot(aes(x = dim3, y = dim4, fill = leaf, shape = Treatment)) +
  xlab(paste0("dim3 (", round(100 * mds$var.explained[3]), "%)")) +
  ylab(paste0("dim4 (", round(100 * mds$var.explained[4]), "%)")) +
  geom_point(size = 4) +
  scale_fill_manual(values= green_to_orange) +
  scale_shape_manual(values = c(21, 25)) +
  guides(
    shape = guide_legend( title = element_blank(), 
                          override.aes = list(fill= "black")),
    fill = guide_legend(
      title = "Leaf",
      order = 2,
      override.aes = list(geom = "point", shape = 22, size = 7, reverse = TRUE)
    )
  ) +
  theme_classic2(base_size = 25) +
  theme(
    legend.box = "horizontal",
    legend.position = c(0.9, 0.8),
    legend.text = element_markdown(),
    legend.spacing = unit(0, "line"),
    legend.box.spacing = unit(0, "line")
  )
```

## MDS Dimension Correlations

```{r mds_correlations}
# Calculate correlations and p-values
mds_cor_results <- tibble(
  dimension = c("Dim2", "Dim3", "Dim4"),
  factor = c("Treatment", "Leaf tissue","Leaf tissue"),
  correlation = c(
    cor(d$dim2, as.numeric(d$Treatment)),
    cor(d$dim3, as.numeric(d$leaf_tissue)),
    cor(d$dim4, as.numeric(d$leaf_tissue))
  ),
  p_value = c(
    cor.test(d$dim2, as.numeric(d$Treatment))$p.value,
    cor.test(d$dim3, d$leaf_tissue)$p.value,
     cor.test(d$dim4, d$leaf_tissue)$p.value
  )
) %>%
  mutate(
    adj_p_value = p.adjust(p_value, method = "fdr"),
    correlation = round(correlation, 3),
    p_value = signif(p_value, 3),
    adj_p_value = signif(adj_p_value, 3)
  )

mds_cor_results
```

# Differential abundance Analysis

## Final Data Preparation for Model

CRIionAL: Before creating the design matrix, ensure Treatment levels are 
correctly set to match the original factor levels for proper interpretation.

```{r prepare_for_model}
# --- Verify experimental design variables ---

# Check that Plot_Column is present in the metadata
cat("\nPlot_Column present?", "Plot_Column" %in% colnames(d), "\n")
cat("Plot_Column values:\n")
print(table(d$Plot_Column))

# Check that Plot_Row is present in the metadata
cat("\nPlot_Row present?", "Plot_Row" %in% colnames(d), "\n")
cat("Plot_Row values:\n")
print(table(d$Plot_Row))

# --- Prepare treatment variable for model fitting ---

# Re-establish the factor levels for Treatment so that "+P" (control) is the baseline.
# This ensures the model interprets Treatment effects as "-P" relative to "+P".
d$Treatment <- factor(d$Treatment, levels = c("+P", "-P"))

# --- Center the continuous leaf age variable ---

# Convert leaf_tissue (leaf age or developmental stage) to a centered numeric covariate.
# Centering subtracts the mean leaf age so that:
#   - the intercept represents abundance at the *average leaf age*,
#   - the Treatment coefficient corresponds to the treatment effect at mean leaf age,
#   - and collinearity between leaf age and Treatment is minimized.


# --- Verify treatment structure after recoding ---
cat("\nTreatment levels for model:\n")
print(levels(d$Treatment))
print(table(d$Treatment))

```

## Design Matrix and Normalization

```{r design_normalization}

# Extract sample names from counts matrix
sampleNames <- y_filtered_bySample$samples$tube

# Verify all sample names are present
cat("\nAll samples in counts?", all(sampleNames %in% sampleInfo$tube), "\n")

# Match sampleInfo to the order of samples in counts matrix
sampleInfo_matched <- sampleInfo[match(sampleNames, sampleInfo$tube), ]
sampleInfo_matched
# CRIionAL: Update Treatment levels to match pheno
# The pheno object has Treatment renamed to "+P"/"-P"
sampleInfo_matched$Treatment <- factor(
  pheno$Treatment[match(sampleInfo_matched$tube, pheno$tube)],
  levels = c("+P", "-P")
)

  # Convert to "counts-like" scale (multiply by 1e9 for numerical stability)
  scaled_fractions <- ion_fraction[,sampleInfo_matched$tube] * 1e9

  # Create DGEList without normalization
  y_molar <- DGEList(counts = scaled_fractions,  samples = sampleInfo_matched)
  y_molar$samples$norm.factors <- 1

# Design matrix: spatial covariates + biological factors + interaction

# Column correction:

d <- sampleInfo_matched
# Define block: column nested within treatment
block <- interaction(d$Treatment, d$Plot_Column)


design <- model.matrix(
   ~  Plot_Row + injection_order + leaf_tissue_c*Treatment + Genotype*Treatment + leaf_tissue_c*Genotype,
  d
)


cat("\nDesign matrix dimensions:", dim(design), "\n")
cat("\nCoefficients in model:\n")
print(colnames(design))

cat("\nDesign matrix summary:\n")
print(head(design))

# Calculate normalization factors
# y <- calcNormFactors(y_molar)

cat("\nNormalization factors calculated\n")
cat("Norm factors summary:\n")
# print(summary(y$samples$norm.factors))
```

  
  
## Voom Transformation and Linear Modeling

```{r voom_fit, fig.width=10, fig.height=6}
# Apply voom transformation
# Voom transformation with precision weights
voomR <- voom(y_molar, design = design, plot = FALSE)


# --- 4. Estimate consensus correlation for blocks ---
corfit <- duplicateCorrelation(voomR, design, block = block)

# --- 5. Fit linear model accounting for block correlation ---
fit <- lmFit(voomR, design, block = block, correlation = corfit$consensus.correlation)

# --- 6. Apply empirical Bayes moderation ---
ebfit <- eBayes(fit)

cat("\nModel fitted successfully\n")
{
  cat("Model fitted:", nrow(fit$coefficients), "genes ×", 
      ncol(fit$coefficients), "coefficients\n")
  cat("\nSignificant genes per coefficient (FDR < 0.05):\n")
  print(colSums(abs(decideTests(ebfit))))
}
```

## Extract Results for Each Predictor

```{r, extract_effects}
#' Extract differential abundance results for specified predictors
#'
#' @param ebfit An eBayes fitted model object from limma
#' @param predictor_map Named vector mapping coefficient names to display names
#'
#' @return A data frame with DE results for all specified predictors
extract_predictor_effects <- function(ebfit, predictor_map) {
  # Get coefficient names from the model
  coef_names <- colnames(coef(ebfit))
  
  # Match predictor names to coefficient positions
  coef_indices <- match(names(predictor_map), coef_names)
  
  # Validate all predictors found
  if (any(is.na(coef_indices))) {
    missing <- names(predictor_map)[is.na(coef_indices)]
    stop("Coefficients not found: ", paste(missing, collapse = ", "),
         "\nAvailable: ", paste(coef_names, collapse = ", "))
  }
  
  # Extract results for each predictor
  result_list <- lapply(seq_along(coef_indices), function(i) {
    idx <- coef_indices[i]
    
    tt <- topTable(ebfit, coef = idx, sort.by = "none", n = Inf)
    
    # Calculate 95% confidence intervals
    crit_value <- qt(0.975, ebfit$df.residual + ebfit$df.prior)
    std_errors <- ebfit$stdev.unscaled[, idx] * sqrt(ebfit$s2.post)
    
    tt$upper <- tt$logFC + crit_value * std_errors
    tt$lower <- tt$logFC - crit_value * std_errors
    tt$predictor <- predictor_map[i]
    tt$response <- rownames(tt)
    tt$std_err <- std_errors
    tt
  })
  
  # Combine and format
  results<- do.call(rbind, result_list)
  rownames(effects) <- NULL
  
  results %>%
    dplyr::select(predictor, response, everything()) %>%
    arrange(adj.P.Val)
}
```

```{r}
# Map coefficients (use names from coef(), not topTable())
predictor_map <- c(
  "leaf_tissue_c" = "Leaf",
  "Treatment-P" = "-P",
  "leaf_tissue_c:Treatment-P" = "Leaf:-P"
)

# Verify coefficient names match
cat("Available coefficients:\n")
print(colnames(coef(ebfit)))

effects_df <- extract_predictor_effects(ebfit, predictor_map)

# Summary
cat("\nTotal tests:", nrow(effects_df), "\n")
cat("Tests per predictor:\n")
print(table(effects_df$predictor))
cat("\nSignificant per predictor (FDR < 0.05):\n")
print(table(effects_df$predictor[effects_df$adj.P.Val < 0.05]))
```

## Process Effects and Define Significance

```{r process_effects_significance}
#' Classify differential lipids with predictor-specific thresholds
#'
#' Applies two-tier classification:
#' - Tier 1: Significant DLs (FDR < 0.05)
#' - Tier 2: High-confidence DLs (significant + large effect size)
#'
#' Effect size thresholds:
#' - Leaf predictors: |logFC| > 0.5 (equivalent to |3β| > 1.5 across range)
#' - Categorical predictors: |logFC| > 1.5
classify_differential_lipids <- function(effects_df) {
  # Define predictor types
  leaf_predictors <- c("Leaf", "Leaf:-P")
  
  effects_df %>%
    mutate(
      # Significance
      is_DL = adj.P.Val < 0.05,
      # High-confidence based on predictor type
      is_hiconf_DL = case_when(
        predictor %in% leaf_predictors &  is_DL & abs(logFC) > 0.5 ~ TRUE,
        predictor =="-P" &  is_DL & abs(logFC) > 1.5 ~ TRUE,
        .default = FALSE
      ),
      
      # Direction of effect
      regulation = case_when(
        !is_hiconf_DL ~ "Not significant",
        logFC > 0 ~ "Upregulated",
        logFC < 0 ~ "Downregulated",
        TRUE ~ "Not significant"
      ),
      
      # Negative log P-value for plotting
      neglogP = -log10(adj.P.Val)
    ) %>%
  mutate(label = if_else(is_DL, response, ""))
  
}
```

```{r process_effects}
# Define predictor order
effect_order <- c("Leaf", "-P", "Leaf:-P")

# Apply classification
effects_df <- effects_df %>%
  mutate(predictor = factor(predictor, levels = effect_order)) %>%
  classify_differential_lipids()

# Format labels for plotting
effects_df$label <- sub("_", "", effects_df$label, perl = TRUE)
effects_df$label <- sub("_", ":", effects_df$label, perl = TRUE)

# Summary statistics
cat("Classification summary:\n")
cat("Total tests:", nrow(effects_df), "\n\n")

cat("Tier 1 - Significant DLs (FDR < 0.05):\n")
print(table(effects_df$predictor, effects_df$is_DL))

cat("\nTier 2 - High-confidence DLs:\n")
print(table(effects_df$predictor, effects_df$is_hiconf_DL))

cat("\nDirection of significant effects:\n")
print(with(effects_df %>% filter(is_DL), 
           table(predictor, regulation)))
```



# Volcano Plots

## Custom Legend Key Function

```{r custom_legend}
# Custom key glyph for legend
draw_key_custom <- function(data, params, size) {
  colour <- data$colour
  data <- data[data$colour == colour, ]
  grid::segmentsGrob(
    0, 1 / 2, 1, 1 / 2,
    gp = grid::gpar(
      col = data$colour,
      lwd = data$linewidth * 2
    )
  )
}
```


```{r, volcano_plot_by_pieces}
#' Create volcano plot with staged label placement
#'
#' Plots downregulated labels to the left (xlim < -1.5) and upregulated
#' labels to the right (xlim > 1.5). The -P predictor uses unrestricted
#' labeling.
#'
#' @return A ggplot object with faceted volcano plots

plot_data <- effects_df %>%
  droplevels() %>%
  inner_join(sp, by = c(response = "colname"))
effects_df$is
label_data <- plot_data %>%
  filter(is_hiconf_DL)

write.csv(
  label_data,
  file = file.path(paths$intermediate, "high_confidence_DLs.csv"),
  row.names = FALSE
)

force <- 1
label_size <-6

lipid_volcano_3 <- plot_data %>%
  ggplot(aes(
    x = logFC,
    y = -log10(adj.P.Val),
    color = head_group,
    fill = regulation,
    label = label
  )) +
  ylab(expression(-log[10](italic(FDR)))) +
  xlab(expression(log[2]("Fold Change"))) +
  geom_point(alpha = 0.7, shape = 21, color = "white") +
  scale_fill_manual(
    name = "",
    values = c("#00AFBB", "grey", "#bb0c00"),
    labels = c("Downregulated", "Not significant", "Upregulated")
  ) +
  # Stage 1: Downregulated labels (left side)
  geom_text_repel(
    data = label_data  %>% 
      filter(predictor == "Leaf", regulation == "Downregulated", !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size=label_size,
    segment.color="grey",
    min.segment.length = 0,
    xlim = c(NA, -0.5),
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  # Stage 2: Upregulated labels (right side)
  geom_text_repel(
    data = label_data  %>% 
      filter(predictor == "Leaf", regulation == "Upregulated", !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size=label_size,
    segment.color="grey",
    min.segment.length = 0,
    xlim = c(0.5, NA),
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
   # Stage 1: Downregulated labels (left side)
  geom_text_repel(
    data = label_data  %>% 
      filter(predictor == "-P", regulation == "Downregulated", !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size=label_size,
    direction = "y",
    segment.color="grey",
    min.segment.length = 0,
    xlim = c(NA, -4),
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  # Stage 2: Upregulated labels (right side)
  geom_text_repel(
    data = label_data  %>% 
      filter(predictor == "-P", regulation == "Upregulated", !is.na(label), label != ""),
        force = force,
    fontface = "bold",
    size=label_size,
    direction = "y",
    segment.color="grey",
    min.segment.length = 0,
    xlim = c(4, NA),
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  # Separate: -P predictor without xlim restrictions
  geom_text_repel(
    data = label_data  %>% 
      filter(predictor == "Leaf:-P", !is.na(label), label != ""),
        force = force,
    fontface = "bold",
    size=label_size,
    segment.color="grey",
    min.segment.length = 0,
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  scale_color_manual(
    name = "",
    values = c("darkblue", "orange2", "darkred"),
    labels = c("Glycolipid", "Neutral lipid", "Phospholipid")
  ) +
  facet_wrap(. ~ predictor, scales = "free_x", ncol = 3) +
  guides(
    color = guide_legend(override.aes = list(linewidth = 1.5)),
    fill = "none"
  ) +
  scale_y_continuous(expand = expansion(mult=c(0,0.1)))+
  scale_x_continuous(expand = expansion(mult=c(0.3,0.05)))+
  theme_classic2(base_size = 30) +
  theme(
    plot.title = element_blank(),
    # strip.text = element_blank(),
    strip.text = element_markdown( size=35),
    legend.position = c(0.85, 0.95),
    legend.background = element_rect(fill = "transparent"),
    #axis.title = element_text(size=25),
    axis.title.x = element_blank(),
    #legend.position = "top",
    legend.spacing = unit(0, "line"),
    legend.box.spacing = unit(0, "line"),
    legend.text = element_text(size = 25),
    axis.title.y = element_text(margin = margin(r = -5)),
    plot.margin = margin(5.5, 5.5, 0, 5.5, "pt"),
    strip.background = element_blank()
  )

# Save growth curve plots
saveRDS(lipid_volcano_3, file.path(paths$intermediate, "lipid_volcano_3.rds"))

print(lipid_volcano_3)

```
## Volcano Plot: All Three Predictors (Excluding Interaction)


## Volcano Plot: Leaf and -P Only 

This focused plot excludes Leaf x -P results to better visualize differential 
lipids in response to leaf tissue position and phosphorus deficiency.

```{r volcano_leaf_p, fig.width=10, fig.height=6}
#' Create volcano plot with staged label placement
#'
#' Plots downregulated labels to the left (xlim < -1.5) and upregulated
#' labels to the right (xlim > 1.5). The -P predictor uses unrestricted
#' labeling.
#'
#' @return A ggplot object with faceted volcano plots

plot_data <- effects_df %>%
  filter(predictor!="Leaf:-P") %>%
  droplevels() %>%
  inner_join(sp, by = c(response = "colname"))

force <- 1
dot_size <- 5

volcano_2 <- plot_data %>%
  ggplot(aes(
    x = logFC,
    y = -log10(adj.P.Val),
    color = head_group,
    fill = regulation,
    label = label
  )) +
  ylab(expression(-log[10](italic(FDR)))) +
  xlab(expression(log[2]("Fold Change"))) +
  geom_point(alpha = 0.7, shape = 21, color = "white") +
  scale_fill_manual(
    name = "",
    values = c("#00AFBB", "grey", "#bb0c00"),
    labels = c("Downregulated", "Not significant", "Upregulated")
  ) +
  # Stage 1: Downregulated labels (left side)
  geom_text_repel(
    data = plot_data %>% 
      filter(predictor == "Leaf", regulation == "Downregulated", !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size=label_size,
    segment.color="grey",
    min.segment.length = 0,
    xlim = c(NA, -0.5),
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  # Stage 2: Upregulated labels (right side)
  geom_text_repel(
    data = plot_data %>% 
      filter(predictor == "Leaf", regulation == "Upregulated", !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size=label_size,
    segment.color="grey",
    min.segment.length = 0,
    xlim = c(0.5, NA),
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
   # Stage 1: Downregulated labels (left side)
  geom_text_repel(
    data = plot_data %>% 
      filter(predictor == "-P", regulation == "Downregulated", !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size=label_size,
    direction = "y",
    segment.color="grey",
    min.segment.length = 0,
    xlim = c(NA, -4),
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  # Stage 2: Upregulated labels (right side)
  geom_text_repel(
    data = plot_data %>% 
      filter(predictor == "-P", regulation == "Upregulated", !is.na(label), label != ""),
    force = 2,
    fontface = "bold",
    size=label_size,
    direction = "y",
    segment.color="grey",
    min.segment.length = 0,
    xlim = c(4, NA),
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  scale_color_manual(
    name = "",
    values = c("darkblue", "orange2", "darkred"),
    labels = c("Glycolipid", "Neutral lipid", "Phospholipid")
  ) +
  facet_wrap(. ~ predictor, scales = "free_x", ncol = 3) +
  guides(
    color = guide_legend(override.aes = list(linewidth = 1.5),reverse = TRUE),
    fill = "none"
  ) +
  scale_y_continuous(expand = expansion(mult=c(0,0.3)))+
  scale_x_continuous(expand = expansion(mult=c(0.3,0.02)))+
  theme_classic2(base_size = 30) +
  theme(
    plot.title = element_blank(),
    # strip.text = element_blank(),
    strip.text = element_markdown( size=35),
    legend.position = c(0.12, 0.85),
    legend.background = element_rect(fill = "transparent"),
    axis.title = element_text(size=25),
    #legend.position = "top",
    legend.spacing = unit(0, "line"),
    legend.box.spacing = unit(0, "line"),
    legend.text = element_text(size = 20),
    #legend.direction = "horizontal",
    axis.title.y = element_text(margin = margin(r = -5)),
    strip.background = element_blank()
  )

print(volcano_2)

ggsave(
  filename = file.path(paths$figures, "volcano_2_leafxP.png"),
  plot = volcano_2,
  height = 3,
  width = 5,
  units = "in",
  dpi = 150
)

```

```{r volcano_1panel_inv4m, fig.width=6, fig.height=6}
#' Create volcano plot for Leaf:-P interaction
#'
#' Plots labels without xlim restrictions for the Leaf:-P interaction effect.
#'
#' @return A ggplot object for Leaf:-P volcano plot
plot_data_leafP <- effects_df %>%
  filter(predictor == "Leaf:-P") %>%
  droplevels() %>%
  inner_join(sp, by = c(response = "colname"))

force <- 1

volcano_leafP <- plot_data_leafP %>%
  ggplot(aes(
    x = logFC,
    y = -log10(adj.P.Val),
    color = head_group,
    fill = regulation,
    label = label
  )) +
  ylab(expression(-log[10](italic(FDR)))) +
  xlab(expression(log[2]("Fold Change"))) +
  ylim(0, 5) +
  geom_point(alpha = 0.7, shape = 21, color = "white") +
  scale_fill_manual(
    name = "",
    values = c("#00AFBB", "grey", "#bb0c00"),
    labels = c("Downregulated", "Not significant", "Upregulated")
  ) +
  # Downregulated labels (no xlim restriction)
  geom_text_repel(
    data = plot_data_leafP %>% 
      filter(regulation == "Downregulated", !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size = 7,
    segment.color = "grey",
    min.segment.length = 0,
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  # Upregulated labels (no xlim restriction)
  geom_text_repel(
    data = plot_data_leafP %>% 
      filter(regulation == "Upregulated", !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size = 7,
    segment.color = "grey",
    min.segment.length = 0,
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  scale_color_manual(
    name = "",
    values = c("orange2", "darkred", "darkblue" ),
    labels = c("Glycolipid", "Neutral lipid", "Phospholipid")
  ) +
  guides(
    color = guide_legend(override.aes = list(linewidth = 1.5), reverse = TRUE),
    fill = "none"
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.3))) +
  theme_classic2(base_size = 30) +
  theme(
    plot.title = element_blank(),
    # strip.text = element_blank(),
    strip.text = element_markdown( size=35),
    legend.position = "none",
    legend.background = element_rect(fill = "transparent"),
    axis.title = element_text(size = 25),
    legend.spacing = unit(0, "line"),
    legend.box.spacing = unit(0, "line"),
    legend.text = element_text(size = 20),
    axis.title.y = element_text(margin = margin(r = -5)),
    strip.background = element_blank()
  )

print(volcano_leafP)

ggsave(
  filename = file.path(paths$figures, "volcano_leafP.png"),
  plot = volcano_leafP,
  height = 7,
  width = 7,
  units = "in",
  dpi = 150
)
```

# Effect Size Plots

## Prepare Data for Effect Plots

```{r prepare_effect_plots}
# Filter significant effects and prepare for plotting
to_plot <- effects_df %>%
  mutate(response = gsub("_glyco", "", response)) %>%
  mutate(predictor = factor(
    predictor,
    levels = c("Leaf", "-P", "Leaf:-P","Inv4m", "-P:Inv4m")
  )) %>%
  filter(is_hiconf_DL) %>%
  inner_join(sp, by = c(response = "colname")) %>%
  mutate(sign = sign(logFC)) %>%
  ungroup() %>%
  group_by(response) %>%
  mutate(max_effect = max(abs(logFC))) %>%
  ungroup() %>%
  group_by(predictor, head_group, class) %>%
  mutate(head_group = fct_reorder(head_group, adj.P.Val)) %>%
  ungroup() %>%
  group_by(predictor) %>%
  arrange(predictor, head_group, class, adj.P.Val) %>%
  mutate(.r = row_number()) %>%
  ungroup()

cat("\nSignificant effects per predictor:\n")
print(with(to_plot, table(predictor, head_group)))
```

## Effect Size Plot: All Predictors

```{r effect_plot_all, fig.width=12, fig.height=10}
pd <- position_dodge(0.4)

effect_plot_all <- to_plot %>%
  droplevels() %>%
  mutate(response = fct_reorder(response, .r)) %>%
  ungroup() %>%
  ggplot(aes(
    x = logFC,
    y = response,
    col = head_group
  )) +
  xlab("Effect (log2 Fold Change)") +
  geom_vline(xintercept = 0, lty = 2) +
  geom_point(position = pd, size = 3) +
  geom_errorbar(
    aes(xmin = upper, xmax = lower),
    position = pd,
    width = 0.2,
    linewidth = 0.7
  ) +
  guides(
    shape = guide_legend(title = NULL),
    color = guide_legend(reverse = TRUE)
  ) +
  facet_wrap(. ~ predictor, scales = "free", ncol = 4) +
  scale_y_discrete(limits = rev) +
  scale_color_manual(values = c("blue", "red", "chartreuse")) +
  theme_light(base_size = 15) +
  theme(
    legend.position = "top",
    strip.background = element_rect(fill = "white"),
    strip.text = element_text(color = "black", size = 15),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_blank()
  )

print(effect_plot_all)
```

# Export Results

```{r export_results}
# Export differential abundance results
write.csv(
  voomR$E,
  file = file.path(paths$intermediate, "voom_normalised_lipids.csv"),
  row.names = TRUE
)

# Export differential abundance results
write.csv(
  effects_df,
  file = file.path(paths$intermediate, "lipid_differential_abundance_results.csv"),
  row.names = FALSE
)

# Save volcano plots (alternative export - disabled)
# ggsave(
#   volcano_3,
#   file = file.path(paths$figures, "lipid_volcano_all.svg"),
#   height = 6,
#   width = 12
# )

ggsave(
  volcano_leafP,
  file = file.path(paths$figures, "lipid_volcano_leaf_P.svg"),
  height = 6,
  width = 10
)

ggsave(
  effect_plot_all,
  file = file.path(paths$figures, "lipid_effects_all.svg"),
  height = 10,
  width = 12
)
```

# Summary Statistics

```{r summary_stats}
# Count differential lipids by class and regulation
summary_table <- effects_df %>%
  filter(is_DL) %>%
  inner_join(sp, by = c(response = "colname")) %>%
  group_by(predictor, head_group, regulation) %>%
  summarise(n_lipids = n(), .groups = "drop") %>%
  arrange(predictor, head_group, regulation)

print(summary_table)

# Significant lipids per predictor
sig_summary <- effects_df %>%
  group_by(predictor) %>%
  summarise(
    total_tested = n(),
    n_significant = sum(is_DL),
    n_upregulated = sum(is_DL & logFC>0),
    n_downregulated = sum(is_DL & logFC<0),
    pct_significant = round(100 * n_significant / total_tested, 1)
  )

print(sig_summary)
```
# Export Latex Tables
```{r export_latex}
library(dplyr)

# Prepare lipid data (high-confidence only)
lipid_table_data <- to_plot %>%
  filter(is_hiconf_DL) %>%
  mutate(
    logFC = round(logFC, digits = 2),
    std_err = round(std_err, digits = 2),
    neglogP = round(-log10(adj.P.Val), digits = 2),
    predictor_display = case_when(
      predictor == "-P"        ~ "Phosphorus Deficiency (-P)",
      predictor == "Leaf"      ~ "Leaf Tissue Position (Leaf)",
      predictor == "Leaf:-P"   ~ "Leaf × Phosphorus Interaction (Leaf:-P)",
      TRUE                     ~ as.character(predictor)
    )
  ) %>%
  arrange(predictor, desc(regulation == "Upregulated"), desc(neglogP))


# Function to generate LaTeX
create_lipid_table <- function(df) {
  lines <- c()
  
  lines <- c(lines, "\\begin{table}[h!]")
  lines <- c(lines, "\\centering")
  lines <- c(lines, "\\footnotesize")
  lines <- c(lines, "\\caption{High-confidence differentially abundant lipids across experimental factors, annotated with IUB nomenclature and lipid class.}")
  lines <- c(lines, "\\label{table::differential_lipids}")
  lines <- c(lines, "\\begin{tabular}{|c|c|c|c|}")  # 4 columns now
  lines <- c(lines, "\\hline")
  lines <- c(lines, "\\textbf{Lipid (IUB)} & \\textbf{Class} & \\textbf{$-\\log_{10}(\\textit{FDR})$} & \\textbf{$\\log_2(\\text{FC})$}\\\\")
  lines <- c(lines, "\\hline")
  
  for (pred in unique(df$predictor)) {
    pred_data <- df %>% filter(predictor == pred)
    pred_name <- pred_data$predictor_display[1]
    
    # Predictor section
    lines <- c(lines, sprintf("\\multicolumn{4}{|l|}{\\textit{\\textbf{%s}}} \\\\", pred_name))
    lines <- c(lines, "\\hline")
    
    # Upregulated
    up_data <- pred_data %>% filter(regulation == "Upregulated")
    if (nrow(up_data) > 0) {
      lines <- c(lines, "\\multicolumn{4}{|l|}{\\textit{\\textbf{Upregulated Lipids}}} \\\\")
      lines <- c(lines, "\\hline")
      for (i in 1:nrow(up_data)) {
        row <- up_data[i, ]
        lines <- c(lines, sprintf(
          "%s & %s & %.1f & %.2f\\\\",
          row$label, row$head_group, row$neglogP, row$logFC,row$std_err
        ))
      }
    }
    
    # Downregulated
    down_data <- pred_data %>% filter(regulation == "Downregulated")
    if (nrow(down_data) > 0) {
      lines <- c(lines, "\\multicolumn{4}{|l|}{\\textit{\\textbf{Downregulated Lipids}}} \\\\")
      lines <- c(lines, "\\hline")
      for (i in 1:nrow(down_data)) {
        row <- down_data[i, ]
        lines <- c(lines, sprintf(
          "%s & %s & %.1f & %.2f\\\\",
          row$label, row$head_group, row$neglogP, row$logFC,row$std_err
        ))
      }
    }
    
    lines <- c(lines, "\\hline")
  }
  
  lines <- c(lines, "\\end{tabular}")
  lines <- c(lines, "\\end{table}")
  
  return(paste(lines, collapse = "\n"))
}

# Generate and save
latex_table <- create_lipid_table(lipid_table_data)
writeLines(latex_table, con = file.path(paths$tables, "differential_lipids_table.tex"))

cat("✅ Final lipid table (4 columns, no Notes) saved to:", file.path(paths$tables, "differential_lipids_table.tex"), "\n")
```
# Session Information

```{r session_info}
sessionInfo()
```
