---
title: "Lipid Differential Expression Analysis"
author: "Maize Genetics Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 12,
  fig.height = 8
)
```

# Overview

This analysis performs differential expression analysis on lipid profiles from 
maize leaf samples across multiple experimental factors:

- **Leaf tissue position**: Continuous gradient from apical to basal (leaf 1-4)
- **Phosphorus treatment**: High P (+P) vs Low P (-P)
- **Genotype**: Control (CTRL) vs Inversion 4m (INV4M)

The analysis uses limma-voom to identify lipids that respond to:

1. **leaf**: Leaf tissue position effect
2. **-P**: Phosphorus deficiency effect
3. **Inv4m**: Genotype effect
4. **-P:Inv4m**: Interaction between P treatment and genotype

Fold change thresholds:

- Leaf effect: ±0.7 log2FC
- Other effects: ±2 log2FC

# Libraries

```{r libraries}
library(edgeR)
library(ggplot2)
library(limma)
library(dplyr)
library(tidyr)
library(forcats)
library(ggrepel)
library(ggpubr)
library(ggtext)
```

# Data Loading and Preprocessing

## Define Internal Standards to Exclude

```{r define_exclusions}
# Internal standards and odd-chain lipids to exclude
to_exclude <- c(
  "DG_12_0", "LPC_17_0", "LPE_17_1",
  "PC_25_0", "PG_17_0", "SM_35_1",
  "Sphingosine_17_1", "TG_17_0",
  "TG_57_6"  # exclude the odd number lipid
)
```

## Load Raw Lipid Data

```{r load_lipid_data}
# Load MS-Dial raw data with new internal standard integration
lipid_csv <- "../data/PSU_RawData_MSDial_NewStdInt_240422.csv"

raw <- read.csv(lipid_csv, na.strings = c("", "#N/A", "NA", "Inf"))

# Remove internal standards and quality control samples
to_exclude <- to_exclude[to_exclude %in% colnames(raw)]

raw <- raw %>%
  select(-all_of(to_exclude)) %>%
  filter(!grepl("Methanol", sampleID)) %>%
  filter(!grepl("Pool", sampleID))

cat("Loaded", nrow(raw), "samples\n")
```

## Load Sample Metadata

```{r load_metadata}
# Load plant phenotypic data
plant_csv <- "/Users/fvrodriguez/Desktop/Desktop/22_NCS_PSU_LANGEBIO_FIELDS_PSU_P_field.csv"

psu <- read.csv(plant_csv) %>%
  rename(Genotype = "Who.What", rowid = "P22.") %>%
  filter(Genotype %in% c("CTRL", "INV4M")) %>%
  droplevels()

# Load RNA-seq metadata
sampleInfo <- read.csv('../data/inv4mRNAseq_metadata.csv') %>%
  rename(Genotype = genotype) %>%
  rename(rowid = row)

# Merge metadata
sampleInfo <- psu %>%
  select(rowid, Rep, Plot_Row, Plot_Column, DTA, DTS) %>%
  inner_join(sampleInfo) %>%
  filter(!is.na(DTA))

# Create leaf position groups
sampleInfo$leaf_group <- NA
sampleInfo$leaf_group[sampleInfo$leaf_tissue < 3] <- "apical"
sampleInfo$leaf_group[sampleInfo$leaf_tissue > 2] <- "basal"

# Standardize sample IDs
sampleInfo$tube <- gsub("L|R", "S", sampleInfo$tube, perl = TRUE)
sampleInfo$rowid <- sampleInfo$row

cat("Sample info loaded for", nrow(sampleInfo), "samples\n")
```

## Merge Lipid Data with Metadata

```{r merge_data}
# Extract tube ID from raw data
raw$tube <- gsub(".*_|.raw", "", raw$sampleID, perl = TRUE)
raw$tube <- gsub("L|R", "S", raw$tube, perl = TRUE)

# Merge phenotypic data with lipid measurements
pheno <- sampleInfo %>%
  select(rowid, tube, Rep, Plot:Plot_Row, Treatment:leaf_tissue, leaf_group) %>%
  inner_join(
    raw %>%
      select(tube, DGDG_34_0:TG_58_5)
  ) %>%
  mutate(block = as.factor(Rep)) %>%
  droplevels() %>%
  pivot_wider(
    names_from = Rep,
    values_from = Rep,
    names_prefix = "block_",
    values_fn = function(x) 1,
    values_fill = 0
  ) %>%
  select(rowid, tube:Plot_Row, block, block_6:block_12, everything()) %>%
  mutate(Treatment = factor(Treatment, levels = c("High_P", "Low_P")))

# Simplify treatment labels
levels(pheno$Treatment) <- c("+P", "-P")

# Remove problematic sample
pheno <- pheno[-29, ]  # what's wrong with this sample?

cat("Final dataset:", nrow(pheno), "samples\n")
```

## Define Lipid Classifications

```{r lipid_classes}
# Extract lipid measurements matrix
m <- pheno %>%
  select(DGDG_34_0:TG_58_5) %>%
  as.matrix()

# Define lipid head groups
head_group <- c(
  DG = "neutral",
  DGDG = "glycolipid",
  DGGA = "glycolipid",
  LPC = "phospholipid",
  LPE = "phospholipid",
  MGDG = "glycolipid",
  PC = "phospholipid",
  PE = "phospholipid",
  PG = "phospholipid",
  PI = "phospholipid",
  SQDG = "glycolipid",
  TG = "neutral"
)

# Create lipid species annotation
sp <- data.frame(
  colname = colnames(m),
  class = gsub("_.*", "", colnames(m), perl = TRUE)
)

sp$head_group <- head_group[sp$class]

# Summary of lipid classes
cat("\nLipid class distribution:\n")
print(with(sp, table(head_group, class)))
```

# Quality Control

## Create DGEList Object

Critical step: The counts matrix comes from `pheno`, but we need to ensure the 
sample metadata in the DGEList matches the processed `pheno` data, especially 
for Treatment levels which were renamed from "High_P"/"Low_P" to "+P"/"-P".

```{r create_dgelist}
# Prepare count matrix
counts <- pheno[, colnames(m)] %>%
  as.matrix() %>%
  t()

# Visualize data distribution
hist(counts, main = "Distribution of Lipid Abundances", xlab = "Abundance")

# Set column names to match sample IDs
colnames(counts) <- pheno$tube

cat("\nCount matrix dimensions:", dim(counts), "\n")
cat("Lipids:", nrow(counts), "\n")
cat("Samples:", ncol(counts), "\n")
```

## Match Sample Metadata to Counts

```{r match_metadata}
# Extract sample names from counts matrix
sampleNames <- pheno$tube

# Verify all sample names are present
cat("\nAll samples in counts?", all(sampleNames %in% sampleInfo$tube), "\n")

# Match sampleInfo to the order of samples in counts matrix
sampleInfo_matched <- sampleInfo[match(sampleNames, sampleInfo$tube), ]

# CRITICAL: Update Treatment levels to match pheno
# The pheno object has Treatment renamed to "+P"/"-P"
sampleInfo_matched$Treatment <- factor(
  pheno$Treatment[match(sampleInfo_matched$tube, pheno$tube)],
  levels = c("+P", "-P")
)

cat("\nTreatment levels after update:\n")
print(levels(sampleInfo_matched$Treatment))
print(table(sampleInfo_matched$Treatment))
```

## Create DGEList with Matched Metadata

```{r create_dgelist_final}
# Create gene annotation
genes <- data.frame(gene = rownames(counts))

# Create DGEList with matched sample information
y <- DGEList(counts = counts, samples = sampleInfo_matched)

# Create sample groups from Treatment and Genotype
y$group <- interaction(y$samples$Treatment, y$samples$Genotype)

# Identify low count samples (library size < 1)
y$samples$lowCount <- y$samples$lib.size < 1

cat("\nDGEList created successfully\n")
cat("Groups:", levels(y$group), "\n")
cat("\nLibrary size summary:\n")
print(summary(y$samples$lib.size))

cat("\nLow count samples:\n")
print(table(y$samples$lowCount))
```

## Initial MDS Plot

```{r initial_mds, fig.width=10, fig.height=6}
# Compute MDS on all samples
mds <- plotMDS(y, pch = 21, label = y$samples$side_tag, plot = TRUE)
title("Initial MDS - All Samples")
```

## Filter Samples by Library Size

```{r filter_samples}
# Create filtered object
y_filtered <- y

cat("\nSamples before filtering:", ncol(y_filtered), "\n")

# Filter by sample (remove low count samples)
y_filtered_bySample <- y_filtered[, !y_filtered$samples$lowCount]

cat("Samples after filtering:", ncol(y_filtered_bySample), "\n")

# Diagnostic tables - check sample distribution
cat("\n=== Diagnostic Tables ===\n")

cat("\nTreatment by Leaf Tissue:\n")
print(table(
  y_filtered_bySample$samples$Treatment,
  y_filtered_bySample$samples$leaf_tissue
))

cat("\nGenotype by Leaf Tissue:\n")
print(table(
  y_filtered_bySample$samples$Genotype,
  y_filtered_bySample$samples$leaf_tissue
))

cat("\nTreatment by Genotype by Leaf Tissue:\n")
print(table(
  y_filtered_bySample$samples$Treatment,
  y_filtered_bySample$samples$Genotype,
  y_filtered_bySample$samples$leaf_tissue
))
```

## MDS After Filtering

```{r mds_filtered, fig.width=10, fig.height=6}
# Compute MDS on filtered samples
mds2 <- plotMDS(
  y_filtered_bySample,
  pch = 21,
  label = y_filtered_bySample$samples$side_tag,
  bg = (as.factor(y_filtered_bySample$samples$lowCount) == TRUE) + 1,
  plot = TRUE
)
title("MDS After Filtering")
```

## Prepare Data Frame for ggplot MDS Visualizations

CRITICAL: We need to use the ORIGINAL y_filtered object for the metadata 
to ensure all samples are included in the MDS visualization, but use the 
coordinates from the MDS computed on all samples.

```{r prepare_mds_data}
# Extract sample metadata from filtered object
d <- y_filtered$samples

# Add MDS coordinates from initial MDS
d$x <- mds$x
d$y <- mds$y

# Verify metadata is present
cat("\n=== Verifying Metadata ===\n")
cat("\nTreatment levels in d:\n")
print(levels(d$Treatment))
cat("\nTreatment counts:\n")
print(table(d$Treatment))

cat("\nGenotype levels in d:\n")
print(levels(factor(d$Genotype)))
cat("\nGenotype counts:\n")
print(table(d$Genotype))

cat("\nLeaf tissue levels in d:\n")
print(levels(factor(d$leaf_tissue)))
cat("\nLeaf tissue counts:\n")
print(table(d$leaf_tissue))

# Ensure factors are properly set
d$Treatment <- factor(d$Treatment, levels = c("+P", "-P"))
d$Rep <- factor(d$Rep)
```

## MDS Plots with ggplot

```{r mds_ggplots, fig.width=12, fig.height=10}
# MDS by Treatment
p1 <- ggplot(d, aes(x = x, y = y)) +
  geom_point(aes(color = Treatment), size = 3) +
  ggtitle("MDS Plot: Treatment") +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  theme_classic(base_size = 14)

# MDS by decimal time (collection time)
p2 <- ggplot(d, aes(x = x, y = y)) +
  geom_point(aes(color = decimal_time), size = 3) +
  ggtitle("MDS Plot: Collection Time") +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  theme_classic(base_size = 14)

# MDS by Collector
p3 <- ggplot(d, aes(x = x, y = y)) +
  geom_point(aes(color = COLLECTOR), size = 3) +
  ggtitle("MDS Plot: Collector") +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  theme_classic(base_size = 14)

# MDS by row ID and Treatment
p4 <- ggplot(d, aes(x = x, y = y)) +
  geom_point(aes(color = as.factor(rowid), shape = Treatment), size = 3) +
  ggtitle("MDS Plot: Row ID and Treatment") +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  scale_color_discrete(name = "Row ID") +
  theme_classic(base_size = 14) +
  theme(legend.position = "none")

# MDS by Genotype
p5 <- ggplot(d, aes(x = x, y = y)) +
  geom_point(aes(color = Genotype), size = 3) +
  ggtitle("MDS Plot: Genotype") +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  theme_classic(base_size = 14)

# MDS by Leaf Tissue and Treatment
p6 <- ggplot(d, aes(x = x, y = y)) +
  geom_point(aes(color = factor(leaf_tissue), shape = Treatment), size = 3) +
  ggtitle("MDS Plot: Leaf Tissue and Treatment") +
  scale_color_discrete(name = "Leaf Tissue") +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  theme_classic(base_size = 14)

ggarrange(p1, p2, p3, p4, p5, p6, ncol = 3, nrow = 2)
```

## Base R MDS Plots for Verification

```{r base_mds_plots, fig.width=12, fig.height=6}
par(mfrow = c(1, 2))

# MDS colored by Treatment
plot(
  mds2$x, mds2$y,
  pch = 21,
  bg = factor(y_filtered_bySample$samples$Treatment),
  col = 0,
  main = "MDS: Treatment",
  xlab = "Leading logFC dim 1",
  ylab = "Leading logFC dim 2"
)
legend(
  "topright",
  legend = levels(factor(y_filtered_bySample$samples$Treatment)),
  pch = 21,
  pt.bg = 1:nlevels(factor(y_filtered_bySample$samples$Treatment))
)

# MDS colored by Genotype
plot(
  mds2$x, mds2$y,
  col = factor(y_filtered_bySample$samples$Genotype),
  pch = 19,
  main = "MDS: Genotype",
  xlab = "Leading logFC dim 1",
  ylab = "Leading logFC dim 2"
)
legend(
  "topright",
  legend = levels(factor(y_filtered_bySample$samples$Genotype)),
  col = 1:nlevels(factor(y_filtered_bySample$samples$Genotype)),
  pch = 19
)
```

# Differential Expression Analysis

## Final Data Preparation for Model

CRITICAL: Before creating the design matrix, ensure Treatment levels are 
correctly set to match the original factor levels for proper interpretation.

```{r prepare_for_model}
# Verify Plot_Row is available
cat("\nPlot_Row present?", "Plot_Row" %in% colnames(d), "\n")
cat("Plot_Row values:\n")
print(table(d$Plot_Row))

# Set Treatment with original levels for model matrix
# This ensures the contrast is interpreted correctly
d$Treatment <- factor(d$Treatment, levels = c("+P", "-P"))

cat("\nTreatment levels for model:\n")
print(levels(d$Treatment))
print(table(d$Treatment))

# IMPORTANT: Reset y_filtered_bySample to original y for modeling
# This ensures we use all samples (not just the filtered ones)
y_filtered_bySample <- y
```

## Design Matrix and Normalization

```{r design_normalization}
# Create design matrix
# Model accounts for:
# - Plot_Row: spatial variation (row in field)
# - Plot_Column: spatial variation (column in field)  
# - Rep: block effects
# - leaf_tissue: continuous leaf position effect (1-4, apical to basal)
# - Treatment: P treatment (+P vs -P)
# - Genotype: CTRL vs INV4M
# - Treatment:Genotype: interaction between P and genotype
design <- model.matrix(
    ~ Plot_Row + Plot_Column + Rep + leaf_tissue + Treatment*Genotype,
  d
)

cat("\nDesign matrix dimensions:", dim(design), "\n")
cat("\nCoefficients in model:\n")
print(colnames(design))

cat("\nDesign matrix summary:\n")
print(head(design))

# Calculate normalization factors
y_filtered_bySample <- calcNormFactors(y_filtered_bySample)

cat("\nNormalization factors calculated\n")
cat("Norm factors summary:\n")
print(summary(y_filtered_bySample$samples$norm.factors))
```

## Voom Transformation and Linear Modeling

```{r voom_fit, fig.width=10, fig.height=6}
# Apply voom transformation
voomR <- voom(y_filtered_bySample, design = design, plot = TRUE)

# Fit linear model
fit <- lmFit(voomR)
ebfit <- eBayes(fit)

cat("\nModel fitted successfully\n")
cat("Number of lipids:", nrow(ebfit$coefficients), "\n")
```

## Extract Results for Each Predictor

```{r, extract_effects}
# Define predictor mappings
predictor_map <- c(
  "leaf_tissue" = "leaf",
  "Treatment-P" = "-P",
  "GenotypeINV4" = "Inv4m",
  "Treatment-P:GenotypeINV4" = "-P:Inv4m"
)

# Find coefficient positions
coef_names <- colnames(ebfit$coefficients)
coef_indices <- match(names(predictor_map), coef_names)

# Check for missing coefficients
if (any(is.na(coef_indices))) {
  missing <- names(predictor_map)[is.na(coef_indices)]
  stop("Coefficients not found in model: ", paste(missing, collapse = ", "))
}

# Extract results
r <- lapply(seq_along(coef_indices), function(i) {
  idx <- coef_indices[i]
  
  # Get top table
  tt <- topTable(ebfit, coef = idx, sort.by = "none", n = Inf)
  
  # Calculate confidence intervals
  cr <- qt(0.975, ebfit$df.residual + ebfit$df.prior) *
    ebfit$stdev.unscaled[, idx] * sqrt(ebfit$s2.post)
  
  tt$upper <- tt$logFC + cr
  tt$lower <- tt$logFC - cr
  tt$predictor <- predictor_map[i]
  tt$Response <- rownames(tt)
  
  tt
})

# Combine results
effects <- do.call(rbind, r)
rownames(effects) <- NULL
effects  <- effects%>% 
  select(predictor,Response,everything()) %>%
  arrange( adj.P.Val )
cat("Total tests:", nrow(effects), "\n")
cat("Tests per predictor:", table(effects$predictor), "\n")
```

## Process Effects and Define Significance

```{r process_effects}
# Define predictor order
effect_order <- c("leaf", "-P", "Inv4m", "-P:Inv4m")

# Apply predictor-specific fold change thresholds
effects <- effects %>%
  mutate(predictor = factor(predictor, levels = effect_order)) %>%
  mutate(neglogP = -log10(adj.P.Val)) %>%
  mutate(is_significant = adj.P.Val < 0.05) %>%
  mutate(upregulated = case_when(
    (predictor != "leaf") & (logFC >= 2) & is_significant ~ TRUE,
    (predictor == "leaf") & (logFC >= 0.7) & is_significant ~ TRUE,
    .default = FALSE
  )) %>%
  mutate(downregulated = case_when(
    (predictor != "leaf") & (logFC <= -2) & is_significant ~ TRUE,
    (predictor == "leaf") & (logFC <= -0.7) & is_significant ~ TRUE,
    .default = FALSE
  )) %>%
  mutate(
    regulation = case_when(
      is_significant & upregulated ~ "Upregulated",
      is_significant & downregulated ~ "Downregulated",
      .default = "Unregulated"
    ),
    is_DEG = is_significant & regulation != "Unregulated",
    label = ifelse(is_DEG, Response, "")
  )

# Format labels for plotting
effects$label <- sub("_", "", effects$label, perl = TRUE)
effects$label <- sub("_", ":", effects$label, perl = TRUE)

# Summary of differential lipids
cat("\nDifferentially expressed lipids per predictor:\n")
print(with(effects, table(predictor, regulation)))
```

# Volcano Plots

## Custom Legend Key Function

```{r custom_legend}
# Custom key glyph for legend
draw_key_custom <- function(data, params, size) {
  colour <- data$colour
  data <- data[data$colour == colour, ]
  grid::segmentsGrob(
    0, 1 / 2, 1, 1 / 2,
    gp = grid::gpar(
      col = data$colour,
      lwd = data$linewidth * 2
    )
  )
}
```

## Volcano Plot: All Three Predictors (Excluding Interaction)

```{r volcano_all, fig.width=12, fig.height=6}
volcano_all <- effects %>%
  filter(predictor != "-P:Inv4m") %>%
  droplevels() %>%
  inner_join(sp, by = c(Response = "colname")) %>%
  ggplot(aes(
    x = logFC,
    y = -log10(adj.P.Val),
    color = head_group,
    fill = regulation,
    label = label
  )) +
  ylab(expression(-log[10](italic(FDR)))) +
  xlab(expression(log[2]("Fold Change"))) +
  ylim(0, 10) +
  geom_point(alpha = 0.7, shape = 21, color = "white") +
  scale_fill_manual(
    name = "",
    values = c("#00AFBB", "grey", "#bb0c00"),
    labels = c("Downregulated", "Not significant", "Upregulated")
  ) +
  geom_text_repel(
    force = 3,
    min.segment.length = 0,
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  scale_color_manual(
    name = "",
    values = c("darkblue", "orange2", "darkred"),
    labels = c("Glycolipid", "Neutral lipid", "Phospholipid")
  ) +
  facet_wrap(. ~ predictor, scales = "free_x", ncol = 3) +
  guides(
    color = guide_legend(override.aes = list(linewidth = 1.5)),
    fill = "none"
  ) +
  theme_classic2(base_size = 25) +
  theme(
    plot.title = element_blank(),
    strip.text = element_markdown(),
    legend.position = c(0.5, 0.95),
    legend.spacing = unit(0, "line"),
    legend.box.spacing = unit(0, "line"),
    legend.text = element_text(size = 15),
    legend.direction = "horizontal",
    strip.background = element_blank()
  )

print(volcano_all)
```

## Volcano Plot: Leaf and -P Only (Excluding Inv4m)

This focused plot excludes Inv4m results to better visualize differential 
lipids in response to leaf tissue position and phosphorus deficiency.

```{r volcano_leaf_p, fig.width=10, fig.height=6}
volcano_leaf_p <- effects %>%
  filter(predictor %in% c("leaf", "-P")) %>%
  droplevels() %>%
  inner_join(sp, by = c(Response = "colname")) %>%
  ggplot(aes(
    x = logFC,
    y = -log10(adj.P.Val),
    color = head_group,
    fill = regulation,
    label = label
  )) +
  ylab(expression(-log[10](italic(FDR)))) +
  xlab(expression(log[2]("Fold Change"))) +
  ylim(0, 10) +
  geom_point(alpha = 0.7, shape = 21, color = "white") +
  scale_fill_manual(
    name = "",
    values = c("#00AFBB", "grey", "#bb0c00"),
    labels = c("Downregulated", "Not significant", "Upregulated")
  ) +
  geom_text_repel(
    force = 3,
    min.segment.length = 0,
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  scale_color_manual(
    name = "",
    values = c("darkblue", "orange2", "darkred"),
    labels = c("Glycolipid", "Neutral lipid", "Phospholipid")
  ) +
  facet_wrap(. ~ predictor, scales = "free_x", ncol = 2) +
  guides(
    color = guide_legend(override.aes = list(linewidth = 1.5)),
    fill = "none"
  ) +
  theme_classic2(base_size = 25) +
  theme(
    plot.title = element_blank(),
    strip.text = element_markdown(),
    legend.position = c(0.5, 0.95),
    legend.spacing = unit(0, "line"),
    legend.box.spacing = unit(0, "line"),
    legend.text = element_text(size = 15),
    legend.direction = "horizontal",
    strip.background = element_blank()
  )

print(volcano_leaf_p)
```

# Effect Size Plots

## Prepare Data for Effect Plots

```{r prepare_effect_plots}
# Filter significant effects and prepare for plotting
to_plot <- effects %>%
  mutate(Response = gsub("_glyco", "", Response)) %>%
  mutate(predictor = factor(
    predictor,
    levels = c("leaf", "-P", "Inv4m", "-P:Inv4m")
  )) %>%
  filter(P.Value < 0.05) %>%
  inner_join(sp, by = c(Response = "colname")) %>%
  mutate(sign = sign(logFC)) %>%
  ungroup() %>%
  group_by(Response) %>%
  mutate(max_effect = max(abs(logFC))) %>%
  ungroup() %>%
  group_by(predictor, head_group, class) %>%
  mutate(head_group = fct_reorder(head_group, adj.P.Val)) %>%
  ungroup() %>%
  group_by(predictor) %>%
  arrange(predictor, head_group, class, adj.P.Val) %>%
  mutate(.r = row_number()) %>%
  ungroup()

cat("\nSignificant effects per predictor:\n")
print(with(to_plot, table(predictor, head_group)))
```

## Effect Size Plot: All Predictors

```{r effect_plot_all, fig.width=12, fig.height=10}
pd <- position_dodge(0.4)

effect_plot_all <- to_plot %>%
  droplevels() %>%
  mutate(Response = fct_reorder(Response, .r)) %>%
  ungroup() %>%
  ggplot(aes(
    x = logFC,
    y = Response,
    col = head_group
  )) +
  xlab("Effect (log2 Fold Change)") +
  geom_vline(xintercept = 0, lty = 2) +
  geom_point(position = pd, size = 3) +
  geom_errorbar(
    aes(xmin = upper, xmax = lower),
    position = pd,
    width = 0.2,
    size = 0.7
  ) +
  guides(
    shape = guide_legend(title = NULL),
    color = guide_legend(reverse = TRUE)
  ) +
  facet_wrap(. ~ predictor, scales = "free", ncol = 4) +
  scale_y_discrete(limits = rev) +
  scale_color_manual(values = c("blue", "red", "gold")) +
  theme_light(base_size = 15) +
  theme(
    legend.position = "top",
    strip.background = element_rect(fill = "white"),
    strip.text = element_text(color = "black", size = 15),
    axis.title.y = element_blank(),
    axis.text.y = element_text(hjust = 0, face = "bold"),
    plot.caption = element_text(hjust = 0)
  )

print(effect_plot_all)
```

## Effect Size Plot: Leaf and -P Comparison

```{r effect_plot_leaf_p, fig.width=10, fig.height=8}
# Create separate plots for leaf and -P
response_leaf <- to_plot %>%
  filter(predictor == "leaf") %>%
  droplevels() %>%
  mutate(Response = fct_reorder(Response, .r)) %>%
  ungroup() %>%
  ggplot(aes(
    x = logFC,
    y = Response,
    col = head_group
  )) +
  xlab("Effect (log2 Fold Change)") +
  geom_vline(xintercept = 0, lty = 2) +
  geom_point(position = pd, size = 3) +
  geom_errorbar(
    aes(xmin = upper, xmax = lower),
    position = pd,
    width = 0.2,
    size = 0.7
  ) +
  guides(
    shape = guide_legend(title = NULL),
    color = guide_legend(reverse = TRUE)
  ) +
  facet_wrap(. ~ predictor, scales = "free") +
  scale_y_discrete(limits = rev) +
  scale_color_manual(values = c("blue", "red", "gold")) +
  theme_light(base_size = 15) +
  theme(
    legend.position = "top",
    strip.background = element_rect(fill = "white"),
    strip.text = element_text(color = "black", size = 15),
    axis.title.y = element_blank(),
    axis.text.y = element_text(hjust = 0, face = "bold"),
    plot.caption = element_text(hjust = 0)
  )

response_p <- to_plot %>%
  filter(predictor == "-P") %>%
  droplevels() %>%
  mutate(Response = fct_reorder(Response, .r)) %>%
  ungroup() %>%
  ggplot(aes(
    x = logFC,
    y = Response,
    col = head_group
  )) +
  xlab("Effect (log2 Fold Change)") +
  geom_vline(xintercept = 0, lty = 2) +
  geom_point(position = pd, size = 3) +
  geom_errorbar(
    aes(xmin = upper, xmax = lower),
    position = pd,
    width = 0.2,
    size = 0.7
  ) +
  guides(
    shape = guide_legend(title = NULL),
    color = guide_legend(reverse = TRUE)
  ) +
  facet_wrap(. ~ predictor, scales = "free") +
  scale_y_discrete(limits = rev) +
  scale_color_manual(values = c("blue",  "gold","red")) +
  theme_light(base_size = 15) +
  theme(
    legend.position = "top",
    strip.background = element_rect(fill = "white"),
    strip.text = element_text(color = "black", size = 15),
    axis.title.y = element_blank(),
    axis.text.y = element_text(hjust = 0, face = "bold"),
    plot.caption = element_text(hjust = 0)
  )

ggarrange(response_leaf, response_p, ncol = 2, common.legend = TRUE)
```

# Export Results

```{r export_results, eval=FALSE}
# Export differential expression results
write.csv(
  effects,
  file = "~/Desktop/lipid_differential_expression_results.csv",
  row.names = FALSE
)

# Save volcano plots
ggsave(
  volcano_all,
  file = "~/Desktop/lipid_volcano_all.svg",
  height = 6,
  width = 12
)

ggsave(
  volcano_leaf_p,
  file = "~/Desktop/lipid_volcano_leaf_P.svg",
  height = 6,
  width = 10
)

# Save effect plots
ggsave(
  effect_plot_all,
  file = "~/Desktop/lipid_effects_all.svg",
  height = 10,
  width = 12
)
```

# Summary Statistics

```{r summary_stats}
# Count differential lipids by class and regulation
summary_table <- effects %>%
  filter(is_DEG) %>%
  inner_join(sp, by = c(Response = "colname")) %>%
  group_by(predictor, head_group, regulation) %>%
  summarise(n_lipids = n(), .groups = "drop") %>%
  arrange(predictor, head_group, regulation)

print(summary_table)

# Significant lipids per predictor
sig_summary <- effects %>%
  group_by(predictor) %>%
  summarise(
    total_tested = n(),
    n_significant = sum(is_significant),
    n_upregulated = sum(upregulated),
    n_downregulated = sum(downregulated),
    pct_significant = round(100 * n_significant / total_tested, 1)
  )

print(sig_summary)
```

# Session Information

```{r session_info}
sessionInfo()
```
