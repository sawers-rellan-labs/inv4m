---
title: "CLY 2025 Spatial Analysis: SpATS Spatial Correction with GDD Integration"
author: "Fausto Rodríguez Zapata"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
    code_folding: hide
    fig_width: 12
    fig_height: 8
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      fig.width = 12, fig.height = 8)
```

## Overview

This notebook fits a SpATS PSANOVA surface **per phenotype** and returns spatially-corrected plot-level values for each phenotype, including GDD-based traits (GDDA and GDDS). The approach uses `statgenHTP::fitModels()` (which wraps SpATS when provided a TimePoints object) and `getCorrected()` to extract corrected plot-level observations. The workflow:

1. Load GDD lookup table for CLY2025.
2. Load and clean plant-level data from CLY2025.
3. **Aggregate to plot-level means** (matching PSU2022 structure).
4. **Merge GDD values** based on anthesis and silking dates.
5. Build a `TimePoints` object for `statgenHTP`.
6. Loop over usable phenotypes (including GDDA, GDDS) and apply `fitModels()` → `getCorrected()`.
7. Merge corrected values into a wide table `sp_corrected`.
8. Save corrected table for downstream analyses.

**Warning:** fitting many SpATS models can be computationally intensive. Run interactively on a machine with sufficient RAM/CPU.

## 1. Load libraries

```{r load-libraries}
library(tidyverse)
library(dplyr)
library(lubridate)
library(ggplot2)
library(ggtext)
library(ggfx)
library(nlme)
library(gstat)
library(rstatix)
library(ggpubr)
library(VIM)
library(knitr)
library(SpATS)
library(statgenHTP)
library(ggbeeswarm)
```

## 1b. Configuration and load GDD lookup table

```{r config-and-gdd}
environment_name <- "CLY2025"
planting_date <- mdy("4/04/2025")
gdd_lookup_file <- "gdd_lookup_table.csv"

gdd_at_phenology <- read_csv(gdd_lookup_file) %>%
  filter(environment == environment_name)

cat("Loaded GDD lookup for", environment_name, "with", 
    nrow(gdd_at_phenology), "dates\n")
cat("GDD range:", min(gdd_at_phenology$cumulative_gdd_from_planting), "to", 
    max(gdd_at_phenology$cumulative_gdd_from_planting), "°C\n")
```

## 2. Load and clean plant-level data

```{r load-data}
file_path <- "/Users/fvrodriguez/Desktop/inv4mHighland/data/CLY25_Inv4m.csv"
if (!file.exists(file_path)) {
  stop("Error: CLY25_Inv4m.csv not found in the working directory.")
} else {
  field_data_raw <- read_csv(file_path, na = c("", "#N/A", "NA"))
  
  field_data <- field_data_raw %>%
    mutate(EBA = 0.75 * BL * BW) %>%
    rename(
      plant_id = plant,
      plotId = plot_id,
      block = rep,
      x = X_pos,
      y = Y_pos,
      inv4m = inv4m_gt
    ) %>%
    mutate(
      across(c(plotId, block, donor, inv4m), as.factor),
      x = x + runif(n(), min = 0.0, max = 0.01),
      environment = environment_name,
      anthesis_date = planting_date + days(as.integer(DTA)),
      silking_date = planting_date + days(as.integer(DTS))
    ) %>%
    left_join(
      gdd_at_phenology %>% 
        rename(anthesis_date = date, GDDA = cumulative_gdd_from_planting),
      by = c("environment", "anthesis_date")
    ) %>%
    left_join(
      gdd_at_phenology %>% 
        rename(silking_date = date, GDDS = cumulative_gdd_from_planting),
      by = c("environment", "silking_date")
    )

  base_phenotypes <- c("DTA", "DTS", "LAE", "PH", "EN", "SL", "BL", "BW", "EBA")
  available_phenotypes <- intersect(base_phenotypes, names(field_data))
  all_phenotypes <- available_phenotypes
  
  cat("Plant-level data loaded and cleaned successfully!\n")
  cat("Phenotypes available for analysis:", 
      paste(all_phenotypes, collapse = ", "), "\n")
  cat("Plant-level data dimensions:", dim(field_data), "\n")
  cat("GDD columns added at plant level: GDDA (anthesis), GDDS (silking)\n")
  cat("Plants with GDDA:", sum(!is.na(field_data$GDDA)), "\n")
  cat("Plants with GDDS:", sum(!is.na(field_data$GDDS)), "\n")
}

head(field_data)
```

## 3. Aggregate to plot-level data with GDD integration

```{r aggregate-to-plots}
plot_data <- field_data %>%
  group_by(plotId, block, plot_row, plot_col, donor, inv4m) %>%
  summarise(
    across(all_of(c(all_phenotypes, "GDDA", "GDDS")), ~ mean(.x, na.rm = TRUE)),
    n_plants = n(),
    .groups = "drop"
  ) %>%
  mutate(
    across(all_of(c(all_phenotypes, "GDDA", "GDDS")), ~ ifelse(is.nan(.x), NA, .x))
  ) %>%
  rename(
    Rep = block,
    Plot_Row = plot_row,
    Plot_Column = plot_col
  ) %>%
  mutate(
    Plot_Row = as.numeric(Plot_Row),
    Plot_Column = as.numeric(Plot_Column),
    Rep = as.factor(Rep),
    genotype = as.factor(paste(donor, inv4m, sep = "."))
  ) %>%
  select(plotId, Rep, Plot_Row, Plot_Column, donor, inv4m, genotype, 
         all_of(all_phenotypes), GDDA, GDDS, n_plants)

cat("Plot-level summary dimensions:", dim(plot_data), "\n")
cat("Average plants per plot:", 
    round(mean(plot_data$n_plants, na.rm = TRUE), 1), "\n")
cat("GDD columns at plot level: GDDA (anthesis), GDDS (silking)\n")
cat("Plots with GDDA:", sum(!is.na(plot_data$GDDA)), "\n")
cat("Plots with GDDS:", sum(!is.na(plot_data$GDDS)), "\n")

cat("Genotype levels:", levels(plot_data$genotype), "\n")
cat("Rep levels:", levels(plot_data$Rep), "\n")

head(plot_data)
```

## 4. Identify usable phenotypes (<50% missing)

```{r missing-summary}
all_traits <- c(all_phenotypes, "GDDA", "GDDS")

missing_summary <- plot_data %>%
  select(all_of(all_traits)) %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "phenotype", values_to = "missing_count") %>%
  mutate(
    total_obs = nrow(plot_data),
    missing_pct = round(missing_count / total_obs * 100, 1),
    available_n = total_obs - missing_count
  ) %>%
  arrange(missing_pct)

print(missing_summary)

usable_phenotypes <- missing_summary %>%
  filter(missing_pct < 50) %>%
  pull(phenotype)

cat("Usable phenotypes (<50% missing):", 
    paste(usable_phenotypes, collapse = ", "), "\n")
```

## 5. Build TimePoints object for statgenHTP

```{r make-timepoints}
single_time <- plot_data %>%
  mutate(
    plotId = as.character(plotId),
    Rep = as.character(Rep),
    Plot_Row = as.numeric(Plot_Row),
    Plot_Column = as.numeric(Plot_Column),
    time = as.POSIXct("2025-01-15 10:00:00")
  )

tp_data <- createTimePoints(
  dat = single_time,
  experimentName = environment_name,
  genotype = "genotype",
  timePoint = "time",
  plotId = "plotId",
  repId = "Rep",
  rowNum = "Plot_Row",
  colNum = "Plot_Column",
  addCheck = FALSE
)

summary(tp_data)
```

## 6. Fit SpATS per phenotype and extract corrected values

```{r fit-all-phenotypes, results='hide'}
corrected_list <- list()
fit_info <- list()
all_models <- list()

for (phen in usable_phenotypes) {
  message("Fitting SpATS model for: ", phen)
  
  no_nas <- single_time %>%
    filter(!is.na(.data[[phen]]))
  
  if (nrow(no_nas) < 10) {
    message("Insufficient data for ", phen, " (n=", nrow(no_nas), ")")
    next
  }
  
  fit_try <- try(
    fitModels(
      TP = tp_data,
      trait = phen,
      extraFixedFactors = c("repId"),
      timePoints = 1,
      what = "fixed"
    ),
    silent = TRUE
  )
  
  if (inherits(fit_try, "try-error")) {
    message("Fit failed for ", phen, ": ", fit_try)
    next
  }
  
  all_models[[phen]] <- fit_try
  
  corr <- try(getCorrected(fit_try), silent = TRUE)
  if (inherits(corr, "try-error") || is.null(corr)) {
    message("getCorrected() failed for ", phen)
    next
  }
  
  corr <- corr %>%
    select(-phen)
  
  corrected_list[[phen]] <- corr
  fit_info[[phen]] <- list(n_obs = nrow(no_nas), status = "success")
}

if (length(corrected_list) > 0) {
  sp_corrected <- lapply(
    corrected_list,
    function(corr_df) {
      corr_df %>%
        select(timeNumber, timePoint, genotype, repId, rowId, colId, plotId)
    }
  ) %>%
    bind_rows() %>%
    arrange(plotId) %>%
    distinct()
  
  for (phen in names(corrected_list)) {
    phen_corr <- paste0(phen, "_corr")
    corr_df <- corrected_list[[phen]] %>%
      select(plotId, all_of(phen_corr))
    sp_corrected <- left_join(sp_corrected, corr_df, by = "plotId")
  }
  
  colnames(sp_corrected) <- gsub("_corr", "", colnames(sp_corrected))
  
  sp_corrected <- sp_corrected %>%
    separate(genotype, c("donor", "genotype"))
  
  cat("Final sp_corrected dimensions:", dim(sp_corrected), "\n")
  cat("Corrected traits:", 
      paste(intersect(usable_phenotypes, colnames(sp_corrected)), 
            collapse = ", "), "\n")
  print(head(sp_corrected))
  
} else {
  message("No models were successfully fitted.")
}
```

## 7. Spatial correction visualization

```{r spats-visualization}
for (trait in usable_phenotypes) {
  if (trait %in% names(all_models)) {
    cat("\n### Spatial plots for", trait, "\n")
    
    plot(all_models[[trait]], timePoints = 1)
    
    plot(all_models[[trait]], 
         timePoints = 1,
         plotType = "spatial",
         spaTrend = "raw")
  }
}
```

## 8. Donor-specific second-stage analysis: Spatially corrected effects

```{r second-stage-analysis}
if (exists("sp_corrected") && nrow(sp_corrected) > 0) {
  
  corrected_phenotypes <- intersect(usable_phenotypes, colnames(sp_corrected))
  
  if (length(corrected_phenotypes) > 0) {
    
    comparison_genotypes <- unique(sp_corrected$genotype)
    cat("Available genotypes:", paste(comparison_genotypes, collapse = ", "), "\n")
    
    donors <- unique(sp_corrected$donor)
    cat("Available donors:", paste(donors, collapse = ", "), "\n")
    
    htest <- sp_corrected %>% 
      pivot_longer(
        cols = all_of(corrected_phenotypes), 
        names_to = "trait", 
        values_to = "value"
      ) %>%
      filter(!is.na(value)) %>%
      group_by(donor, trait) %>%
      filter(n_distinct(genotype) == 2) %>%
      t_test(value ~ genotype) %>%
      adjust_pvalue(method = "fdr") %>%
      add_y_position(scales = "free") %>%
      add_significance()
    
    print(htest)
    
    pheno_theme2 <- theme_classic2(base_size = 20) +
      theme(
        plot.title = element_markdown(hjust = 0.5, face = "bold"),
        axis.title.y = element_markdown(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 25, face = "bold", color = "black"),
        strip.background = element_blank(),
        strip.text = element_markdown(size = 20),
        legend.position = "none"
      )
    
    for (current_donor in donors) {
      cat("\n=== Processing donor:", current_donor, "===\n")
      
      alpha <- 0.05
      sig_traits_donor <- htest %>%
        filter(donor == current_donor, p.adj < alpha) %>%
        arrange(p.adj) %>%
        pull(trait)
      
      cat("Significant traits for", current_donor, "(FDR < 0.05):", 
          paste(sig_traits_donor, collapse = ", "), "\n")
      
      if (length(sig_traits_donor) == 0) {
        cat("No traits significant after FDR correction for donor", 
            current_donor, "\n")
        next
      }
      
      plot_data_donor <- sp_corrected %>%
        filter(donor == current_donor) %>%
        pivot_longer(
          cols = all_of(corrected_phenotypes),
          names_to = "trait",
          values_to = "value"
        ) %>%
        filter(trait %in% sig_traits_donor, !is.na(value)) %>%
        mutate(trait = as.character(trait))
      
      test_to_plot_donor <- htest %>%
        filter(donor == current_donor, trait %in% sig_traits_donor)
      
      n_traits <- length(sig_traits_donor)
      ncol_facets <- min(4, n_traits)
      
      diff_plot <- ggplot(plot_data_donor, 
                         aes(x = genotype, y = value, color = genotype)) +
        geom_boxplot(width = 0.25, linewidth = 1.5, alpha = 0) +
        geom_quasirandom(size = 2) +
        scale_color_manual(values = c("CTRL" = "gold", "INV4M" = "purple4")) +
        labs(
          title = paste("CLY25: ", current_donor, 
                       " Spatially Corrected (FDR-Adjusted)"),
          y = "Corrected Value",
          x = "Genotype"
        ) +
        stat_pvalue_manual(
          test_to_plot_donor,
          tip.length = 0.01,
          step.height = 0.08,
          size = 10,
          bracket.size = 0.8
        ) +
        scale_y_continuous(expand = expansion(mult = c(0.1, 0.15))) +
        facet_wrap(~ factor(trait, levels = sig_traits_donor), 
                   scales = "free_y", 
                   ncol = ncol_facets) +
        pheno_theme2
      
      print(diff_plot)
      
      cat("\n--- Summary for", current_donor, "---\n")
      summary_stats <- plot_data_donor %>%
        group_by(trait, genotype) %>%
        summarise(
          n = n(),
          mean = round(mean(value, na.rm = TRUE), 3),
          sd = round(sd(value, na.rm = TRUE), 3),
          .groups = "drop"
        ) %>%
        pivot_wider(
          names_from = genotype,
          values_from = c(n, mean, sd),
          names_sep = "_"
        )
      
      print(summary_stats)
    }
    
    cat("\n=== Overall Summary Across All Donors ===\n")
    overall_sig <- htest %>%
      filter(p.adj < alpha) %>%
      group_by(trait) %>%
      summarise(
        n_donors_significant = n(),
        min_pvalue = min(p.adj),
        max_pvalue = max(p.adj),
        .groups = "drop"
      ) %>%
      arrange(desc(n_donors_significant), min_pvalue)
    
    print(overall_sig)
    
  } else {
    message("No corrected phenotypes available for analysis")
  }
} else {
  message("No spatially corrected data available")
}
```

## 9. Statistical comparisons and visualization for CLY2025

```{r statistical-comparisons, fig.width=14, fig.height=8}
if (exists("sp_corrected") && nrow(sp_corrected) > 0) {
  
  corrected_phenotypes <- intersect(c("PH", "DTA", "DTS", "GDDA", "GDDS"), 
                                   colnames(sp_corrected))
  
  comparison_genotypes <- unique(sp_corrected$genotype)
  cat("Available genotypes:", paste(comparison_genotypes, collapse = ", "), "\n")
  donors <- unique(sp_corrected$donor)
  cat("Available donors:", paste(donors, collapse = ", "), "\n")
  
  htest <- sp_corrected %>% 
    pivot_longer(
      cols = all_of(corrected_phenotypes), 
      names_to = "trait", 
      values_to = "value"
    ) %>%
    filter(!is.na(value)) %>%
    group_by(donor, trait) %>%
    filter(n_distinct(genotype) == 2) %>%
    t_test(value ~ genotype) %>%
    adjust_pvalue(method = "fdr") %>%
    add_y_position(scales = "free") %>%
    add_significance()
  
  print(htest)
  
  pheno_theme2 <- theme_classic2(base_size = 22) +
    theme(
      plot.title = element_markdown(hjust = 0.5, face = "bold"),
      axis.title.y = element_markdown(),
      axis.title.x = element_blank(),
      axis.text.x = element_text(size = 16, face = "bold", color = "black"),
      strip.background = element_blank(),
      strip.text = element_markdown(size = 18, face = "bold"),
      legend.position = "none"
    )
  
  trait_plots <- list()
  
  for (current_trait in corrected_phenotypes) {
    cat("\n=== Processing trait:", current_trait, "===\n")
    
    plot_data_trait <- sp_corrected %>%
      select(donor, genotype, all_of(current_trait)) %>%
      rename(value = all_of(current_trait)) %>%
      filter(!is.na(value))
    
    test_to_plot_trait <- htest %>%
      filter(trait == current_trait)
    
    trait_plot <- ggplot(plot_data_trait, 
                        aes(x = genotype, y = value, color = genotype)) +
      geom_boxplot(width = 0.25, linewidth = 1.5, alpha = 0) +
      geom_quasirandom(size = 2.5) +
      scale_color_manual(values = c("CTRL" = "gold", "INV4M" = "purple4")) +
      labs(
        title = current_trait,
        y = paste("Corrected", current_trait),
        x = "Genotype"
      ) +
      stat_pvalue_manual(
        test_to_plot_trait,
        tip.length = 0.01,
        step.height = 0.08,
        size = 8,
        bracket.size = 0.8
      ) +
      scale_y_continuous(expand = expansion(mult = c(0.1, 0.15))) +
      facet_wrap(~ donor, ncol = 2) +
      pheno_theme2
    
    trait_plots[[current_trait]] <- trait_plot
    
    cat("\n--- Summary for", current_trait, "---\n")
    summary_stats_trait <- plot_data_trait %>%
      group_by(donor, genotype) %>%
      summarise(
        n = n(),
        mean = round(mean(value, na.rm = TRUE), 3),
        sd = round(sd(value, na.rm = TRUE), 3),
        .groups = "drop"
      ) %>%
      pivot_wider(
        names_from = genotype,
        values_from = c(n, mean, sd),
        names_sep = "_"
      )
    
    print(summary_stats_trait)
    
    sig_results_trait <- test_to_plot_trait %>%
      select(donor, statistic, p, p.adj, p.adj.signif) %>%
      arrange(p.adj)
    
    cat("Statistical test results for", current_trait, ":\n")
    print(sig_results_trait)
  }
  
  if (length(trait_plots) > 0) {
    cat("\n=== Creating combined plot ===\n")
    
    ncol_arrange <- min(3, length(trait_plots))
    nrow_arrange <- ceiling(length(trait_plots) / ncol_arrange)
    
    combined_plot <- ggarrange(
      plotlist = trait_plots[c("DTA","DTS", "PH","GDDA","GDDS")],
      ncol = ncol_arrange,
      nrow = nrow_arrange,
      common.legend = TRUE,
      legend = "bottom"
    ) %>%
      annotate_figure(
        top = text_grob("CLY2025 — Spatially Corrected Phenotypes", 
                       color = "black", 
                       face = "bold", 
                       size = 18)
      )
    
    print(combined_plot)
  }
  
  cat("\n=== Overall Summary ===\n")
  alpha <- 0.05
  overall_sig <- htest %>%
    mutate(significant = p.adj < alpha) %>%
    group_by(trait) %>%
    summarise(
      n_donors_tested = n(),
      n_donors_significant = sum(significant),
      min_pvalue = min(p.adj),
      max_pvalue = max(p.adj),
      .groups = "drop"
    ) %>%
    arrange(desc(n_donors_significant), min_pvalue)
  
  print(overall_sig)
  
} else {
  message("No spatially corrected data available for CLY2025")
}
```

## 10. Summary and export

```{r summary-export}
cat("\n=== Analysis Summary ===\n")
cat("Total phenotypes evaluated:", length(all_traits), "\n")
cat("Usable phenotypes (<50% missing):", length(usable_phenotypes), "\n")
cat("Successfully fitted models:", length(all_models), "\n")

if (exists("sp_corrected") && nrow(sp_corrected) > 0) {
  cat("Plots with corrected data:", nrow(sp_corrected), "\n")
  
  output_file <- paste0(environment_name, "_spatially_corrected_phenotypes.csv")
  write_csv(sp_corrected, output_file)
  cat("Spatially corrected data exported to:", output_file, "\n")
} else {
  cat("No corrected data to export\n")
}

if (length(fit_info) > 0) {
  cat("\n=== Model Fit Details ===\n")
  for (trait in names(fit_info)) {
    info <- fit_info[[trait]]
    cat(sprintf("%s: n=%d, status=%s\n", trait, info$n_obs, info$status))
  }
}
```

## 11. Consolidated visualization across all donors
```{r consolidated-plot, fig.width=14, fig.height=24}
if (exists("sp_corrected") && nrow(sp_corrected) > 0) {
  
corrected_phenotypes <- intersect(usable_phenotypes, colnames(sp_corrected))
corrected_phenotypes <- c("DTA", "DTS",
                          "GDDA","GDDS",
                         "PH","EBA",
                         "BW","BL",
                         "LAE","EN")
  if (length(corrected_phenotypes) > 0) {
    
    comparison_genotypes <- unique(sp_corrected$genotype)
    cat("Available genotypes:", paste(comparison_genotypes, collapse = ", "), "\n")
    
    donors <- unique(sp_corrected$donor)
    cat("Available donors:", paste(donors, collapse = ", "), "\n")
    
    htest <- sp_corrected %>% 
      pivot_longer(
        cols = all_of(corrected_phenotypes), 
        names_to = "trait", 
        values_to = "value"
      ) %>%
      filter(!is.na(value)) %>%
      group_by(donor, trait) %>%
      filter(n_distinct(genotype) == 2) %>%
      t_test(value ~ genotype) %>%
      adjust_pvalue(method = "fdr") %>%
      add_y_position(scales = "free") %>%
      add_significance()
    
    print(htest)
    
    pheno_theme2 <- theme_classic2(base_size = 22) +
      theme(
        plot.title = element_markdown(hjust = 0.5, face = "bold"),
        axis.title.y = element_markdown(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 18, face = "bold", color = "black"),
        strip.background = element_blank(),
        strip.text = element_markdown(size = 18, face = "bold"),
        legend.position = "none"
      )
    
    trait_plots <- list()
    
    for (current_trait in corrected_phenotypes) {
      cat("\n=== Processing trait:", current_trait, "===\n")
      
      plot_data_trait <- sp_corrected %>%
        select(donor, genotype, all_of(current_trait)) %>%
        rename(value = all_of(current_trait)) %>%
        filter(!is.na(value))
      
      test_to_plot_trait <- htest %>%
        filter(trait == current_trait)
      
      trait_plot <- ggplot(plot_data_trait, 
                          aes(x = genotype, y = value, color = genotype)) +
        geom_boxplot(width = 0.25, linewidth = 1.5, alpha = 0) +
        geom_quasirandom(size = 2.5) +
        scale_color_manual(values = c("CTRL" = "gold", "INV4M" = "purple4")) +
        labs(
          title = current_trait,
          y = paste("Corrected", current_trait),
          x = "Genotype"
        ) +
        stat_pvalue_manual(
          test_to_plot_trait,
          tip.length = 0.01,
          step.height = 0.08,
          size = 8,
          bracket.size = 0.8
        ) +
        scale_y_continuous(expand = expansion(mult = c(0.1, 0.15))) +
        facet_wrap(~ donor, ncol = 2) +
        pheno_theme2
      
      trait_plots[[current_trait]] <- trait_plot
      
      cat("\n--- Summary for", current_trait, "---\n")
      summary_stats_trait <- plot_data_trait %>%
        group_by(donor, genotype) %>%
        summarise(
          n = n(),
          mean = round(mean(value, na.rm = TRUE), 3),
          sd = round(sd(value, na.rm = TRUE), 3),
          .groups = "drop"
        ) %>%
        pivot_wider(
          names_from = genotype,
          values_from = c(n, mean, sd),
          names_sep = "_"
        )
      
      print(summary_stats_trait)
      
      sig_results_trait <- test_to_plot_trait %>%
        select(donor, statistic, p, p.adj, p.adj.signif) %>%
        arrange(p.adj)
      
      cat("Statistical test results for", current_trait, ":\n")
      print(sig_results_trait)
    }
    
    if (length(trait_plots) > 0) {
      cat("\n=== Creating combined plot ===\n")
      
      n_traits <- length(trait_plots)
      nrow_arrange <- ceiling(n_traits / 2)
      
      combined_plot <- ggarrange(
        plotlist = trait_plots,
        ncol = 2,
        nrow =  nrow_arrange,
        common.legend = TRUE,
        legend = "bottom"
      ) %>%
        annotate_figure(
          top = text_grob(paste(environment_name, 
                               "— Spatially Corrected Phenotypes"), 
                         color = "black", 
                         face = "bold", 
                         size = 18)
        )
      
      print(combined_plot)
    }
    
    cat("\n=== Overall Summary Across All Traits and Donors ===\n")
    alpha <- 0.05
    overall_sig <- htest %>%
      mutate(significant = p.adj < alpha) %>%
      group_by(trait) %>%
      summarise(
        n_donors_tested = n(),
        n_donors_significant = sum(significant),
        min_pvalue = min(p.adj),
        max_pvalue = max(p.adj),
        .groups = "drop"
      ) %>%
      arrange(desc(n_donors_significant), min_pvalue)
    
    print(overall_sig)
    
  } else {
    message("No corrected phenotypes available for analysis")
  }
} else {
  message("No spatially corrected data available")
}
```