---
title: "Lipid Differential Abundance Analysis"
author: "Maize Genetics Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: flatly
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

# Overview

**Purpose**: Identify differentially abundant lipids across leaf developmental 
stages and phosphorus treatments using total ion current (TIC) normalization.

**Approach**:
1. Filter lipids by missingness (<20% missing values)
2. Filter samples by total ion current (library size)
3. Normalize to molar ion fractions (TIC normalization)
4. Apply limma-voom for differential abundance analysis
5. Model spatial and technical covariates

**Experimental factors**:
- **Leaf tissue position**: Continuous gradient (leaf 1-4)
- **Phosphorus treatment**: High P (+P) vs Low P (-P)
- **Genotype**: Control (CTRL) vs Inversion 4m (INV4M)

**Effect size thresholds**:
- Leaf predictors: |logFC| > 0.5
- Categorical predictors: |logFC| > 1.5

# Libraries
```{r libraries}
library(edgeR)
library(ggplot2)
library(limma)
library(dplyr)
library(tidyr)
library(forcats)
library(ggrepel)
library(ggpubr)
library(cowplot)
library(ggtext)
```

# Data Loading

## Define Exclusions

**Purpose**: Remove internal standards and odd-chain lipids from analysis.
```{r define_exclusions}
internal_standards <- c( 
  "CUDA", "LPE_17_1", "Sphingosine_17_1", "PC_25_0", "DG_18_1",
  "PG_34_0", "DG_12_0", "TG_17_0", "LPC_17_0", "PE_34", "Cholesterol"
)

odd_carbon <- c("PG_17_0", "SM_35_1", "TG_57_6")
to_exclude <- c(internal_standards, odd_carbon)
```

## Load Raw MS Data

**Purpose**: Load MS-DIAL peak areas with internal standard integration.
```{r load_lipid_data}
lipid_csv <- "../data/PSU_RawData_MSDial_NewStdInt_240422.csv"

raw <- read.csv(lipid_csv, na.strings = c("", "#N/A", "NA", "Inf")) %>%
  select(-all_of(to_exclude[to_exclude %in% colnames(.)])) %>%
  filter(!grepl("Methanol|Pool", sampleID))

cat("Loaded samples:", nrow(raw), "\n")
```

## Load Sample Metadata

**Purpose**: Merge phenotypic data with RNA-seq metadata and MS injection order.
```{r load_metadata}
plant_csv <- "/Users/fvrodriguez/Desktop/Desktop/22_NCS_PSU_LANGEBIO_FIELDS_PSU_P_field.csv"

psu <- read.csv(plant_csv) %>%
  dplyr::rename(Genotype = "Who.What", rowid = "P22.") %>%
  filter(Genotype %in% c("CTRL", "INV4M")) %>%
  droplevels()

sampleInfo <- read.csv('../data/inv4mRNAseq_metadata.csv') %>%
  dplyr::rename(Genotype = genotype, rowid = row)

sampleInfo <- psu %>%
  select(rowid, Rep, Plot_Row, Plot_Column, DTA, DTS) %>%
  inner_join(sampleInfo) %>%
  filter(!is.na(DTA))

sampleInfo$leaf_group <- NA
sampleInfo$leaf_group[sampleInfo$leaf_tissue < 3] <- "apical"
sampleInfo$leaf_group[sampleInfo$leaf_tissue > 2] <- "basal"

sampleInfo$tube <- gsub("L|R", "S", sampleInfo$tube, perl = TRUE)

ms_order <- read.csv("../data/PSU-PHO22_ms_order.csv")
ms_order$tube <- gsub("L|R", "S", ms_order$top_tag, perl = TRUE)

sampleInfo <- sampleInfo %>%
  dplyr::right_join(ms_order) %>%
  distinct()

cat("Sample info loaded:", nrow(sampleInfo), "samples\n")
```

## Merge Lipid Data with Metadata

**Purpose**: Combine MS peak areas with sample metadata.
```{r merge_data}
raw$tube <- gsub(".*_|.raw", "", raw$sampleID, perl = TRUE)
raw$tube <- gsub("L|R", "S", raw$tube, perl = TRUE)

pheno <- sampleInfo %>%
  select(rowid, tube, Rep, Plot:Plot_Row, Treatment:leaf_tissue, 
         leaf_group, injection_order) %>%
  inner_join(raw %>% select(tube, DGDG_34_0:TG_58_5)) %>%
  mutate(
    block = as.factor(Rep),
    Treatment = factor(Treatment, levels = c("High_P", "Low_P"))
  ) %>%
  pivot_wider(
    names_from = Rep,
    values_from = Rep,
    names_prefix = "block_",
    values_fn = function(x) 1,
    values_fill = 0
  ) %>%
  select(rowid, tube:Plot_Row, block, block_6:block_12, 
         injection_order, everything())

levels(pheno$Treatment) <- c("+P", "-P")

cat("Final dataset:", nrow(pheno), "samples\n")
```

## Define Lipid Classifications

**Purpose**: Annotate lipids by head group and class for downstream analysis.
```{r lipid_classes}
m <- pheno %>%
  select(DGDG_34_0:TG_58_5) %>%
  as.matrix()

head_group <- c(
  DG = "neutral", DGDG = "glycolipid", DGGA = "glycolipid",
  LPC = "phospholipid", LPE = "phospholipid", MGDG = "glycolipid",
  PC = "phospholipid", PE = "phospholipid", PG = "phospholipid",
  PI = "phospholipid", SQDG = "glycolipid", TG = "neutral"
)

sp <- data.frame(
  colname = colnames(m),
  class = gsub("_.*", "", colnames(m), perl = TRUE)
)
sp$head_group <- head_group[sp$class]

cat("\nLipid class distribution:\n")
print(with(sp, table(head_group, class)))
```

# Quality Control

## Create Count Matrix

**Purpose**: Prepare lipid abundance matrix for filtering and normalization.
```{r create_count_matrix}
counts <- t(m)
colnames(counts) <- pheno$tube

cat("Count matrix dimensions:", dim(counts), "\n")
cat("Lipids:", nrow(counts), "\n")
cat("Samples:", ncol(counts), "\n")
```

## Raw Data Distribution
```{r raw_distribution}
hist(counts, 
     main = "Distribution of Raw Lipid Abundances", 
     xlab = "Peak Area", 
     breaks = 50,
     col = "lightblue")
```

## Missing Data Analysis

**Purpose**: Identify lipids with excessive missing values for removal.

**Approach**: Calculate proportion of missing/zero values per lipid and set 
threshold at 20%.
```{r missing_data_analysis}
missing_per_lipid <- rowSums(is.na(counts) | counts == 0) / ncol(counts)

cat("Missing data summary:\n")
print(summary(missing_per_lipid))

hist(missing_per_lipid * 100, 
     main = "Missing Data Distribution Across Lipids",
     xlab = "% Missing", 
     breaks = 30,
     col = "coral")
abline(v = 20, col = "red", lwd = 2, lty = 2)
```

## Filter Lipids by Missingness

**Purpose**: Remove lipids with >20% missing values across samples.
```{r filter_lipids}
missing_threshold <- 0.20
keep_lipids <- missing_per_lipid < missing_threshold

cat("Lipid filtering (< 20% missing):\n")
cat("  Before:", nrow(counts), "\n")
cat("  After:", sum(keep_lipids), "\n")
cat("  Removed:", sum(!keep_lipids), "\n")

counts_filtered <- counts[keep_lipids, ]
```

## Match Sample Metadata

**Purpose**: Ensure sample metadata matches filtered count matrix.
```{r match_metadata}
sampleNames <- colnames(counts_filtered)

sampleInfo_matched <- sampleInfo[match(sampleNames, sampleInfo$tube), ]

sampleInfo_matched$Treatment <- factor(
  pheno$Treatment[match(sampleInfo_matched$tube, pheno$tube)],
  levels = c("+P", "-P")
)

cat("Treatment levels:\n")
print(table(sampleInfo_matched$Treatment))
```

## Library Size Diagnostics

**Purpose**: Identify samples with insufficient total ion current for removal.

**Approach**: Calculate total peak area per sample (library size) and visualize 
distribution to determine filtering threshold.
```{r library_size_diagnostics}
genes <- data.frame(gene = rownames(counts_filtered))

y_raw <- DGEList(counts = counts_filtered, samples = sampleInfo_matched)
y_raw$group <- interaction(y_raw$samples$Treatment, y_raw$samples$Genotype)

cat("Library size summary (before filtering):\n")
print(summary(y_raw$samples$lib.size))

hist(
  y_raw$samples$lib.size / 1e6,
  main = "Library Size Distribution",
  xlab = "Total Ion Current (millions)",
  breaks = 30,
  col = "lightgreen"
)

lib_size_threshold <- quantile(y_raw$samples$lib.size, 0.10)
abline(v = lib_size_threshold / 1e6, col = "red", lwd = 2, lty = 2)

cat("Suggested threshold (10th percentile):", lib_size_threshold, "\n")
```

## Filter Samples by Library Size

**Purpose**: Remove samples with low total ion current that may compromise 
data quality.

**Expected outcome**: Retain samples with sufficient signal for reliable 
quantification.
```{r filter_samples}
# min_lib_size <- 3e10
min_lib_size <- 1

keep_samples <- y_raw$samples$lib.size >= min_lib_size

cat("Sample filtering (TIC >=", min_lib_size, "):\n")
cat("  Before:", ncol(counts_filtered), "\n")
cat("  After:", sum(keep_samples), "\n")
cat("  Removed:", sum(!keep_samples), "\n")

if (sum(!keep_samples) > 0) {
  cat("\nRemoved samples:\n")
  print(y_raw$samples[!keep_samples, 
                       c("tube", "lib.size", "Treatment", 
                         "Genotype", "leaf_tissue")])
}

y <- y_raw[, keep_samples]
y$samples <- droplevels(y$samples)
```

## MDS: Library Size Quality Control

**Purpose**: Visualize sample relationships colored by library size to assess 
filtering quality.
```{r mds_qc, fig.width=10, fig.height=8}
mds_all <- plotMDS(y_raw, plot = FALSE)

mds_qc_data <- y_raw$samples %>%
  mutate(
    dim1 = mds_all$x,
    dim2 = mds_all$y,
    lib_size = lib.size / 1e6,
    filtered_out = !keep_samples
  )

ggplot(mds_qc_data, 
       aes(x = dim1, y = dim2, 
           color = lib_size, 
           shape = filtered_out)) +
  geom_point(size = 4) +
  scale_color_viridis_c(option = "plasma") +
  scale_shape_manual(
    values = c("TRUE" = 4, "FALSE" = 19),
    labels = c("Kept", "Removed")
  ) +
  labs(
    x = paste0("Dim1 (", round(100 * mds_all$var.explained[1]), "%)"),
    y = paste0("Dim2 (", round(100 * mds_all$var.explained[2]), "%)"),
    color = "Library Size\n(millions)",
    shape = "Sample Status",
    title = "MDS: Library Size Quality Control"
  ) +
  theme_classic(base_size = 15)
```

## MDS: Injection Order Effect

**Purpose**: Assess technical drift associated with MS injection order.
```{r mds_injection, fig.width=10, fig.height=8}
mds12_qc <- ggplot(mds_qc_data %>% filter(!filtered_out), 
       aes(x = dim1, y = dim2, 
           fill = injection_order, 
           shape = Treatment)) +
  geom_point(size = 4, color ="transparent") +
  scale_fill_viridis_c(option = "plasma") +
  scale_shape_manual(values = c(21, 25)) +
  labs(
    x = paste0("dim1 (", round(100 * mds_all$var.explained[1]), "%)"),
    y = paste0("dim2 (", round(100 * mds_all$var.explained[2]), "%)"),
    # color = "Injection Order",
   # title = "MDS: Injection Order Effect"
  ) +
    guides(
    fill = guide_colourbar(
      title="Mass Spectrometry Injection Order",
      direction = "horizontal",
      barwidth = 15, 
      barheight = 1, 
      title.position = "top", 
      title.hjust = 0.5),
    shape = guide_legend(
      title = "Treatment",
      override.aes = list(fill = "black"),
      reverse=TRUE)
    ) +
  coord_equal()+ 
  theme_classic(base_size = 15) +
  theme(legend.position = "top")
cor(mds_qc_data$dim1, mds_qc_data$injection_order, use="complete.obs")
cor.test(mds_qc_data$dim1, mds_qc_data$injection_order, use="complete.obs")

print(mds12_qc)
```

# Total Ion Current Normalization

## Calculate Molar Ion Fractions

**Purpose**: Normalize lipid abundances to total ion current (TIC), converting 
raw peak areas to molar ion fractions.

**Approach**: For each sample, divide each lipid's peak area by the total peak 
area. This accounts for differences in total signal between samples and 
expresses abundances as proportions.

**Expected outcome**: Molar ion fractions sum to 1.0 per sample, representing 
each lipid's proportion of the total detected lipid pool.
```{r calculate_ion}
cat("=== Calculating Molar Ion Fractions ===\n")

raw_counts <- y$counts

molar_ion_fractions <- sweep(raw_counts, 2, colSums(raw_counts), FUN = "/")

cat("Molar ion fraction range:", range(molar_ion_fractions), "\n")
cat("Sample sums (should be 1):", 
    unique(round(colSums(molar_ion_fractions), 10)), "\n")
```

## Scale for Voom

**Purpose**: Convert molar ion fractions to count-like scale for voom 
transformation.

**Approach**: Multiply fractions by 1e9 to create numerically stable values 
that voom can process while maintaining the TIC normalization.
```{r scale_ion}
scaled_fractions <- molar_ion_fractions * 1e9

y_ion <- DGEList(counts = scaled_fractions, samples = y$samples)
y_ion$samples$norm.factors <- 1

cat("Scaled molar ion fractions created\n")
cat("Library size summary (should be ~1e9):\n")
print(summary(y_ion$samples$lib.size))
```


# Lipid Class Composition

```{r, lipid_composition, fig.height=10}


## Calculate class-level abundances from normalized data

# Extract normalized counts (ion fraction scaled)

# Create metadata for normalized samples
norm_metadata <- y$samples %>%
  dplyr::filter(tube %in% colnames(scaled_fractions))

# Transpose normalized counts and merge with lipid annotations
lipid_abundance <- scaled_fractions %>%
  t() %>%
  as.data.frame() %>%
  dplyr::mutate(tube = rownames(.)) %>%
  tidyr::pivot_longer(
    cols = -tube,
    names_to = "response",
    values_to = "abundance"
  ) %>%
  dplyr::inner_join(sp, by = c("response" = "colname")) %>%
  dplyr::inner_join(norm_metadata, by = "tube")

# Get classes by head group from sp annotation
classes_by_headgroup <- sp %>%
  dplyr::select(class, head_group) %>%
  dplyr::distinct() %>%
  dplyr::arrange(head_group, class)

# Order classes by head group for consistent display
class_order <- classes_by_headgroup %>%
  dplyr::pull(class)

# Define custom green to orange palette for leaf positions
green_to_orange <- c(
  "#00954A",  # Spanish Green (Leaf 1)
  "#A4DF56",  # Inchworm (Leaf 2)
  "#D7E23C",  # Pear (Leaf 3)
  "#FF9A1F"   # Crayola's Bright Yellow/Orange (Leaf 4)
)

## Plot 1: Mean composition by Leaf position - grouped bars by leaf within each class

leaf_composition <- lipid_abundance %>%
  dplyr::group_by(tube, Treatment, leaf_tissue, class) %>%
  dplyr::summarise(class_sum = sum(abundance), .groups = "drop") %>%
  dplyr::group_by(tube, Treatment, leaf_tissue) %>%
  dplyr::mutate(class_pct = 100 * class_sum / sum(class_sum)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(Treatment, leaf_tissue, class) %>%
  dplyr::summarise(
    mean_pct = mean(class_pct),
    se_pct = sd(class_pct) / sqrt(n()),
    .groups = "drop"
  )

leaf_composition$class <- factor(leaf_composition$class, levels = class_order)

# Create leaf position factor
leaf_composition <- leaf_composition %>%
  dplyr::mutate(
    leaf_position = factor(
      leaf_tissue,
      levels = c(1, 2, 3, 4),
      labels = c("1", "2", "3", "4")
    )
  )

# Add head group for faceting
leaf_composition <- leaf_composition %>%
  dplyr::inner_join(
    sp %>% dplyr::select(class, head_group) %>% dplyr::distinct(),
    by = "class"
  )

# Plot with lipid classes on x-axis, grouped by leaf position, log Y-scale
plot1_composition <- leaf_composition %>%
  ggplot(aes(x = class, y = mean_pct, fill = leaf_position)) +
  geom_col(color = "black", linewidth = 0.2, position = position_dodge(width = 0.9)) +
  geom_errorbar(
    aes(ymin = mean_pct - se_pct, ymax = mean_pct + se_pct),
    position = position_dodge(width = 0.9),
    width = 0.25,
    linewidth = 0.5
  ) +
  scale_fill_manual(
    name = "Leaf",
    values = green_to_orange
  ) +
  scale_y_log10(
    breaks = c(0.05, 0.1, 0.2, 0.5, 1, 2, 5, 10, 20, 40),
    labels = c("0.05", "0.1", "0.2", "0.5", "1", "2", "5", "10", "20", "40")
  ) +
  labs(
    y = "Ion %"
  ) +
  facet_grid(rows = vars(Treatment), cols = vars(head_group), 
             scales = "free_x", space = "free_x") +
  theme_classic2(base_size = 14) +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 13, face = "bold"),
    strip.background = element_blank(),
    strip.text.x = element_text(angle = 0, size = 25, face = "bold"),
    strip.text.y = element_text(angle = 0, size = 25, face = "bold"),
    legend.position = "none"
  )

## Plot 2: Treatment effect (-P vs +P) by leaf stage

# Calculate mean and SE per Treatment-Leaf-Class
class_abundance_summary <- lipid_abundance %>%
  dplyr::group_by(tube, Treatment, leaf_tissue, class) %>%
  dplyr::summarise(class_sum = sum(abundance), .groups = "drop") %>%
  dplyr::group_by(Treatment, leaf_tissue, class) %>%
  dplyr::summarise(
    mean_abundance = mean(class_sum),
    se_abundance = sd(class_sum) / sqrt(n()),
    n_samples = n(),
    .groups = "drop"
  )

# Pivot to get +P and -P side by side
treatment_comparison <- class_abundance_summary %>%
  tidyr::pivot_wider(
    names_from = Treatment,
    values_from = c(mean_abundance, se_abundance, n_samples)
  ) %>%
  dplyr::mutate(
    # Calculate log2 fold change: log2(-P / +P)
    log2fc = log2(`mean_abundance_-P` / `mean_abundance_+P`),
    
    # Propagate error using delta method
    # For log2(Y/X): SE ≈ 1/ln(2) × sqrt((SE_Y/Y)^2 + (SE_X/X)^2)
    se_log2fc = (1/log(2)) * sqrt(
      (`se_abundance_-P` / `mean_abundance_-P`)^2 + 
      (`se_abundance_+P` / `mean_abundance_+P`)^2
    )
  ) %>%
  dplyr::mutate(
    leaf_position = factor(
      leaf_tissue,
      levels = c(1, 2, 3, 4),
      labels = c("1", "2", "3", "4")
    )
  )

treatment_comparison$class <- factor(
  treatment_comparison$class, 
  levels = class_order
)

# Add head group
treatment_comparison <- treatment_comparison %>%
  dplyr::inner_join(
    sp %>% dplyr::select(class, head_group) %>% dplyr::distinct(),
    by = "class"
  )

# Plot treatment effect
plot2_treatment_effect <- treatment_comparison %>%
  ggplot(aes(x = class, y = log2fc, fill = leaf_position)) +
  geom_col(color = "black", linewidth = 0.2, position = position_dodge(width = 0.9)) +
  geom_errorbar(
    aes(ymin = log2fc - se_log2fc, ymax = log2fc + se_log2fc),
    position = position_dodge(width = 0.9),
    width = 0.25,
    linewidth = 0.5
  ) +
  scale_fill_manual(
    name = "Leaf",
    values = green_to_orange
  ) +
  labs(
    y = expression(log[2]~"FC (-P / +P)")
  ) +
  facet_grid(cols = vars(head_group), scales = "free_x", space = "free_x") +
  theme_classic2(base_size = 14) +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 13, face = "bold"),
    strip.background = element_blank(),
    strip.text.x = element_blank(),
  )


## Plot 3: Relative change with paired fold changes per plant

# Get sample-level abundances with plant ID
class_abundance_samples <- lipid_abundance %>%
  dplyr::group_by(tube, NCSU_RNA_plant, Treatment, leaf_tissue, class) %>%
  dplyr::summarise(class_sum = sum(abundance), .groups = "drop")

# Pivot wide to get all leaves per plant
class_abundance_wide <- class_abundance_samples %>%
  dplyr::select(-tube) %>%
  tidyr::pivot_wider(
    names_from = leaf_tissue,
    values_from = class_sum,
    names_prefix = "leaf_"
  )

# Fill missing values with treatment-class mean for that leaf
class_abundance_filled <- class_abundance_wide %>%
  dplyr::group_by(Treatment, class) %>%
  dplyr::mutate(
    leaf_1 = ifelse(is.na(leaf_1), mean(leaf_1, na.rm = TRUE), leaf_1),
    leaf_2 = ifelse(is.na(leaf_2), mean(leaf_2, na.rm = TRUE), leaf_2),
    leaf_3 = ifelse(is.na(leaf_3), mean(leaf_3, na.rm = TRUE), leaf_3),
    leaf_4 = ifelse(is.na(leaf_4), mean(leaf_4, na.rm = TRUE), leaf_4)
  ) %>%
  dplyr::ungroup()

# Calculate log2 fold change per plant (keeping leaf 1 = 0 for symmetry)
class_relative_per_plant <- class_abundance_filled %>%
  dplyr::mutate(
    leaf1_log2fc = 0,
    leaf2_log2fc = log2(leaf_2 / leaf_1),
    leaf3_log2fc = log2(leaf_3 / leaf_1),
    leaf4_log2fc = log2(leaf_4 / leaf_1)
  ) %>%
  dplyr::select(NCSU_RNA_plant, Treatment, class, 
                leaf1_log2fc, leaf2_log2fc, leaf3_log2fc, leaf4_log2fc) %>%
  tidyr::pivot_longer(
    cols = starts_with("leaf"),
    names_to = "leaf_position",
    values_to = "log2fc"
  )

# Calculate mean and SE
class_leaf_ratio_treatment <- class_relative_per_plant %>%
  dplyr::group_by(Treatment, leaf_position, class) %>%
  dplyr::summarise(
    mean_log2fc = mean(log2fc, na.rm = TRUE),
    se_log2fc = sd(log2fc, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  dplyr::mutate(
    leaf_position = factor(
      leaf_position,
      levels = c("leaf1_log2fc", "leaf2_log2fc", "leaf3_log2fc", "leaf4_log2fc"),
      labels = c("1", "2", "3", "4")
    )
  )

class_leaf_ratio_treatment$class <- factor(
  class_leaf_ratio_treatment$class, 
  levels = class_order
)

# Add head group
class_leaf_ratio_treatment <- class_leaf_ratio_treatment %>%
  dplyr::inner_join(
    sp %>% dplyr::select(class, head_group) %>% dplyr::distinct(),
    by = "class"
  )

# Plot with log2FC
plot3_leaf_relative <- class_leaf_ratio_treatment %>%
  ggplot(aes(x = class, y = mean_log2fc, fill = leaf_position)) +
  geom_col(color = "black", linewidth = 0.2, position = position_dodge(width = 0.9)) +
  geom_errorbar(
    aes(ymin = mean_log2fc - se_log2fc, ymax = mean_log2fc + se_log2fc),
    position = position_dodge(width = 0.9),
    width = 0.25,
    linewidth = 0.5
  ) +
  scale_fill_manual(
    name = "Leaf",
    values = green_to_orange
  ) +
  labs(
    y = expression(log[2]~"FC vs Leaf 1")
  ) +
  facet_grid(rows = vars(Treatment), cols = vars(head_group), 
             scales = "free_x", space = "free_x") +
  theme_classic2(base_size = 14) +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 13, face = "bold"),
    strip.background = element_blank(),
    strip.text.x = element_blank(),
    strip.text.y = element_text(angle = 0, size = 25, face = "bold"),
    legend.position = "none"
  )


# Combine all three plots
final_combined <- plot_grid(
  plot1_composition,
  plot2_treatment_effect,
  plot3_leaf_relative,
  ncol = 1,
  labels = c("A", "B", "C"),
  label_size = 25,
  rel_heights = c(1, 0.5, 1),
  align = "v",
  axis = "lr"
)

# Save combined plot
ggsave(
  "~/Desktop/lipid_composition_combined_final.svg",
  final_combined,
  width = 10,
  height = 10,
  dpi = 150
)
cat("\nFinal combined plot created and saved\n")

print(final_combined)
```


# Multidimensional Scaling

## Compute MDS Dimensions

**Purpose**: Reduce dimensionality to visualize major sources of variation 
in lipid profiles.

**Approach**: Apply multidimensional scaling to TIC-normalized data, extracting 
first 4 dimensions.
```{r compute_mds}
mds <- plotMDS(y_ion, plot = FALSE)

d <- y_ion$samples
d$dim1 <- mds$x
d$dim2 <- mds$y
d$dim3 <- mds$eigen.vectors[, 3] * sqrt(mds$var.explained[3])
d$dim4 <- mds$eigen.vectors[, 4] * sqrt(mds$var.explained[4])

d$Treatment <- factor(d$Treatment)
d$Genotype <- factor(d$Genotype)

cat("Variance explained by MDS dimensions:\n")
print(tibble(
  dimension = paste("Dim", 1:4),
  var_explained = round(mds$var.explained[1:4], 4)
))
```

## MDS: Experimental Factors

**Purpose**: Identify which experimental and technical factors drive major 
axes of variation.
```{r mds_factors, fig.width=14, fig.height=10}
p1 <- ggplot(d, aes(x = dim2, y = dim3, color = Treatment)) +
  geom_point(size = 3)  +
  xlab(paste0("dim2 (", round(100 * mds$var.explained[2]), "%)")) +
  ylab(paste0("dim3 (", round(100 * mds$var.explained[3]), "%)")) +
  theme_classic(base_size = 15) 


p2 <- ggplot(d, aes(x = dim2, y = dim3,
                    color = injection_order)) +
  geom_point(size = 3) +
    scale_color_viridis_c(option = "plasma") +
  xlab(paste0("dim2 (", round(100 * mds$var.explained[2]), "%)")) +
  ylab(paste0("dim3 (", round(100 * mds$var.explained[3]), "%)")) +
  labs(color= "Injection\norder") +
  theme_classic(base_size = 15)  

p3 <- ggplot(d, aes(x = dim2, y = dim3, color = decimal_time)) +
  geom_point(size = 3) +
  scale_color_viridis_c(option = "plasma") +
  labs(color= "Collection\ntime")  +
  xlab(paste0("dim2 (", round(100 * mds$var.explained[2]), "%)")) +
  ylab(paste0("dim3 (", round(100 * mds$var.explained[3]), "%)")) +
  theme_classic(base_size = 15) 


p4 <- ggplot(d, aes(x = dim2, y = dim3, color = COLLECTOR)) +
  geom_point(size = 3) +
  scale_color_discrete(
    labels = c("Team 1", "Team 2")
  ) +
  theme_classic(base_size = 15)  +
  xlab(paste0("dim2 (", round(100 * mds$var.explained[2]), "%)")) +
  ylab(paste0("dim3 (", round(100 * mds$var.explained[3]), "%)")) +
  labs(color="Collector")

p5 <- ggplot(d, aes(x = dim2, y = dim3, color = Genotype)) +
  geom_point(size = 3) +
  theme_classic(base_size = 15)  +
  xlab(paste0("dim2 (", round(100 * mds$var.explained[2]), "%)")) +
  ylab(paste0("dim3 (", round(100 * mds$var.explained[3]), "%)")) +
  labs(color="Genotype")

p6 <- d %>%
  mutate(leaf = factor(leaf_tissue)) %>%
  ggplot(aes(x = dim2, y = dim3, color = leaf)) +
  scale_color_manual(values=green_to_orange)+
  geom_point(size = 3) +
  theme_classic(base_size = 15)  +
  xlab(paste0("dim2 (", round(100 * mds$var.explained[2]), "%)")) +
  ylab(paste0("dim3 (", round(100 * mds$var.explained[3]), "%)")) +
  labs(color = "Leaf")

mds_23_qc<- ggarrange(p1, p2, p3, p4, p5, p6, ncol = 2, nrow = 3)

sup_fig <- ggarrange(
  mds12_qc,
  mds_23_qc,
  nrow = 1,
  ncol=2, 
  widths = c(0.7,1),
  labels="AUTO",
  font.label = list(size = 25))

# Save combined plot
ggsave(
  "~/Desktop/sup_fig_7.png",
  sup_fig,
  width = 16,
  height = 9,
  dpi = 150
)

cat("\nFinal combined plot created and saved\n")

print(mds_23_qc)
```

## MDS: Primary Plot

**Purpose**: Publication-quality MDS showing main biological factors.
```{r mds_primary, fig.width=10, fig.height=8}
base_size <- 30

lipid_MDS_23 <- d %>%
  mutate(leaf = factor(leaf_tissue)) %>%
  ggplot(aes(x = dim2, y = dim3, fill = leaf, shape = Treatment)) +
  ggtitle("MDS Lipids") +
  xlab(paste0("dim2 (", round(100 * mds$var.explained[2]), "%)")) +
  ylab(paste0("dim3 (", round(100 * mds$var.explained[3]), "%)")) +
  geom_point(size = 4) +
  scale_fill_manual(values= green_to_orange) +
  scale_shape_manual(values = c(21, 25)) +
  guides(
    shape = guide_legend(
      title = element_blank(), 
      override.aes = list(fill = "black"),
      reverse=TRUE
    ),
    fill = guide_legend(
      title = "Leaf",
      order = 2,
      override.aes = list(geom = "point", shape = 22, size = 7)
    )
  ) +
  theme_classic2(base_size = base_size) +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_blank(),  # Remove x-axis labels
    axis.ticks.x = element_blank(), # Remove x-axis ticks
    axis.text.y = element_blank(),  # Remove y-axis labels
    axis.ticks.y = element_blank(),  # Remove y-axis ticks
    # legend.position = "left",
    legend.spacing = unit(0, "line"),
    legend.box.spacing = unit(0, "in"),
    legend.background = element_rect(fill = "transparent")
  )

saveRDS(lipid_MDS_23 , "../results/lipid_MDS_23.rds")

cat("MDS plots saved to output/\n")

print(lipid_MDS_23)
```

## MDS: Dimensions 3 and 4
```{r mds_34, fig.width=10, fig.height=8}
d %>%
  mutate(leaf = factor(leaf_tissue)) %>%
  ggplot(aes(x = dim3, y = dim4, fill = leaf, shape = Treatment)) +
  xlab(paste0("dim3 (", round(100 * mds$var.explained[3]), "%)")) +
  ylab(paste0("dim4 (", round(100 * mds$var.explained[4]), "%)")) +
  geom_point(size = 4) +
  scale_fill_manual(values = green_to_orange) +
  scale_shape_manual(values = c(21, 25)) +
  guides(
    shape = guide_legend(
      title = element_blank(), 
      override.aes = list(fill = "black")
    ),
    fill = guide_legend(
      title = "Leaf",
      order = 2,
      override.aes = list(geom = "point", shape = 22, size = 7, reverse = TRUE)
    )
  ) +
  theme_classic2(base_size = 25) +
  theme(
    legend.box = "horizontal",
    legend.position = c(0.9, 0.8),
    legend.text = element_markdown(),
    legend.spacing = unit(0, "line"),
    legend.box.spacing = unit(0, "line")
  )
```

## MDS Correlation Analysis

**Purpose**: Quantify relationships between MDS dimensions and experimental 
factors.
```{r mds_correlations}
mds_cor_results <- tibble(
  dimension = c("Dim2", "Dim3", "Dim4"),
  factor = c("Treatment", "Leaf tissue", "Leaf tissue"),
  correlation = c(
    cor(d$dim2, as.numeric(d$Treatment)),
    cor(d$dim3, as.numeric(d$leaf_tissue)),
    cor(d$dim4, as.numeric(d$leaf_tissue))
  ),
  p_value = c(
    cor.test(d$dim2, as.numeric(d$Treatment))$p.value,
    cor.test(d$dim3, d$leaf_tissue)$p.value,
    cor.test(d$dim4, d$leaf_tissue)$p.value
  )
) %>%
  mutate(
    adj_p_value = p.adjust(p_value, method = "fdr"),
    correlation = round(correlation, 3),
    p_value = signif(p_value, 3),
    adj_p_value = signif(adj_p_value, 3)
  )

print(mds_cor_results)
```

# Differential Abundance Analysis

## Design Matrix

**Purpose**: Construct design matrix incorporating biological factors and 
technical covariates.

**Approach**: Model includes:
- Spatial covariates: Plot_Row (field position)
- Technical covariate: injection_order (MS drift)
- Biological factors: leaf_tissue (centered), Treatment, Genotype
- Interactions: leaf_tissue × Treatment, Genotype × Treatment, 
  leaf_tissue × Genotype
```{r design_matrix}
d$Treatment <- factor(d$Treatment, levels = c("+P", "-P"))
d$leaf_tissue_c <- scale(d$leaf_tissue, center = TRUE, scale = FALSE)

design <- model.matrix(
  ~ Plot_Row + injection_order + leaf_tissue_c * Treatment + 
    Genotype * Treatment + leaf_tissue_c * Genotype,
  d
)

cat("Design matrix dimensions:", dim(design), "\n")
cat("\nCoefficients in model:\n")
print(colnames(design))
```

## Voom Transformation

**Purpose**: Model mean-variance relationship and calculate precision weights 
for linear modeling.

**Approach**: Apply voom without additional normalization since data is 
already TIC (Total Ion current) normalized.
```{r voom_transform, fig.width=10, fig.height=6}
voomR <- voom(y_ion, design = design, normalize.method = "none", plot = TRUE)

cat("Voom transformation complete\n")
```

## Estimate Block Correlation

**Purpose**: Account for within-block correlation from field design.

**Approach**: Define blocks as Treatment × Plot_Column interaction and 
estimate consensus correlation.
```{r block_correlation}
block <- interaction(d$Treatment, d$Plot_Column)

corfit <- duplicateCorrelation(voomR, design, block = block)

cat("Consensus correlation:", corfit$consensus.correlation, "\n")
```

## Fit Linear Model

**Purpose**: Fit linear model for each lipid accounting for block structure.
```{r fit_model}
fit <- lmFit(voomR, design, block = block, 
             correlation = corfit$consensus.correlation)

ebfit <- eBayes(fit)

cat("Model fitted:", nrow(fit$coefficients), "lipids ×", 
    ncol(fit$coefficients), "coefficients\n")

cat("\nSignificant lipids per coefficient (FDR < 0.05):\n")
print(colSums(abs(decideTests(ebfit))))
```

# Extract Results

## Extract Predictor Effects

**Purpose**: Extract differential abundance statistics for biological 
predictors of interest.
```{r extract_effects_function}
#' Extract differential expression results for specified predictors
#'
#' @param ebfit An eBayes fitted model object from limma
#' @param predictor_map Named vector mapping coefficient names to display names
#'
#' @return Data frame with DE results for all specified predictors
extract_predictor_effects <- function(ebfit, predictor_map) {
  coef_names <- colnames(coef(ebfit))
  coef_indices <- match(names(predictor_map), coef_names)
  
  if (any(is.na(coef_indices))) {
    missing <- names(predictor_map)[is.na(coef_indices)]
    stop("Coefficients not found: ", paste(missing, collapse = ", "),
         "\nAvailable: ", paste(coef_names, collapse = ", "))
  }
  
  result_list <- lapply(seq_along(coef_indices), function(i) {
    idx <- coef_indices[i]
    tt <- topTable(ebfit, coef = idx, sort.by = "none", n = Inf)
    
    crit_value <- qt(0.975, ebfit$df.residual + ebfit$df.prior)
    std_errors <- ebfit$stdev.unscaled[, idx] * sqrt(ebfit$s2.post)
    
    tt$upper <- tt$logFC + crit_value * std_errors
    tt$lower <- tt$logFC - crit_value * std_errors
    tt$predictor <- predictor_map[i]
    tt$response <- rownames(tt)
    tt$std_err <- std_errors
    tt
  })
  
  results <- do.call(rbind, result_list)
  rownames(results) <- NULL
  
  results %>%
    select(predictor, response, everything()) %>%
    arrange(adj.P.Val)
}
```

## Map Coefficients to Predictors
```{r extract_effects}
predictor_map <- c(
  "leaf_tissue_c" = "Leaf",
  "Treatment-P" = "-P",
  "leaf_tissue_c:Treatment-P" = "Leaf:-P"
)

cat("Available coefficients:\n")
print(colnames(coef(ebfit)))

effects_df <- extract_predictor_effects(ebfit, predictor_map)

cat("\nTotal tests:", nrow(effects_df), "\n")
cat("Tests per predictor:\n")
print(table(effects_df$predictor))
cat("\nSignificant per predictor (FDR < 0.05):\n")
print(table(effects_df$predictor[effects_df$adj.P.Val < 0.05]))
```

## Classify Differential Lipids

**Purpose**: Apply two-tier classification system for differential lipids.

**Approach**:
- Tier 1: Significant (FDR < 0.05)
- Tier 2: High-confidence (significant + effect size threshold)

Effect size thresholds:
- Leaf predictors: |logFC| > 0.5
- Categorical predictors: |logFC| > 1.5
```{r classify_lipids}
#' Classify differential lipids with predictor-specific thresholds
classify_differential_lipids <- function(effects_df) {
  leaf_predictors <- c("Leaf", "Leaf:-P")
  
  effects_df %>%
    mutate(
      is_DL = adj.P.Val < 0.05,
      is_hiconf_DL = case_when(
        predictor %in% leaf_predictors & is_DL & abs(logFC) > 0.5 ~ TRUE,
        predictor == "-P" & is_DL & abs(logFC) > 1.5 ~ TRUE,
        .default = FALSE
      ),
      regulation = case_when(
        !is_hiconf_DL ~ "Not significant",
        logFC > 0 ~ "Upregulated",
        logFC < 0 ~ "Downregulated",
        TRUE ~ "Not significant"
      ),
      neglogP = -log10(adj.P.Val),
      label = if_else(is_DL, response, "")
    )
}

effect_order <- c("Leaf", "-P", "Leaf:-P")

effects_df <- effects_df %>%
  mutate(predictor = factor(predictor, levels = effect_order)) %>%
  classify_differential_lipids()

effects_df$label <- sub("_", "", effects_df$label, perl = TRUE)
effects_df$label <- sub("_", ":", effects_df$label, perl = TRUE)
```

## Summary Statistics
```{r summary_stats}
cat("=== Classification Summary ===\n")
cat("Total tests:", nrow(effects_df), "\n\n")

cat("Tier 1 - Significant DLs (FDR < 0.05):\n")
print(table(effects_df$predictor, effects_df$is_DL))

cat("\nTier 2 - High-confidence DLs:\n")
print(table(effects_df$predictor, effects_df$is_hiconf_DL))

cat("\nDirection of significant effects:\n")
print(with(effects_df %>% filter(is_DL), 
           table(predictor, regulation)))
```

# Export Results
```{r export_results, eval=FALSE}
write.csv(
  effects_df,
  file = "~/Desktop/lipid_differential_abundance_TIC_normalized.csv",
  row.names = FALSE
)

write.csv(
  molar_ion_fractions,
  file = "~/Desktop/lipid_molar_ion_fractions.csv",
  row.names = TRUE
)

write.csv(
  voomR$E,
  file = "~/Desktop/voom_log2_TIC_normalized_lipids.csv",
  row.names = TRUE
)

cat("=== Analysis Complete ===\n")
cat("Results exported to Desktop\n")
```

# Volcano Plots

## Custom Legend Function

**Purpose**: Create custom legend key displaying line segments instead of points.
```{r custom_legend_key}
#' Custom key glyph for legend
#'
#' @param data Aesthetic data for the legend key
#' @param params Additional parameters
#' @param size Size of the key
#'
#' @return A grid grob object
draw_key_custom <- function(data, params, size) {
  colour <- data$colour
  data <- data[data$colour == colour, ]
  grid::segmentsGrob(
    0, 1 / 2, 1, 1 / 2,
    gp = grid::gpar(
      col = data$colour,
      lwd = data$linewidth * 4
    )
  )
}
```

## Prepare Plot Data

**Purpose**: Join differential abundance results with lipid class annotations.
```{r prepare_volcano_data}
plot_data <- effects_df %>%
  droplevels() %>%
  inner_join(sp, by = c(response = "colname"))

label_data <- plot_data %>%
  filter(is_hiconf_DL)

force <- 1
label_size <- 6
base_size <- 30
```

## Three-Panel Volcano Plot

**Purpose**: Visualize differential abundance across all three predictors with 
faceted layout.

**Approach**: Create volcano plots for Leaf, -P, and Leaf:-P predictors with 
staged label placement to avoid overlaps. Downregulated lipids labeled on left, 
upregulated on right.

**Expected outcome**: Publication-quality three-panel figure showing effect 
sizes and significance levels with lipid class color coding.
```{r volcano_3panel, fig.width=12, fig.height=6}
force <- 3

predictor_labels <- c( "Leaf", "-P", "Leaf × P") 
names(predictor_labels) <- levels(plot_data$predictor)
 

lipid_volcano_3 <- plot_data %>%
  ggplot(aes(
    x = logFC,
    y = -log10(adj.P.Val),
    color = head_group,
    fill = regulation,
    label = label
  )) +
  ylab(expression(-log[10](italic(FDR)))) +
  xlab(expression(log[2]("Fold Change"))) +
  geom_point(alpha = 0.7, shape = 21, color = "white") +
  scale_fill_manual(
    name = "",
    values = c("#00AFBB", "grey", "#bb0c00"),
    labels = c("Downregulated", "Not significant", "Upregulated")
  ) +
  geom_text_repel(
    data = label_data %>% 
      filter(predictor == "Leaf", regulation == "Downregulated", 
             !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size = label_size,
    segment.color = "grey",
    min.segment.length = 0,
    xlim = c(NA, -0.5),
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  geom_text_repel(
    data = label_data %>% 
      filter(predictor == "Leaf", regulation == "Upregulated", 
             !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size = label_size,
    segment.color = "grey",
    min.segment.length = 0,
    xlim = c(0.5, NA),
    #max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  geom_text_repel(
    data = label_data %>% 
      filter(predictor == "-P", regulation == "Downregulated", 
             !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size = label_size,
    direction = "y",
    segment.color = "grey",
    xlim = c(NA, -5),
    #max.overlaps = 0,
    key_glyph = draw_key_custom
  ) +
  geom_text_repel(
    data = label_data %>% 
      filter(predictor == "-P", regulation == "Upregulated", 
             !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size = label_size,
    direction = "y",
    segment.color = "grey",
    xlim = c(3, NA),
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  geom_text_repel(
    data = label_data %>% 
      filter(predictor == "Leaf:-P", !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size = label_size,
    segment.color = "grey",
    min.segment.length = 0,
    max.overlaps = 2,
    key_glyph = draw_key_custom
  ) +
  scale_color_manual(
    name = "",
    values = c("darkblue", "orange2", "darkred"),
    labels = c("Glycoglycerolipid", "Neutral lipid", "Glycerophospholipid")
  ) +
  facet_wrap(. ~ predictor,
             labeller = labeller(predictor = predictor_labels), 
             scales = "free_x", ncol = 3) +
  guides(
    color = guide_legend(override.aes = list(linewidth = 1.5)),
    fill = "none"
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.2))) +
  scale_x_continuous(expand = expansion(mult = c(0.5, 0.3))) +
  theme_classic2(base_size = base_size) +
  theme(
    plot.title = element_blank(),
    strip.text = element_markdown(size = 35),
    strip.background = element_blank(),
    legend.position = c(0.85, 0.95),
    legend.background = element_rect(fill = "transparent"),
    axis.title.x = element_blank(),
    legend.spacing = unit(0, "line"),
    legend.box.spacing = unit(0, "line"),
    legend.text = element_text(size = 20),
    axis.title.y = element_text(margin = margin(r = 5,"pt")),
    # plot.margin = margin(5.5, 5.5, 0, 5.5, "pt"),
  )
ggsave(
  filename = "~/Desktop/lipid_volcano_3_TIC.png",
  plot = lipid_volcano_3,
  height = 6,
  width = 12,
  units = "in",
  dpi = 150
)

saveRDS(lipid_volcano_3, "../results/lipid_volcano_3_TIC.rds")

print(lipid_volcano_3)


```

## Two-Panel Volcano Plot

**Purpose**: Focused visualization of Leaf and -P effects without interaction 
term.

**Approach**: Subset to primary biological predictors and create two-panel 
layout with optimized label placement.
```{r volcano_2panel, fig.width=10, fig.height=6}
plot_data_2 <- effects_df %>%
  filter(predictor != "Leaf:-P") %>%
  droplevels() %>%
  inner_join(sp, by = c(response = "colname"))

volcano_2 <- plot_data_2 %>%
  ggplot(aes(
    x = logFC,
    y = -log10(adj.P.Val),
    color = head_group,
    fill = regulation,
    label = label
  )) +
  ylab(expression(-log[10](italic(FDR)))) +
  xlab(expression(log[2]("Fold Change"))) +
  geom_point(alpha = 0.7, shape = 21, color = "white") +
  scale_fill_manual(
    name = "",
    values = c("#00AFBB", "grey", "#bb0c00"),
    labels = c("Downregulated", "Bellow threshold", "Upregulated")
  ) +
  geom_text_repel(
    data = label_data %>% 
      filter(predictor == "Leaf", regulation == "Downregulated", 
             !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size = label_size,
    segment.color = "grey",
    min.segment.length = 0,
    xlim = c(NA, -0.5),
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  geom_text_repel(
    data = label_data %>% 
      filter(predictor == "Leaf", regulation == "Upregulated", 
             !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size = label_size,
    segment.color = "grey",
    min.segment.length = 0,
    xlim = c(0.5, NA),
    #max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  geom_text_repel(
    data = label_data %>% 
      filter(predictor == "-P", regulation == "Downregulated", 
             !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size = label_size,
    direction = "y",
    segment.color = "grey",
    xlim = c(NA, -5),
    #max.overlaps = 0,
    key_glyph = draw_key_custom
  ) +
  geom_text_repel(
    data = label_data %>% 
      filter(predictor == "-P", regulation == "Upregulated", 
             !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size = label_size,
    direction = "y",
    segment.color = "grey",
    xlim = c(3, NA),
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  scale_color_manual(
    name = "",
    values = c("darkblue", "orange2", "darkred"),
    labels = c("Glycoglycerolipid", "Neutral lipid", "Glycerophospholipid")
  ) +
  facet_wrap(. ~ predictor, scales = "free_x", ncol = 3) +
  guides(
    color = guide_legend(override.aes = list(linewidth = 1.5), 
                         reverse = TRUE),
    fill = "none"
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.3))) +
  scale_x_continuous(expand = expansion(mult = c(0.3, 0.02))) +
  theme_classic2(base_size = base_size) +
  theme(
    plot.title = element_blank(),
    strip.text = element_markdown(size = 35),
    strip.background = element_blank(),
    axis.title = element_text(size = 25),
    legend.position = c(0.19, 0.99),
    legend.background = element_rect(fill = "transparent"),
    legend.spacing = unit(0, "line"),
    legend.box.spacing = unit(0, "line"),
    legend.text = element_text(size = 20),
  )

print(volcano_2)
saveRDS(volcano_2, "../results/lipid_volcano_2_TIC.rds")
ggsave(
  filename = "~/Desktop/lipid_volcano_2_TIC.png",
  plot = volcano_2,
  height = 6,
  width = 10,
  units = "in",
  dpi = 150
)
```

## One-Panel Volcano Plot: Interaction Term

**Purpose**: Highlight lipids showing differential response to phosphorus 
treatment across leaf developmental stages.

**Approach**: Isolate Leaf:-P interaction term and create single volcano plot 
without x-axis label restrictions.
```{r volcano_1panel, fig.width=6, fig.height=6}
plot_data_leafP <- effects_df %>%
  filter(predictor == "Leaf:-P") %>%
  droplevels() %>%
  inner_join(sp, by = c(response = "colname"))

volcano_leafP <- plot_data_leafP %>%
  ggplot(aes(
    x = logFC,
    y = -log10(adj.P.Val),
    color = head_group,
    fill = regulation,
    label = label
  )) +
  ylab(expression(-log[10](italic(FDR)))) +
  xlab(expression(log[2]("Fold Change"))) +
  ylim(0, 5) +
  geom_point(alpha = 0.7, shape = 21, color = "white") +
  scale_fill_manual(
    name = "",
    values = c("#00AFBB", "grey", "#bb0c00"),
    labels = c("Downregulated", "Bellow threshold", "Upregulated")
  ) +
  geom_text_repel(
    data = plot_data_leafP %>% 
      filter(regulation == "Downregulated", !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size = 7,
    segment.color = "grey",
    min.segment.length = 0,
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  geom_text_repel(
    data = plot_data_leafP %>% 
      filter(regulation == "Upregulated", !is.na(label), label != ""),
    force = force,
    fontface = "bold",
    size = 7,
    segment.color = "grey",
    min.segment.length = 0,
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  scale_color_manual(
    name = "",
    values = c("orange2", "darkred", "darkblue"),
    labels = c("Glycolipid", "Neutral lipid", "Phospholipid")
  ) +
  guides(
    color = guide_legend(override.aes = list(linewidth = 1.5), 
                         reverse = TRUE),
    fill = "none"
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.3))) +
  theme_classic2(base_size = base_size) +
  theme(
    plot.title = element_blank(),
    strip.text = element_markdown(size = 35),
    legend.position = "none",
    legend.background = element_rect(fill = "transparent"),
    axis.title = element_text(size = 25),
    legend.spacing = unit(0, "line"),
    legend.box.spacing = unit(0, "line"),
    legend.text = element_text(size = 20),
    axis.title.y = element_text(margin = margin(r = -5)),
    strip.background = element_blank()
  )

print(volcano_leafP)

ggsave(
  filename = "~/Desktop/lipid_volcano_leafP_TIC.png",
  plot = volcano_leafP,
  height = 7,
  width = 7,
  units = "in",
  dpi = 150
)
```

## Export High-Confidence Lipids
```{r export_hiconf_lipids}
write.csv(
  label_data,
  file = "~/Desktop/high_confidence_DLs_TIC.csv",
  row.names = FALSE
)

cat("Volcano plots saved:\n")
cat("  - lipid_volcano_3_TIC.png (3-panel, 12×6 in, 300 dpi)\n")
cat("  - lipid_volcano_2_TIC.png (2-panel, 5×3 in, 150 dpi)\n")
cat("  - lipid_volcano_leafP_TIC.png (1-panel, 7×7 in, 150 dpi)\n")
cat("  - high_confidence_DLs_TIC.csv\n")
```

# Interaction Plots: Leaf × Phosphorus

## Identify Leaf:-P Interaction Lipids

**Purpose**: Extract high-confidence lipids showing significant interaction 
between leaf developmental stage and phosphorus treatment.
```{r identify_interaction_lipids}
interaction_lipids <- effects_df %>%
  filter(predictor == "Leaf:-P", is_hiconf_DL) %>%
  arrange(adj.P.Val)

cat("High-confidence Leaf:-P interaction lipids:", 
    nrow(interaction_lipids), "\n")
print(interaction_lipids %>% 
        select(response, logFC, adj.P.Val, regulation))

interaction_lipid_ids <- interaction_lipids$response
```

## Data Transformation for Visualization

**Purpose**: Convert analysis-ready data back to biologically interpretable 
units for visualization.

**Approach**: The statistical analysis uses voom-normalized log2(CPM) values. 
For visualization, we convert these back to total ion current (TIC) fractions, 
which represent each lipid's proportion of the total detected lipid pool.

**Three possible input formats**:
1. **Raw counts**: Peak areas directly from MS-DIAL
2. **TIC fractions**: Proportions summing to 1.0 per sample (molar ion fractions)
3. **log2(CPM)**: Voom-normalized values used in statistical models
```{r data_format_overview}
cat("=== Available Data Formats ===\n")
cat("1. Raw counts (y$counts): Peak areas from MS detector\n")
cat("2. TIC fractions: Proportions of total signal per sample\n")
cat("3. log2(CPM) (voomR$E): Voom-normalized for statistics\n\n")

cat("Statistical analysis used:", class(voomR$E), "\n")
cat("For visualization, we convert to TIC fractions\n")
```

## Conversion Functions

**Purpose**: Provide explicit functions to convert between data formats.
```{r conversion_functions}
#' Convert raw counts to TIC fractions
#'
#' @param count_matrix Matrix with raw peak areas (lipids × samples)
#'
#' @return Matrix of TIC fractions (0-1 scale)
counts_to_TIC_fraction <- function(count_matrix) {
  TIC_fractions <- sweep(count_matrix, 2, colSums(count_matrix), FUN = "/")
  
  sample_sums <- colSums(TIC_fractions)
  if (!all(abs(sample_sums - 1) < 1e-10)) {
    warning("TIC fractions don't sum to 1. Range: ", 
            paste(range(sample_sums), collapse = " - "))
  }
  
  TIC_fractions
}

#' Convert log2(CPM) to TIC fractions
#'
#' @param log2_cpm_matrix Matrix with log2(CPM) values from voom
#' @param pseudo_count Pseudo-count added before log transformation
#'
#' @return Matrix of TIC fractions (0-1 scale)
log2cpm_to_TIC_fraction <- function(log2_cpm_matrix, pseudo_count = 1e-9) {
  # Back-transform from log2(CPM)
  cpm <- 2^log2_cpm_matrix - pseudo_count
  
  # CPM to counts (proportional, scaling doesn't matter for fractions)
  # Since CPM = (counts/library_size) * 1e6
  # We can work directly with CPM as pseudo-counts
  counts_proxy <- cpm
  
  # Convert to TIC fractions
  TIC_fractions <- sweep(counts_proxy, 2, colSums(counts_proxy), FUN = "/")
  
  TIC_fractions
}

#' Convert TIC fractions to log10 for visualization
#'
#' @param TIC_fraction_matrix Matrix of TIC fractions (0-1 scale)
#' @param offset Small value to avoid log(0)
#'
#' @return Matrix of log10(TIC fraction)
TIC_fraction_to_log10 <- function(TIC_fraction_matrix, offset = 1e-9) {
  log10(TIC_fraction_matrix + offset)
}
```

## Apply Conversions

**Purpose**: Transform voom-normalized data to TIC fractions for interpretable 
visualization.

**Approach**: 
1. Start with voomR$E (log2 CPM from statistical analysis)
2. Back-transform to pseudo-counts
3. Convert to TIC fractions (proportions)
4. Apply log10 transformation for plotting
```{r apply_conversions}
cat("=== Data Transformation Pipeline ===\n")
cat("Input: voomR$E (log2 CPM)\n")

# Step 1: Convert log2(CPM) to TIC fractions
TIC_fraction <- log2cpm_to_TIC_fraction(
  log2_cpm_matrix = voomR$E,
  pseudo_count = 0
)

cat("Intermediate: TIC fractions\n")
cat("  Range:", range(TIC_fraction, na.rm = TRUE), "\n")
cat("  Sample sums:", 
    range(colSums(TIC_fraction, na.rm = TRUE)), "\n")

# Step 2: Log10 transform for visualization
log10_TIC <- TIC_fraction_to_log10(
  TIC_fraction_matrix = TIC_fraction,
  offset = 1e-9
)

cat("Output: log10(TIC fraction)\n")
cat("  Range:", range(log10_TIC, na.rm = TRUE), "\n")
```

## Plotting Function: Lipid Trajectories

**Purpose**: Visualize lipid abundance trajectories across leaf stages, 
separated by phosphorus treatment.

**Input format**: The function accepts any of:
- log10(TIC fraction) - recommended for visualization
- log2(CPM) - directly from voom
- TIC fraction - will apply log10 internally
```{r plot_lipid_function}
#' Plot lipid trajectories by treatment
#'
#' @param lipid_data Matrix or data frame with lipid abundances
#'   Can be: log10(TIC fraction), log2(CPM), or TIC fraction
#' @param lipid_ids Character vector of lipid IDs to plot
#' @param metadata Data frame with sample information (tube, leaf_tissue, 
#'   Treatment columns required)
#' @param data_type Character: "log10_TIC", "log2_CPM", or "TIC_fraction"
#'
#' @return ggplot object with treatment-colored trajectories
plot_lipid_by_treatment <- function(lipid_data,
                                     lipid_ids,
                                     metadata,
                                     data_type = "log10_TIC") {
  
  # Validate data type
  stopifnot(
    data_type %in% c("log10_TIC", "log2_CPM", "TIC_fraction")
  )
  
  # Extract and format data
  plot_data <- lipid_data %>%
    as.data.frame() %>%
    tibble::rownames_to_column("lipid") %>%
    filter(lipid %in% lipid_ids) %>%
    pivot_longer(
      cols = -lipid,
      names_to = "tube", 
      values_to = "abundance"
    ) %>%
    left_join(
      metadata %>% select(tube, leaf_tissue, Treatment),
      by = "tube"
    ) %>%
    filter(!is.na(Treatment)) %>%
    mutate(
      Treatment = factor(
        Treatment,
        levels = c("High_P", "Low_P"),
        labels = c("+P", "-P")
      )
    )
  
  # Format lipid labels: PC_34_2 -> PC 34:2
  plot_data$lipid_label <- sub("_", "", plot_data$lipid, perl = TRUE)
  plot_data$lipid_label <- sub("_", ":", plot_data$lipid_label, perl = TRUE)
  
  # Maintain input order
  lipid_levels <- sub("_", "", lipid_ids, perl = TRUE)
  lipid_levels <- sub("_", ":", lipid_levels, perl = TRUE)
  
  plot_data$lipid_label <- factor(
    plot_data$lipid_label,
    levels = lipid_levels
  )
  
  # Calculate summary statistics
  summary_data <- plot_data %>%
    group_by(lipid, lipid_label, leaf_tissue, Treatment) %>%
    summarise(
      mean = mean(abundance, na.rm = TRUE),
      se = sd(abundance, na.rm = TRUE) / sqrt(n()),
      .groups = "drop"
    )
  
  # Set y-axis label based on input data type
  y_label <- switch(
    data_type,
    "log10_TIC" = expression(log[10]("TIC fraction")),
    "log2_CPM" = expression(log[2]("CPM")),
    "TIC_fraction" = "TIC fraction"
  )
  
  # Plot parameters
  base_size <- 35
  pd <- position_dodge(width = 0.2)
  
  # Create plot
  summary_data %>%
    ggplot(aes(
      x = leaf_tissue,
      y = mean,
      color = Treatment,
      fill = Treatment,
      linetype = Treatment,
      shape = Treatment,
      group = Treatment
    )) +
    geom_line(linewidth = 1.5) +
    geom_point(position = pd, size = 5) +
    geom_errorbar(
      aes(ymin = mean - se, ymax = mean + se),
      position = pd,
      width = 0.2,
      linewidth = 1,
      linetype = "solid"
    ) +
    scale_color_manual(
      values = c("+P" = "gold", "-P" = "purple4")
    ) +
    scale_fill_manual(
      values = c("+P" = "gold", "-P" = "purple4")
    ) +
    scale_linetype_manual(
      values = c("+P" = "solid", "-P" = "dashed")
    ) +
    scale_shape_manual(
      values = c("+P" = 19, "-P" = 25)
    ) +
    facet_wrap(~ lipid_label, scales = "free_y", ncol = 2) +
    labs(
      x = "Leaf",
      y = y_label
    ) +
    scale_y_continuous(
      expand = expansion(add = c(0.1, 0.1))
    ) +
    guides(
      fill = "none",
      linetype = "none",
      shape = guide_legend(
        override.aes = list(
          fill = c("gold","purple4"),
          color= c("gold","purple4"),
          linetype = "solid",
          size = 5)
      ),
    ) +
    theme_classic(base_size = base_size) +
    theme(
      strip.background = element_blank(),
      strip.text = element_text(face = "bold", size = 25),
      # legend.position = c(0.1, 0.95),
      legend.title = element_blank(),
      legend.background = element_rect(fill = "transparent")
    )
}
```

## Plot Leaf:-P Interaction Lipids

**Purpose**: Visualize high-confidence lipids showing significant interaction 
between leaf stage and phosphorus treatment.

**Approach**: Plot log10(TIC fraction) to show proportions on interpretable 
scale. Divergent trajectories between treatments indicate interaction.

**Expected outcome**: Treatment-specific responses across leaf developmental 
gradient, revealing context-dependent regulation.
```{r plot_interaction_lipids, fig.width=10, fig.height=10}
#' Create horizontal 6-panel lipid trajectory plot with lipid class colors
#'
#' @param lipid_data Matrix with lipid abundances (log10 TIC fraction)
#' @param effects_df Data frame with differential abundance results
#' @param metadata Sample metadata with tube, leaf_tissue, Treatment
#' @param sp Data frame with lipid class annotations
#' @param data_type Character indicating input data format
#'
#' @return ggplot object with 6-panel horizontal layout
create_trajectory_6panel <- function(lipid_data,
                                      effects_df,
                                      metadata,
                                      sp,
                                      data_type = "log10_TIC",
                                     nrow=1,
                                     ncol=6) {
  
  # Select top lipid per predictor×regulation combination
  selected_lipids <- effects_df %>%
    filter(is_hiconf_DL) %>%
    group_by(predictor, regulation) %>%
    slice_min(adj.P.Val, n = 1, with_ties = FALSE) %>%
    ungroup() %>%
    mutate(
      panel_label = case_when(
        predictor == "Leaf" & regulation == "Downregulated" ~ "Leaf Down",
        predictor == "Leaf" & regulation == "Upregulated" ~ "Leaf Up",
        predictor == "-P" & regulation == "Downregulated" ~ "-P Down",
        predictor == "-P" & regulation == "Upregulated" ~ "-P Up",
        predictor == "Leaf:-P" & regulation == "Downregulated" ~ 
          "Negative\nLeaf × -P",
        predictor == "Leaf:-P" & regulation == "Upregulated" ~ 
          "Positive\nLeaf × -P"
      )
    ) %>%
    arrange(predictor, desc(regulation)) %>%
    select(response, predictor, regulation, panel_label, logFC, adj.P.Val)
  
  # Join with lipid class annotations
  selected_lipids <- selected_lipids %>%
    left_join(sp, by = c("response" = "colname"))
  
  # Format lipid labels for titles
  selected_lipids$lipid_label <- sub("_", "", selected_lipids$response, 
                                       perl = TRUE)
  selected_lipids$lipid_label <- sub("_", ":", selected_lipids$lipid_label, 
                                       perl = TRUE)
  
  # Combine panel label with lipid name
  selected_lipids$full_label <- paste0(selected_lipids$panel_label, "\n", 
                                        selected_lipids$lipid_label)
  
  # Extract abundances and join with metadata
  plot_data <- lipid_data %>%
    as.data.frame() %>%
    tibble::rownames_to_column("lipid") %>%
    filter(lipid %in% selected_lipids$response) %>%
    pivot_longer(
      cols = -lipid,
      names_to = "tube",
      values_to = "abundance"
    ) %>%
    left_join(
      metadata %>% select(tube, leaf_tissue, Treatment),
      by = "tube"
    ) %>%
    filter(!is.na(Treatment)) %>%
    mutate(
      Treatment = factor(
        Treatment,
        levels = c("High_P", "Low_P"),
        labels = c("+P", "-P")
      )
    ) %>%
    left_join(
      selected_lipids %>% select(response, full_label, head_group),
      by = c("lipid" = "response")
    )
  
  # Set panel order
  panel_order <- c(
    paste0("Leaf Down\n", unique(selected_lipids$lipid_label[
      selected_lipids$panel_label == "Leaf Down"])),
    paste0("Leaf Up\n", unique(selected_lipids$lipid_label[
      selected_lipids$panel_label == "Leaf Up"])),
    paste0("-P Down\n", unique(selected_lipids$lipid_label[
      selected_lipids$panel_label == "-P Down"])),
    paste0("-P Up\n", unique(selected_lipids$lipid_label[
      selected_lipids$panel_label == "-P Up"])),
    paste0("Negative\nLeaf × -P\n", unique(selected_lipids$lipid_label[
      selected_lipids$panel_label == "Negative\nLeaf × -P"])),
    paste0("Positive\nLeaf × -P\n", unique(selected_lipids$lipid_label[
      selected_lipids$panel_label == "Positive\nLeaf × -P"]))
  )
  
  plot_data$full_label <- factor(
    plot_data$full_label,
    levels = panel_order
  )
  
  # Calculate summary statistics
  summary_data <- plot_data %>%
    group_by(lipid, full_label, head_group, leaf_tissue, Treatment) %>%
    summarise(
      mean = mean(abundance, na.rm = TRUE),
      se = sd(abundance, na.rm = TRUE) / sqrt(n()),
      .groups = "drop"
    )
  
  # Y-axis label
  y_label <- switch(
    data_type,
    "log10_TIC" = expression(log[10]("fraction")),
    "log2_CPM" = expression(log[2]("CPM")),
    "TIC_fraction" = "TIC fraction"
  )
  
  # Plot
  base_size <- 30
  pd <- position_dodge(width = 0.2)
  
  summary_data %>%
    ggplot(aes(
      x = leaf_tissue,
      y = mean,
      color = head_group,
      fill = head_group,
      linetype = Treatment,
      shape = Treatment,
      group = Treatment
    )) +
    geom_line(linewidth = 1.2) +
    geom_point(position = pd, size = 4) +
    geom_errorbar(
      aes(ymin = mean - se, ymax = mean + se),
      position = pd,
      width = 0.2,
      linewidth = 0.8,
      linetype = "solid"
    ) +
    scale_color_manual(
      name = "",
      values = c("glycolipid" = "darkblue", "neutral" = "orange2", 
                 "phospholipid" = "darkred"),
      labels = c("Glycolipid", "Neutral lipid", "Phospholipid")
    ) +
    scale_fill_manual(
      name = "",
      values = c("glycolipid" = "darkblue", "neutral" = "orange2", 
                 "phospholipid" = "darkred"),
      labels = c("Glycolipid", "Neutral lipid", "Phospholipid")
    ) +
    scale_linetype_manual(
      values = c("+P" = "solid", "-P" = "dashed")
    ) +
    scale_shape_manual(
      values = c("+P" = 19, "-P" = 25)
    ) +
    facet_wrap(
      ~ full_label,
      scales = "free_y",
      nrow = nrow,
      ncol = ncol
    ) +
    labs(
      x = "Leaf",
      y = y_label
    ) +
    scale_y_continuous(
      expand = expansion(mult = c(0.1, 0.1))
    ) +
    guides(
      color = "none",
      fill = "none",
      linetype = guide_legend(
        title = element_blank(),
        override.aes = list(color = "black", linewidth = 1.5)
      ),
      shape = guide_legend(
        title = element_blank(),
        override.aes = list(fill = "black", color = "black", size = 5)
      )
    ) +
    theme_classic(base_size = base_size) +
    theme(
      strip.background = element_blank(),
      strip.text = element_text( size = 25),
      legend.position = "top",
      legend.title = element_blank(),
      legend.background = element_rect(fill = "transparent"),
      panel.spacing = unit(0.5, "lines")
    )
}


p_trajectory_6 <- create_trajectory_6panel(
  lipid_data = log10_TIC,
  effects_df = effects_df,
  metadata = sampleInfo,
  sp = sp,
  data_type = "log10_TIC"
)

ggsave(
  filename = "~/Desktop/lipid_trajectory_6panel.png",
  plot = p_trajectory_6,
  width = 18,
  height = 6,
  dpi = 300
)

saveRDS(p_trajectory_6, "../results/lipid_trajectory_6panel.rds")

# Print Selected Lipids
selected_for_plot <- effects_df %>%
  filter(is_hiconf_DL) %>%
  group_by(predictor, regulation) %>%
  slice_min(adj.P.Val, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  left_join(sp, by = c("response" = "colname")) %>%
  arrange(predictor, desc(regulation)) %>%
  select(predictor, regulation, response, class, head_group, logFC, adj.P.Val)

cat("\n=== Lipids Selected for 6-Panel Plot ===\n")
print(selected_for_plot)

create_trajectory_6panel(
  lipid_data = log10_TIC,
  effects_df = effects_df,
  metadata = sampleInfo,
  nrow=2,
  ncol=3,
  sp = sp,
  data_type = "log10_TIC"
)
```
# Session Info
```{r session_info}
sessionInfo()
```