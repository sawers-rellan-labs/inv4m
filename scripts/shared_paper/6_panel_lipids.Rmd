---
title: "horizontal 6-panel lipid trajectory plot"
author: "Fausto Rodríguez Zapata"
date: "2025-11-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, define_panel_function}
#' Create horizontal 6-panel lipid trajectory plot with lipid class colors
#'
#' @param lipid_data Matrix with lipid abundances (log10 TIC fraction)
#' @param effects_df Data frame with differential abundance results
#' @param metadata Sample metadata with tube, leaf_tissue, Treatment
#' @param sp Data frame with lipid class annotations
#' @param data_type Character indicating input data format
#'
#' @return ggplot object with 6-panel horizontal layout
create_trajectory_6panel <- function(lipid_data,
                                      effects_df,
                                      metadata,
                                      sp,
                                      data_type = "log10_TIC") {
  
  # Select top lipid per predictor×regulation combination
  selected_lipids <- effects_df %>%
    filter(is_hiconf_DL) %>%
    group_by(predictor, regulation) %>%
    slice_min(adj.P.Val, n = 1, with_ties = FALSE) %>%
    ungroup() %>%
    mutate(
      panel_label = case_when(
        predictor == "Leaf" & regulation == "Downregulated" ~ "Leaf Down",
        predictor == "Leaf" & regulation == "Upregulated" ~ "Leaf Up",
        predictor == "-P" & regulation == "Downregulated" ~ "-P Down",
        predictor == "-P" & regulation == "Upregulated" ~ "-P Up",
        predictor == "Leaf:-P" & regulation == "Downregulated" ~ 
          "Negative\nLeaf × -P",
        predictor == "Leaf:-P" & regulation == "Upregulated" ~ 
          "Positive\nLeaf × -P"
      )
    ) %>%
    arrange(predictor, desc(regulation)) %>%
    select(response, predictor, regulation, panel_label, logFC, adj.P.Val)
  
  # Join with lipid class annotations
  selected_lipids <- selected_lipids %>%
    left_join(sp, by = c("response" = "colname"))
  
  # Format lipid labels for titles
  selected_lipids$lipid_label <- sub("_", "", selected_lipids$response, 
                                       perl = TRUE)
  selected_lipids$lipid_label <- sub("_", ":", selected_lipids$lipid_label, 
                                       perl = TRUE)
  
  # Combine panel label with lipid name
  selected_lipids$full_label <- paste0(selected_lipids$panel_label, "\n", 
                                        selected_lipids$lipid_label)
  
  # Extract abundances and join with metadata
  plot_data <- lipid_data %>%
    as.data.frame() %>%
    tibble::rownames_to_column("lipid") %>%
    filter(lipid %in% selected_lipids$response) %>%
    pivot_longer(
      cols = -lipid,
      names_to = "tube",
      values_to = "abundance"
    ) %>%
    left_join(
      metadata %>% select(tube, leaf_tissue, Treatment),
      by = "tube"
    ) %>%
    filter(!is.na(Treatment)) %>%
    mutate(
      Treatment = factor(
        Treatment,
        levels = c("High_P", "Low_P"),
        labels = c("+P", "-P")
      )
    ) %>%
    left_join(
      selected_lipids %>% select(response, full_label, head_group),
      by = c("lipid" = "response")
    )
  
  # Set panel order
  panel_order <- c(
    paste0("Leaf Down\n", unique(selected_lipids$lipid_label[
      selected_lipids$panel_label == "Leaf Down"])),
    paste0("Leaf Up\n", unique(selected_lipids$lipid_label[
      selected_lipids$panel_label == "Leaf Up"])),
    paste0("-P Down\n", unique(selected_lipids$lipid_label[
      selected_lipids$panel_label == "-P Down"])),
    paste0("-P Up\n", unique(selected_lipids$lipid_label[
      selected_lipids$panel_label == "-P Up"])),
    paste0("Negative\nLeaf × -P\n", unique(selected_lipids$lipid_label[
      selected_lipids$panel_label == "Negative\nLeaf × -P"])),
    paste0("Positive\nLeaf × -P\n", unique(selected_lipids$lipid_label[
      selected_lipids$panel_label == "Positive\nLeaf × -P"]))
  )
  
  plot_data$full_label <- factor(
    plot_data$full_label,
    levels = panel_order
  )
  
  # Calculate summary statistics
  summary_data <- plot_data %>%
    group_by(lipid, full_label, head_group, leaf_tissue, Treatment) %>%
    summarise(
      mean = mean(abundance, na.rm = TRUE),
      se = sd(abundance, na.rm = TRUE) / sqrt(n()),
      .groups = "drop"
    )
  
  # Y-axis label
  y_label <- switch(
    data_type,
    "log10_TIC" = expression(log[10]("fraction")),
    "log2_CPM" = expression(log[2]("CPM")),
    "TIC_fraction" = "TIC fraction"
  )
  
  # Plot
  base_size <- 30
  pd <- position_dodge(width = 0.2)
  
  summary_data %>%
    ggplot(aes(
      x = leaf_tissue,
      y = mean,
      color = head_group,
      fill = head_group,
      linetype = Treatment,
      shape = Treatment,
      group = Treatment
    )) +
    geom_line(linewidth = 1.2) +
    geom_point(position = pd, size = 4) +
    geom_errorbar(
      aes(ymin = mean - se, ymax = mean + se),
      position = pd,
      width = 0.2,
      linewidth = 0.8,
      linetype = "solid"
    ) +
    scale_color_manual(
      name = "",
      values = c("glycolipid" = "darkblue", "neutral" = "orange2", 
                 "phospholipid" = "darkred"),
      labels = c("Glycolipid", "Neutral lipid", "Phospholipid")
    ) +
    scale_fill_manual(
      name = "",
      values = c("glycolipid" = "darkblue", "neutral" = "orange2", 
                 "phospholipid" = "darkred"),
      labels = c("Glycolipid", "Neutral lipid", "Phospholipid")
    ) +
    scale_linetype_manual(
      values = c("+P" = "solid", "-P" = "dashed")
    ) +
    scale_shape_manual(
      values = c("+P" = 19, "-P" = 25)
    ) +
    facet_wrap(
      ~ full_label,
      scales = "free_y",
      nrow = 1,
      ncol = 6
    ) +
    labs(
      x = "Leaf",
      y = y_label
    ) +
    scale_y_continuous(
      expand = expansion(mult = c(0.1, 0.1))
    ) +
    guides(
      color = "none",
      fill = "none",
      linetype = guide_legend(
        title = element_blank(),
        override.aes = list(color = "black", linewidth = 1.5)
      ),
      shape = guide_legend(
        title = element_blank(),
        override.aes = list(fill = "black", color = "black", size = 5)
      )
    ) +
    theme_classic(base_size = base_size) +
    theme(
      strip.background = element_blank(),
      strip.text = element_text( size = 25),
      legend.position = "top",
      legend.title = element_blank(),
      legend.background = element_rect(fill = "transparent"),
      panel.spacing = unit(0.5, "lines")
    )
}


p_trajectory_6 <- create_trajectory_6panel(
  lipid_data = log10_TIC,
  effects_df = effects_df,
  metadata = sampleInfo,
  sp = sp,
  data_type = "log10_TIC"
)

ggsave(
  filename = "~/Desktop/lipid_trajectory_6panel.png",
  plot = p_trajectory_6,
  width = 18,
  height = 6,
  dpi = 300
)

saveRDS(p_trajectory_6, "../results/lipid_trajectory_6panel.rds")

# Print Selected Lipids
selected_for_plot <- effects_df %>%
  filter(is_hiconf_DL) %>%
  group_by(predictor, regulation) %>%
  slice_min(adj.P.Val, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  left_join(sp, by = c("response" = "colname")) %>%
  arrange(predictor, desc(regulation)) %>%
  select(predictor, regulation, response, class, head_group, logFC, adj.P.Val)

cat("\n=== Lipids Selected for 6-Panel Plot ===\n")
print(selected_for_plot)

```
