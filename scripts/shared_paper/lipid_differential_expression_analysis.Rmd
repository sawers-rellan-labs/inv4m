---
title: "Lipid Differential Expression Analysis"
author: "Maize Genetics Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 12,
  fig.height = 8
)
```

# Overview

This analysis performs differential expression analysis on lipid profiles from 
maize leaf samples across multiple experimental factors:

- **Leaf tissue position**: Continuous gradient from apical to basal (leaf 1-4)
- **Phosphorus treatment**: High P (+P) vs Low P (-P)
- **Genotype**: Control (CTRL) vs Inversion 4m (INV4M)

The analysis uses limma-voom to identify lipids that respond to:

1. **leaf**: Leaf tissue position effect
2. **-P**: Phosphorus deficiency effect
3. **Inv4m**: Genotype effect
4. **-P:Inv4m**: Interaction between P treatment and genotype

Fold change thresholds:

- Leaf effect: ±0.7 log2FC
- Other effects: ±2 log2FC

# Libraries

```{r libraries}
library(edgeR)
library(ggplot2)
library(limma)
library(dplyr)
library(tidyr)
library(ggrepel)
library(ggpubr)
library(ggtext)
```

# Data Loading and Preprocessing

## Define Internal Standards to Exclude

```{r define_exclusions}
# Internal standards and odd-chain lipids to exclude
to_exclude <- c(
  "DG_12_0", "LPC_17_0", "LPE_17_1",
  "PC_25_0", "PG_17_0", "SM_35_1",
  "Sphingosine_17_1", "TG_17_0",
  "TG_57_6"  # exclude the odd number lipid
)
```

## Load Raw Lipid Data

```{r load_lipid_data}
# Load MS-Dial raw data with new internal standard integration
lipid_csv <- "../data/PSU_RawData_MSDial_NewStdInt_240422.csv"
lipid_csv <-  "/Users/fvrodriguez/Library/CloudStorage/GoogleDrive-frodrig4@ncsu.edu/My Drive/repos/inv4mRNA/data/PSU_RawData_MSDial_NewStdInt_240422.csv"
raw <- read.csv(lipid_csv, na.strings = c("", "#N/A", "NA", "Inf"))

# Remove internal standards and quality control samples
to_exclude <- to_exclude[to_exclude %in% colnames(raw)]

raw <- raw %>%
  select(-all_of(to_exclude)) %>%
  filter(!grepl("Methanol", sampleID)) %>%
  filter(!grepl("Pool", sampleID))

cat("Loaded", nrow(raw), "samples\n")
```

## Load Sample Metadata

```{r load_metadata}
# Load plant phenotypic data
plant_csv <- "/Users/fvrodriguez/Desktop/Desktop/22_NCS_PSU_LANGEBIO_FIELDS_PSU_P_field.csv"

psu <- read.csv(plant_csv) %>%
  rename(Genotype = "Who.What", rowid = "P22.") %>%
  filter(Genotype %in% c("CTRL", "INV4M")) %>%
  droplevels()

# Load RNA-seq metadata
sampleInfo <- read.csv('../data/inv4mRNAseq_metadata.csv') %>%
  rename(Genotype = genotype) %>%
  rename(rowid = row)

# Merge metadata
sampleInfo <- psu %>%
  select(rowid, Rep, Plot_Row, Plot_Column, DTA, DTS) %>%
  inner_join(sampleInfo) %>%
  filter(!is.na(DTA))

# Create leaf position groups
sampleInfo$leaf_group <- NA
sampleInfo$leaf_group[sampleInfo$leaf_tissue < 3] <- "apical"
sampleInfo$leaf_group[sampleInfo$leaf_tissue > 2] <- "basal"

# Standardize sample IDs
sampleInfo$tube <- gsub("L|R", "S", sampleInfo$tube, perl = TRUE)
sampleInfo$rowid <- sampleInfo$row

cat("Sample info loaded for", nrow(sampleInfo), "samples\n")
```

## Merge Lipid Data with Metadata

```{r merge_data}
# Extract tube ID from raw data
raw$tube <- gsub(".*_|.raw", "", raw$sampleID, perl = TRUE)
raw$tube <- gsub("L|R", "S", raw$tube, perl = TRUE)

# Merge phenotypic data with lipid measurements
pheno <- sampleInfo %>%
  select(rowid, tube, Rep, Plot:Plot_Row, Treatment:leaf_tissue, leaf_group) %>%
  inner_join(
    raw %>%
      select(tube, DGDG_34_0:TG_58_5)
  ) %>%
  mutate(block = as.factor(Rep)) %>%
  droplevels() %>%
  pivot_wider(
    names_from = Rep,
    values_from = Rep,
    names_prefix = "block_",
    values_fn = function(x) 1,
    values_fill = 0
  ) %>%
  select(rowid, tube:Plot_Row, block, block_6:block_12, everything()) %>%
  mutate(Treatment = factor(Treatment, levels = c("High_P", "Low_P")))

# Simplify treatment labels
levels(pheno$Treatment) <- c("+P", "-P")

# Remove problematic sample
pheno <- pheno[-29, ]  # what's wrong with this sample?

cat("Final dataset:", nrow(pheno), "samples\n")
```

## Define Lipid Classifications

```{r lipid_classes}
# Extract lipid measurements matrix
m <- pheno %>%
  select(DGDG_34_0:TG_58_5) %>%
  as.matrix()

# Define lipid head groups
head_group <- c(
  DG = "neutral",
  DGDG = "glycolipid",
  DGGA = "glycolipid",
  LPC = "phospholipid",
  LPE = "phospholipid",
  MGDG = "glycolipid",
  PC = "phospholipid",
  PE = "phospholipid",
  PG = "phospholipid",
  PI = "phospholipid",
  SQDG = "glycolipid",
  TG = "neutral"
)

# Create lipid species annotation
sp <- data.frame(
  colname = colnames(m),
  class = gsub("_.*", "", colnames(m), perl = TRUE)
)

sp$head_group <- head_group[sp$class]

# Summary of lipid classes
cat("\nLipid class distribution:\n")
print(with(sp, table(head_group, class)))
```

# Quality Control

## Create DGEList Object

```{r create_dgelist}
# Prepare count matrix
counts <- pheno[, colnames(m)] %>%
  as.matrix() %>%
  t()

colnames(counts) <- pheno$tube

# Visualize data distribution
hist(counts, main = "Distribution of Lipid Abundances", xlab = "Abundance")

# Create DGEList
genes <- data.frame(gene = rownames(counts))
sampleNames <- pheno$tube

sampleInfo <- sampleInfo[match(sampleNames, sampleInfo$tube), ]

y <- DGEList(counts = counts, samples = sampleInfo)
y$group <- interaction(y$samples$Treatment, y$samples$Genotype)

# Identify low count samples
y$samples$lowCount <- y$samples$lib.size < 1

cat("\nLibrary size summary:\n")
print(summary(y$samples$lib.size))
```

## Multidimensional Scaling

```{r mds_plots, fig.width=10, fig.height=8}
# MDS plot
mds <- plotMDS(y, pch = 21, plot = FALSE)

# Store MDS coordinates
d <- y$samples
d$x <- mds$x
d$y <- mds$y
d$Treatment <- factor(d$Treatment, levels = c("+P", "-P"))
d$Rep <- factor(d$Rep)

# MDS by treatment
p1 <- ggplot(d, aes(x = x, y = y)) +
  geom_point(aes(color = Treatment), size = 3) +
  ggtitle("MDS Plot: Treatment") +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  theme_classic()

# MDS by genotype
p2 <- ggplot(d, aes(x = x, y = y)) +
  geom_point(aes(color = Genotype), size = 3) +
  ggtitle("MDS Plot: Genotype") +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  theme_classic()

# MDS by leaf tissue
p3 <- ggplot(d, aes(x = x, y = y)) +
  geom_point(aes(color = factor(leaf_tissue), shape = Treatment), size = 3) +
  ggtitle("MDS Plot: Leaf Tissue and Treatment") +
  scale_color_discrete(name = "Leaf Tissue") +
  xlab("Leading logFC dim 1") +
  ylab("Leading logFC dim 2") +
  theme_classic()

ggarrange(p1, p2, p3, ncol = 2, nrow = 2)
```

# Differential Expression Analysis

## Design Matrix and Normalization

```{r design_normalization}
# Filter samples
y_filtered_bySample <- y

# Create design matrix
# Accounting for field position, block effects, and experimental factors
design <- model.matrix(
  ~ Plot_Row + Plot_Column + Rep + leaf_tissue + Treatment * Genotype,
  d
)

# Calculate normalization factors
y_filtered_bySample <- calcNormFactors(y_filtered_bySample)

cat("\nDesign matrix dimensions:", dim(design), "\n")
cat("Coefficients in model:\n")
print(colnames(design))
```

## Voom Transformation and Linear Modeling

```{r voom_fit, fig.width=10, fig.height=6}
# Apply voom transformation
voomR <- voom(y_filtered_bySample, design = design, plot = TRUE)

# Fit linear model
fit <- lmFit(voomR)
ebfit <- eBayes(fit)

cat("\nModel fitted successfully\n")
cat("Number of lipids:", nrow(ebfit$coefficients), "\n")
```

## Extract Results for Each Predictor

```{r extract_results}
# Extract results for coefficients 8-11
# Coef 8: leaf_tissue
# Coef 9: Treatment-P
# Coef 10: GenotypeINV4M
# Coef 11: Treatment-P:GenotypeINV4M

r <- list()

for (x in 8:11) {
  # Get top table for coefficient
  r[[as.character(x)]] <- topTable(
    ebfit,
    coef = x,
    sort.by = 'none',
    n = Inf
  )
  
  # Calculate confidence intervals
  cr <- qt(0.975, ebfit$df.residual + ebfit$df.prior) *
    ebfit$stdev.unscaled[, x] * sqrt(ebfit$s2.post)
  
  r[[as.character(x)]][["upper"]] <- r[[as.character(x)]][["logFC"]] + cr
  r[[as.character(x)]][["lower"]] <- r[[as.character(x)]][["logFC"]] - cr
}

# Assign predictor names and lipid IDs
r$`8`["predictor"] <- "leaf"
r$`8`["Response"] <- rownames(counts)
r$`9`["predictor"] <- "-P"
r$`9`["Response"] <- rownames(counts)
r$`10`["predictor"] <- "Inv4m"
r$`10`["Response"] <- rownames(counts)
r$`11`["predictor"] <- "-P:Inv4m"
r$`11`["Response"] <- rownames(counts)

# Combine all results
effects <- rbind(r$`8`, r$`9`, r$`10`, r$`11`)

cat("\nTotal number of tests:", nrow(effects), "\n")
```

## Process Effects and Define Significance

```{r process_effects}
# Define predictor order
effect_order <- c("leaf", "-P", "Inv4m", "-P:Inv4m")

# Apply predictor-specific fold change thresholds
effects <- effects %>%
  mutate(predictor = factor(predictor, levels = effect_order)) %>%
  mutate(neglogP = -log10(adj.P.Val)) %>%
  mutate(is_significant = adj.P.Val < 0.05) %>%
  mutate(upregulated = case_when(
    (predictor != "leaf") & (logFC >= 2) & is_significant ~ TRUE,
    (predictor == "leaf") & (logFC >= 0.7) & is_significant ~ TRUE,
    .default = FALSE
  )) %>%
  mutate(downregulated = case_when(
    (predictor != "leaf") & (logFC <= -2) & is_significant ~ TRUE,
    (predictor == "leaf") & (logFC <= -0.7) & is_significant ~ TRUE,
    .default = FALSE
  )) %>%
  mutate(
    regulation = case_when(
      is_significant & upregulated ~ "Upregulated",
      is_significant & downregulated ~ "Downregulated",
      .default = "Unregulated"
    ),
    is_DEG = is_significant & regulation != "Unregulated",
    label = ifelse(is_DEG, Response, "")
  )

# Format labels for plotting
effects$label <- sub("_", "", effects$label, perl = TRUE)
effects$label <- sub("_", ":", effects$label, perl = TRUE)

# Summary of differential lipids
cat("\nDifferentially expressed lipids per predictor:\n")
print(with(effects, table(predictor, regulation)))
```

# Volcano Plots

## Custom Legend Key Function

```{r custom_legend}
# Custom key glyph for legend
draw_key_custom <- function(data, params, size) {
  colour <- data$colour
  data <- data[data$colour == colour, ]
  grid::segmentsGrob(
    0, 1 / 2, 1, 1 / 2,
    gp = grid::gpar(
      col = data$colour,
      lwd = data$linewidth * 2
    )
  )
}
```

## Volcano Plot: All Three Predictors (Excluding Interaction)

```{r volcano_all, fig.width=12, fig.height=6}
volcano_all <- effects %>%
  filter(predictor != "-P:Inv4m") %>%
  droplevels() %>%
  inner_join(sp, by = c(Response = "colname")) %>%
  ggplot(aes(
    x = logFC,
    y = -log10(adj.P.Val),
    color = head_group,
    fill = regulation,
    label = label
  )) +
  ylab(expression(-log[10](italic(FDR)))) +
  xlab(expression(log[2]("Fold Change"))) +
  ylim(0, 10) +
  geom_point(alpha = 0.7, shape = 21, color = "grey25") +
  scale_fill_manual(
    name = "",
    values = c("#00AFBB", "grey", "#bb0c00"),
    labels = c("Downregulated", "Not significant", "Upregulated")
  ) +
  geom_text_repel(
    force = 3,
    min.segment.length = 0,
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  scale_color_manual(
    name = "",
    values = c("darkblue", "orange2", "darkred"),
    labels = c("Glycolipid", "Neutral lipid", "Phospholipid")
  ) +
  facet_wrap(. ~ predictor, scales = "free_x", ncol = 3) +
  guides(
    color = guide_legend(override.aes = list(linewidth = 1.5)),
    fill = "none"
  ) +
  theme_classic2(base_size = 25) +
  theme(
    plot.title = element_blank(),
    strip.text = element_markdown(),
    legend.position = c(0.5, 0.95),
    legend.spacing = unit(0, "line"),
    legend.box.spacing = unit(0, "line"),
    legend.text = element_text(size = 15),
    legend.direction = "horizontal",
    strip.background = element_blank()
  )

print(volcano_all)
```

## Volcano Plot: Leaf and -P Only (Excluding Inv4m)

This focused plot excludes Inv4m results to better visualize differential 
lipids in response to leaf tissue position and phosphorus deficiency.

```{r volcano_leaf_p, fig.width=10, fig.height=6}
volcano_leaf_p <- effects %>%
  filter(predictor %in% c("leaf", "-P")) %>%
  droplevels() %>%
  inner_join(sp, by = c(Response = "colname")) %>%
  ggplot(aes(
    x = logFC,
    y = -log10(adj.P.Val),
    color = head_group,
    fill = regulation,
    label = label
  )) +
  ylab(expression(-log[10](italic(FDR)))) +
  xlab(expression(log[2]("Fold Change"))) +
  ylim(0, 10) +
  geom_point(alpha = 0.7, shape = 21, color = "grey25") +
  scale_fill_manual(
    name = "",
    values = c("#00AFBB", "grey", "#bb0c00"),
    labels = c("Downregulated", "Not significant", "Upregulated")
  ) +
  geom_text_repel(
    force = 3,
    min.segment.length = 0,
    max.overlaps = 20,
    key_glyph = draw_key_custom
  ) +
  scale_color_manual(
    name = "",
    values = c("darkblue", "orange2", "darkred"),
    labels = c("Glycolipid", "Neutral lipid", "Phospholipid")
  ) +
  facet_wrap(. ~ predictor, scales = "free_x", ncol = 2) +
  guides(
    color = guide_legend(override.aes = list(linewidth = 1.5)),
    fill = "none"
  ) +
  theme_classic2(base_size = 25) +
  theme(
    plot.title = element_blank(),
    strip.text = element_markdown(),
    legend.position = c(0.5, 0.95),
    legend.spacing = unit(0, "line"),
    legend.box.spacing = unit(0, "line"),
    legend.text = element_text(size = 15),
    legend.direction = "horizontal",
    strip.background = element_blank()
  )

print(volcano_leaf_p)
```

# Effect Size Plots

## Prepare Data for Effect Plots

```{r prepare_effect_plots}
# Filter significant effects and prepare for plotting
to_plot <- effects %>%
  mutate(Response = gsub("_glyco", "", Response)) %>%
  mutate(predictor = factor(
    predictor,
    levels = c("leaf", "-P", "Inv4m", "-P:Inv4m")
  )) %>%
  filter(P.Value < 0.05) %>%
  inner_join(sp, by = c(Response = "colname")) %>%
  mutate(sign = sign(logFC)) %>%
  ungroup() %>%
  group_by(Response) %>%
  mutate(max_effect = max(abs(logFC))) %>%
  ungroup() %>%
  group_by(predictor, head_group, class) %>%
  mutate(head_group = fct_reorder(head_group, adj.P.Val)) %>%
  ungroup() %>%
  group_by(predictor) %>%
  arrange(predictor, head_group, class, adj.P.Val) %>%
  mutate(.r = row_number()) %>%
  ungroup()

cat("\nSignificant effects per predictor:\n")
print(with(to_plot, table(predictor, head_group)))
```

## Effect Size Plot: All Predictors

```{r effect_plot_all, fig.width=12, fig.height=10}
pd <- position_dodge(0.4)

effect_plot_all <- to_plot %>%
  droplevels() %>%
  mutate(Response = fct_reorder(Response, .r)) %>%
  ungroup() %>%
  ggplot(aes(
    x = logFC,
    y = Response,
    col = head_group
  )) +
  xlab("Effect (log2 Fold Change)") +
  geom_vline(xintercept = 0, lty = 2) +
  geom_point(position = pd, size = 3) +
  geom_errorbar(
    aes(xmin = upper, xmax = lower),
    position = pd,
    width = 0.2,
    size = 0.7
  ) +
  guides(
    shape = guide_legend(title = NULL),
    color = guide_legend(reverse = TRUE)
  ) +
  facet_wrap(. ~ predictor, scales = "free", ncol = 4) +
  scale_y_discrete(limits = rev) +
  scale_color_manual(values = c("blue", "red", "chartreuse")) +
  theme_light(base_size = 15) +
  theme(
    legend.position = "top",
    strip.background = element_rect(fill = "white"),
    strip.text = element_text(color = "black", size = 15),
    axis.title.y = element_blank(),
    axis.text.y = element_text(hjust = 0, face = "bold"),
    plot.caption = element_text(hjust = 0)
  )

print(effect_plot_all)
```

## Effect Size Plot: Leaf and -P Comparison

```{r effect_plot_leaf_p, fig.width=10, fig.height=8}
# Create separate plots for leaf and -P
response_leaf <- to_plot %>%
  filter(predictor == "leaf") %>%
  droplevels() %>%
  mutate(Response = fct_reorder(Response, .r)) %>%
  ungroup() %>%
  ggplot(aes(
    x = logFC,
    y = Response,
    col = head_group
  )) +
  xlab("Effect (log2 Fold Change)") +
  geom_vline(xintercept = 0, lty = 2) +
  geom_point(position = pd, size = 3) +
  geom_errorbar(
    aes(xmin = upper, xmax = lower),
    position = pd,
    width = 0.2,
    size = 0.7
  ) +
  guides(
    shape = guide_legend(title = NULL),
    color = guide_legend(reverse = TRUE)
  ) +
  facet_wrap(. ~ predictor, scales = "free") +
  scale_y_discrete(limits = rev) +
  scale_color_manual(values = c("blue", "red", "chartreuse")) +
  theme_light(base_size = 15) +
  theme(
    legend.position = "top",
    strip.background = element_rect(fill = "white"),
    strip.text = element_text(color = "black", size = 15),
    axis.title.y = element_blank(),
    axis.text.y = element_text(hjust = 0, face = "bold"),
    plot.caption = element_text(hjust = 0)
  )

response_p <- to_plot %>%
  filter(predictor == "-P") %>%
  droplevels() %>%
  mutate(Response = fct_reorder(Response, .r)) %>%
  ungroup() %>%
  ggplot(aes(
    x = logFC,
    y = Response,
    col = head_group
  )) +
  xlab("Effect (log2 Fold Change)") +
  geom_vline(xintercept = 0, lty = 2) +
  geom_point(position = pd, size = 3) +
  geom_errorbar(
    aes(xmin = upper, xmax = lower),
    position = pd,
    width = 0.2,
    size = 0.7
  ) +
  guides(
    shape = guide_legend(title = NULL),
    color = guide_legend(reverse = TRUE)
  ) +
  facet_wrap(. ~ predictor, scales = "free") +
  scale_y_discrete(limits = rev) +
  scale_color_manual(values = c("blue", "red", "chartreuse")) +
  theme_light(base_size = 15) +
  theme(
    legend.position = "top",
    strip.background = element_rect(fill = "white"),
    strip.text = element_text(color = "black", size = 15),
    axis.title.y = element_blank(),
    axis.text.y = element_text(hjust = 0, face = "bold"),
    plot.caption = element_text(hjust = 0)
  )

ggarrange(response_leaf, response_p, ncol = 2, common.legend = TRUE)
```

# Export Results

```{r export_results, eval=FALSE}
# Export differential expression results
write.csv(
  effects,
  file = "~/Desktop/lipid_differential_expression_results.csv",
  row.names = FALSE
)

# Save volcano plots
ggsave(
  volcano_all,
  file = "~/Desktop/lipid_volcano_all.svg",
  height = 6,
  width = 12
)

ggsave(
  volcano_leaf_p,
  file = "~/Desktop/lipid_volcano_leaf_P.svg",
  height = 6,
  width = 10
)

# Save effect plots
ggsave(
  effect_plot_all,
  file = "~/Desktop/lipid_effects_all.svg",
  height = 10,
  width = 12
)
```

# Summary Statistics

```{r summary_stats}
# Count differential lipids by class and regulation
summary_table <- effects %>%
  filter(is_DEG) %>%
  inner_join(sp, by = c(Response = "colname")) %>%
  group_by(predictor, head_group, regulation) %>%
  summarise(n_lipids = n(), .groups = "drop") %>%
  arrange(predictor, head_group, regulation)

print(summary_table)

# Significant lipids per predictor
sig_summary <- effects %>%
  group_by(predictor) %>%
  summarise(
    total_tested = n(),
    n_significant = sum(is_significant),
    n_upregulated = sum(upregulated),
    n_downregulated = sum(downregulated),
    pct_significant = round(100 * n_significant / total_tested, 1)
  )

print(sig_summary)
```

# Session Information

```{r session_info}
sessionInfo()
```
